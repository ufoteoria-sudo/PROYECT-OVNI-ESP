<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gesti√≥n de Biblioteca | UAP Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
        }

        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            background: white;
            height: 100vh;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
            position: fixed;
            left: 0;
            top: 60px;
            width: 250px;
            overflow-y: auto;
            z-index: 900;
        }

        .sidebar .nav-link {
            color: #333;
            padding: 12px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: #f0f0f0;
            border-left-color: #667eea;
            color: #667eea;
        }

        .main-content {
            margin-left: 250px;
            margin-top: 60px;
            padding: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .btn-gradient:hover {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .library-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .library-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .library-card-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            position: relative;
            overflow: hidden;
        }

        .library-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .library-card-body {
            padding: 15px;
        }

        .library-card-body h6 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .library-card-body p {
            font-size: 13px;
            color: #666;
            margin: 0 0 10px 0;
            line-height: 1.4;
        }

        .library-card-footer {
            padding: 10px 15px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            display: flex;
            gap: 5px;
        }

        .library-card-footer button {
            flex: 1;
            padding: 6px 10px;
            font-size: 12px;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stats-mini {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-box h3 {
            margin: 0;
            font-size: 28px;
            color: #667eea;
            font-weight: 700;
        }

        .stat-box p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-section h5 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .badge-custom {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .small-msg {
            font-size: 13px;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .scroll-horizontal {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                top: auto;
            }
            
            .main-content {
                margin-left: 0;
            }

            .library-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-admin fixed-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-book"></i> Admin - Biblioteca Visual
            </span>
            <div class="d-flex gap-2">
                <a href="biblioteca.html" class="btn btn-sm btn-outline-light" title="Ver biblioteca p√∫blica">
                    <i class="bi bi-eye"></i> Ver Biblioteca
                </a>
                <a href="dashboard.html" class="btn btn-sm btn-outline-light" title="Volver al dashboard">
                    <i class="bi bi-house"></i> Dashboard
                </a>
                <button class="btn btn-sm btn-outline-light" onclick="logout()" title="Cerrar sesi√≥n">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#tab-phenomena" data-tab="phenomena">
                        <i class="bi bi-cloud"></i> Fen√≥menos Atmosf√©ricos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#tab-objects" data-tab="objects">
                        <i class="bi bi-disc"></i> Objetos UFO
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#tab-create" data-tab="create">
                        <i class="bi bi-plus-circle"></i> Crear Nuevo
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#tab-stats" data-tab="stats">
                        <i class="bi bi-graph-up"></i> Estad√≠sticas
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Estad√≠sticas -->
            <div class="stats-mini" id="statsContainer">
                <div class="stat-box">
                    <h3 id="stat-phenomena">-</h3>
                    <p>Fen√≥menos</p>
                </div>
                <div class="stat-box">
                    <h3 id="stat-objects">-</h3>
                    <p>Objetos UFO</p>
                </div>
                <div class="stat-box">
                    <h3 id="stat-images">-</h3>
                    <p>Total Im√°genes</p>
                </div>
            </div>

            <!-- Tab: Fen√≥menos -->
            <div id="tab-phenomena" class="tab-content active">
                <div class="filter-section">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="search-phenomena" placeholder="üîç Buscar fen√≥menos..." />
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filter-category-phenomena">
                                <option value="">Todas las categor√≠as</option>
                                <option value="optical">√ìptico</option>
                                <option value="meteorological">Meteorol√≥gico</option>
                                <option value="astronomical">Astron√≥mico</option>
                                <option value="electrical">El√©ctrico</option>
                                <option value="cloud">Nuboso</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-gradient w-100" onclick="switchTab('create')">
                                <i class="bi bi-plus"></i> Nuevo Fen√≥meno
                            </button>
                        </div>
                    </div>
                </div>

                <div id="phenomena-list" class="library-grid">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Objetos UFO -->
            <div id="tab-objects" class="tab-content" style="display: none;">
                <div class="filter-section">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="search-objects" placeholder="üîç Buscar objetos..." />
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filter-category-objects">
                                <option value="">Todas las categor√≠as</option>
                                <option value="aircraft">‚úàÔ∏è Aeronave</option>
                                <option value="bird">ü¶Ö Ave</option>
                                <option value="drone">üöÅ Drone</option>
                                <option value="satellite">üõ∞Ô∏è Sat√©lite</option>
                                <option value="balloon">üéà Globo</option>
                                <option value="uap">üõ∏ UAP</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-gradient w-100" onclick="switchTab('create')">
                                <i class="bi bi-plus"></i> Nuevo Objeto
                            </button>
                        </div>
                    </div>
                </div>

                <div id="objects-list" class="library-grid">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Crear Nuevo -->
            <div id="tab-create" class="tab-content" style="display: none;">
                <div class="form-section">
                    <h5>Crear Nuevo Elemento de Biblioteca</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Tipo de Elemento *</label>
                        <select class="form-select" id="create-type" onchange="updateCreateForm()">
                            <option value="">Seleccionar tipo...</option>
                            <option value="phenomenon">Fen√≥meno Atmosf√©rico</option>
                            <option value="object">Objeto UFO</option>
                        </select>
                    </div>

                    <form id="createForm" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="create-name" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="create-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="create-category" class="form-label">Categor√≠a *</label>
                                <select class="form-select" id="create-category" required></select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="create-description" class="form-label">Descripci√≥n *</label>
                            <textarea class="form-control" id="create-description" rows="4" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="create-keywords" class="form-label">Palabras Clave (separadas por comas)</label>
                            <input type="text" class="form-control" id="create-keywords" placeholder="Ej: esfera, met√°lica, brillante">
                        </div>

                        <div class="mb-3">
                            <label for="create-images" class="form-label">Im√°genes (m√°x 5)</label>
                            <input type="file" class="form-control" id="create-images" accept="image/*" multiple>
                            <small class="text-muted">Puedes seleccionar hasta 5 im√°genes</small>
                        </div>

                        <div id="create-preview" class="mb-3"></div>

                        <div id="createMsg" class="small-msg" style="display: none;"></div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-gradient">
                                <i class="bi bi-save"></i> Crear Elemento
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetCreateForm()">
                                <i class="bi bi-x"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab: Estad√≠sticas -->
            <div id="tab-stats" class="tab-content" style="display: none;">
                <div class="form-section">
                    <h5>Estad√≠sticas de la Biblioteca</h5>
                    <div id="stats-detailed">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalTitle">Editar Elemento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="editForm">
                    <div class="modal-body">
                        <input type="hidden" id="edit-id">
                        
                        <div class="mb-3">
                            <label for="edit-name" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="edit-name" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit-category" class="form-label">Categor√≠a *</label>
                            <select class="form-select" id="edit-category" required></select>
                        </div>

                        <div class="mb-3">
                            <label for="edit-description" class="form-label">Descripci√≥n *</label>
                            <textarea class="form-control" id="edit-description" rows="4" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="edit-keywords" class="form-label">Palabras Clave</label>
                            <input type="text" class="form-control" id="edit-keywords">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Im√°genes Actuales</label>
                            <div id="edit-current-images" class="row g-2"></div>
                        </div>

                        <div class="mb-3">
                            <label for="edit-new-images" class="form-label">Agregar Nuevas Im√°genes</label>
                            <input type="file" class="form-control" id="edit-new-images" accept="image/*" multiple>
                        </div>

                        <div id="editMsg" class="small-msg" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-gradient">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000';
        let currentTab = 'phenomena';
        let allPhenomena = [];
        let allObjects = [];
        let token = localStorage.getItem('token');
        let currentUser = null;

        // Verificar autenticaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (!data.success || data.data.role !== 'admin') {
                    alert('Solo administradores pueden acceder');
                    window.location.href = 'dashboard.html';
                    return;
                }
                currentUser = data.data;
            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                window.location.href = 'login.html';
            }

            loadStats();
            loadPhenomena();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = link.getAttribute('data-tab');
                    switchTab(tab);
                });
            });

            // B√∫squeda
            document.getElementById('search-phenomena').addEventListener('input', debounce(filterPhenomena, 300));
            document.getElementById('search-objects').addEventListener('input', debounce(filterObjects, 300));

            // Filtros
            document.getElementById('filter-category-phenomena').addEventListener('change', filterPhenomena);
            document.getElementById('filter-category-objects').addEventListener('change', filterObjects);

            // Crear
            document.getElementById('create-images').addEventListener('change', previewImages);
            document.getElementById('createForm').addEventListener('submit', handleCreateSubmit);

            // Editar
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
        }

        // Cambiar tab
        function switchTab(tabName) {
            // Ocultar todas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Mostrar seleccionada
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            currentTab = tabName;

            // Cargar datos si es necesario
            if (tabName === 'objects' && allObjects.length === 0) {
                loadObjects();
            }
        }

        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/api/library/stats`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('stat-phenomena').textContent = data.data.phenomena.total;
                    document.getElementById('stat-objects').textContent = data.data.objects.total;
                    document.getElementById('stat-images').textContent = 
                        (data.data.phenomena.withImages || 0) + (data.data.objects.withImages || 0);
                }
            } catch (error) {
                console.error('Error cargando stats:', error);
            }
        }

        // Cargar fen√≥menos
        async function loadPhenomena() {
            try {
                const res = await fetch(`${API_URL}/api/library/phenomena?limit=100`);
                const data = await res.json();
                if (data.success) {
                    allPhenomena = data.data;
                    displayPhenomena(allPhenomena);
                }
            } catch (error) {
                console.error('Error cargando fen√≥menos:', error);
            }
        }

        // Cargar objetos
        async function loadObjects() {
            try {
                const res = await fetch(`${API_URL}/api/library/objects?limit=100`);
                const data = await res.json();
                if (data.success) {
                    allObjects = data.data;
                    displayObjects(allObjects);
                }
            } catch (error) {
                console.error('Error cargando objetos:', error);
            }
        }

        // Mostrar fen√≥menos
        function displayPhenomena(items) {
            const container = document.getElementById('phenomena-list');
            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state col-12"><i class="bi bi-inbox"></i><p>No hay fen√≥menos</p></div>`;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="library-card">
                    <div class="library-card-image">
                        ${item.images && item.images[0] ? 
                            `<img src="${item.images[0].url}" alt="${item.name}">` :
                            `<i class="bi bi-cloud-sun"></i>`
                        }
                    </div>
                    <div class="library-card-body">
                        <h6>${item.name}</h6>
                        <p>${item.description.substring(0, 60)}...</p>
                    </div>
                    <div class="library-card-footer">
                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('${item._id}', 'phenomenon')">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item._id}', 'phenomenon')">
                            <i class="bi bi-trash"></i> Borrar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Mostrar objetos
        function displayObjects(items) {
            const container = document.getElementById('objects-list');
            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state col-12"><i class="bi bi-inbox"></i><p>No hay objetos</p></div>`;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="library-card">
                    <div class="library-card-image">
                        ${item.manualImages && item.manualImages[0] ? 
                            `<img src="${item.manualImages[0].url}" alt="${item.name}">` :
                            item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}">` :
                            `<i class="bi bi-image"></i>`
                        }
                    </div>
                    <div class="library-card-body">
                        <h6>${item.name}</h6>
                        <p>${item.description.substring(0, 60)}...</p>
                    </div>
                    <div class="library-card-footer">
                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('${item._id}', 'object')">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item._id}', 'object')">
                            <i class="bi bi-trash"></i> Borrar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Filtrar fen√≥menos
        function filterPhenomena() {
            const search = document.getElementById('search-phenomena').value.toLowerCase();
            const category = document.getElementById('filter-category-phenomena').value;
            
            let filtered = allPhenomena.filter(p => {
                const matchSearch = p.name.toLowerCase().includes(search) || 
                                  p.description.toLowerCase().includes(search);
                const matchCategory = !category || p.category === category;
                return matchSearch && matchCategory;
            });
            
            displayPhenomena(filtered);
        }

        // Filtrar objetos
        function filterObjects() {
            const search = document.getElementById('search-objects').value.toLowerCase();
            const category = document.getElementById('filter-category-objects').value;
            
            let filtered = allObjects.filter(o => {
                const matchSearch = o.name.toLowerCase().includes(search) || 
                                  o.description.toLowerCase().includes(search);
                const matchCategory = !category || o.category === category;
                return matchSearch && matchCategory;
            });
            
            displayObjects(filtered);
        }

        // Actualizar formulario de creaci√≥n
        function updateCreateForm() {
            const type = document.getElementById('create-type').value;
            const form = document.getElementById('createForm');
            const categorySelect = document.getElementById('create-category');

            if (!type) {
                form.style.display = 'none';
                return;
            }

            form.style.display = 'block';

            // Cargar categor√≠as seg√∫n tipo
            if (type === 'phenomenon') {
                categorySelect.innerHTML = `
                    <option value="optical">√ìptico</option>
                    <option value="meteorological">Meteorol√≥gico</option>
                    <option value="astronomical">Astron√≥mico</option>
                    <option value="electrical">El√©ctrico</option>
                    <option value="cloud">Nuboso</option>
                `;
            } else {
                categorySelect.innerHTML = `
                    <option value="aircraft">‚úàÔ∏è Aeronave</option>
                    <option value="bird">ü¶Ö Ave</option>
                    <option value="drone">üöÅ Drone</option>
                    <option value="satellite">üõ∞Ô∏è Sat√©lite</option>
                    <option value="balloon">üéà Globo</option>
                    <option value="uap">üõ∏ UAP</option>
                `;
            }
        }

        // Preview de im√°genes
        function previewImages(e) {
            const preview = document.getElementById('create-preview');
            preview.innerHTML = '';
            
            Array.from(e.target.files).slice(0, 5).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    preview.innerHTML += `
                        <div class="col-md-2 mb-2">
                            <img src="${evt.target.result}" class="img-fluid rounded" style="max-height: 100px;">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            });
        }

        // Crear elemento
        async function handleCreateSubmit(e) {
            e.preventDefault();
            const type = document.getElementById('create-type').value;
            const name = document.getElementById('create-name').value;
            const category = document.getElementById('create-category').value;
            const description = document.getElementById('create-description').value;
            const keywords = document.getElementById('create-keywords').value
                .split(',')
                .map(k => k.trim())
                .filter(k => k);
            const images = document.getElementById('create-images').files;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('keywords', JSON.stringify(keywords));

            for (let i = 0; i < Math.min(images.length, 5); i++) {
                formData.append('images', images[i]);
            }

            try {
                const endpoint = type === 'phenomenon' 
                    ? '/api/library/phenomena' 
                    : '/api/library/objects';

                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await res.json();
                const msgDiv = document.getElementById('createMsg');

                if (data.success) {
                    msgDiv.textContent = '‚úÖ Elemento creado correctamente';
                    msgDiv.className = 'small-msg text-success';
                    msgDiv.style.display = 'block';
                    resetCreateForm();
                    loadStats();
                    setTimeout(() => loadPhenomena(), 500);
                } else {
                    msgDiv.textContent = '‚ùå Error: ' + (data.message || 'Error desconocido');
                    msgDiv.className = 'small-msg text-danger';
                    msgDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('createMsg').textContent = '‚ùå Error de conexi√≥n';
                document.getElementById('createMsg').className = 'small-msg text-danger';
                document.getElementById('createMsg').style.display = 'block';
            }
        }

        // Editar elemento
        async function editItem(id, type) {
            try {
                const endpoint = type === 'phenomenon' ? `/api/library/phenomena/${id}` : `/api/library/objects/${id}`;
                const res = await fetch(`${API_URL}${endpoint}`);
                const data = await res.json();

                if (data.success) {
                    const item = data.data;
                    document.getElementById('edit-id').value = id;
                    document.getElementById('editModalTitle').textContent = `Editar: ${item.name}`;
                    document.getElementById('edit-name').value = item.name;
                    document.getElementById('edit-category').value = item.category;
                    document.getElementById('edit-description').value = item.description;
                    document.getElementById('edit-keywords').value = (item.keywords || []).join(', ');

                    // Mostrar im√°genes actuales
                    const imagesDiv = document.getElementById('edit-current-images');
                    const images = type === 'phenomenon' 
                        ? (item.images || [])
                        : (item.manualImages || []);

                    imagesDiv.innerHTML = images.map((img, idx) => `
                        <div class="col-md-3 mb-2 position-relative">
                            <img src="${img.url}" class="img-fluid rounded" style="max-height: 100px;">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0"
                                    onclick="deleteImage('${id}', '${img._id}', '${type}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `).join('');

                    new bootstrap.Modal(document.getElementById('editModal')).show();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error cargando elemento');
            }
        }

        // Guardar cambios
        async function handleEditSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const category = document.getElementById('edit-category').value;
            const description = document.getElementById('edit-description').value;
            const keywords = document.getElementById('edit-keywords').value
                .split(',')
                .map(k => k.trim())
                .filter(k => k);

            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('keywords', JSON.stringify(keywords));

            const newImages = document.getElementById('edit-new-images').files;
            for (let i = 0; i < newImages.length; i++) {
                formData.append('newImages', newImages[i]);
            }

            try {
                const res = await fetch(`${API_URL}/api/library/edit/${id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await res.json();
                const msgDiv = document.getElementById('editMsg');

                if (data.success) {
                    msgDiv.textContent = '‚úÖ Cambios guardados';
                    msgDiv.className = 'small-msg text-success';
                    msgDiv.style.display = 'block';
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                        loadStats();
                        loadPhenomena();
                        loadObjects();
                    }, 1000);
                } else {
                    msgDiv.textContent = '‚ùå Error: ' + (data.message || 'Error desconocido');
                    msgDiv.className = 'small-msg text-danger';
                    msgDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('editMsg').textContent = '‚ùå Error de conexi√≥n';
                document.getElementById('editMsg').className = 'small-msg text-danger';
                document.getElementById('editMsg').style.display = 'block';
            }
        }

        // Eliminar imagen
        async function deleteImage(itemId, imageId, type) {
            if (!confirm('¬øEliminar esta imagen?')) return;

            try {
                const res = await fetch(`${API_URL}/api/library/edit/${itemId}/images/${imageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    // Recargar elemento
                    const currentId = document.getElementById('edit-id').value;
                    editItem(currentId, type);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error eliminando imagen');
            }
        }

        // Eliminar elemento
        async function deleteItem(id, type) {
            if (!confirm('¬øEst√°s seguro de eliminar este elemento?')) return;

            try {
                const endpoint = type === 'phenomenon' ? `/api/library/phenomena/${id}` : `/api/library/objects/${id}`;
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    alert('Elemento eliminado');
                    loadStats();
                    if (currentTab === 'phenomena') loadPhenomena();
                    else loadObjects();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error eliminando elemento');
            }
        }

        // Resetear formulario
        function resetCreateForm() {
            document.getElementById('createForm').reset();
            document.getElementById('create-type').value = '';
            document.getElementById('createForm').style.display = 'none';
            document.getElementById('create-preview').innerHTML = '';
            const msgDiv = document.getElementById('createMsg');
            msgDiv.style.display = 'none';
        }

        // Logout
        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
