<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard - UAP Analysis System v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Fuentes Retro A√±os 80 -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-gradient: linear-gradient(135deg, #434343 0%, #000000 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: 
                linear-gradient(180deg, rgba(101, 67, 33, 0.03) 0%, rgba(139, 90, 43, 0.05) 100%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 39px,
                    rgba(139, 90, 43, 0.08) 39px,
                    rgba(139, 90, 43, 0.08) 41px
                ),
                repeating-linear-gradient(
                    90deg,
                    #f5ebe0,
                    #f5ebe0 1px,
                    #ede3d4 1px,
                    #ede3d4 2px
                );
            background-color: #ede3d4;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            position: relative;
        }

        /* Textura de papel viejo con marcas */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 15% 25%, rgba(139, 90, 43, 0.12) 0%, transparent 15%),
                radial-gradient(circle at 78% 18%, rgba(101, 67, 33, 0.08) 0%, transparent 12%),
                radial-gradient(circle at 42% 65%, rgba(139, 90, 43, 0.10) 0%, transparent 18%),
                radial-gradient(circle at 88% 75%, rgba(101, 67, 33, 0.09) 0%, transparent 14%),
                radial-gradient(circle at 25% 88%, rgba(139, 90, 43, 0.11) 0%, transparent 16%),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 80px,
                    rgba(139, 90, 43, 0.02) 80px,
                    rgba(139, 90, 43, 0.02) 82px
                );
            pointer-events: none;
            z-index: 0;
        }

        /* Silueta de libros antiguos en esquina inferior derecha */
        body::after {
            content: '';
            position: fixed;
            bottom: 0;
            right: 0;
            width: 250px;
            height: 200px;
            background: 
                linear-gradient(105deg, transparent 40%, rgba(101, 67, 33, 0.15) 41%, rgba(101, 67, 33, 0.15) 43%, transparent 44%),
                linear-gradient(98deg, transparent 45%, rgba(80, 50, 20, 0.18) 46%, rgba(80, 50, 20, 0.18) 49%, transparent 50%),
                linear-gradient(110deg, transparent 50%, rgba(139, 90, 43, 0.12) 51%, rgba(139, 90, 43, 0.12) 54%, transparent 55%),
                linear-gradient(102deg, transparent 55%, rgba(70, 45, 20, 0.20) 56%, rgba(70, 45, 20, 0.20) 60%, transparent 61%);
            pointer-events: none;
            z-index: 0;
            opacity: 0.8;
        }

        /* Documentos apilados decorativos m√°s realistas */
        .decorative-documents {
            position: fixed;
            bottom: 40px;
            left: 30px;
            width: 140px;
            height: 180px;
            pointer-events: none;
            z-index: 1;
            opacity: 0.25;
        }

        /* Documento 1 - Fondo */
        .decorative-documents::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 160px;
            background: 
                linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%);
            border: 3px solid #8b5a2b;
            border-radius: 2px;
            transform: rotate(-8deg);
            box-shadow: 
                3px 3px 15px rgba(0, 0, 0, 0.3),
                inset 0 0 20px rgba(139, 90, 43, 0.05);
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 18px,
                    rgba(139, 90, 43, 0.15) 18px,
                    rgba(139, 90, 43, 0.15) 19px
                );
        }

        /* Documento 2 - Medio */
        .decorative-documents::after {
            content: '';
            position: absolute;
            width: 120px;
            height: 160px;
            background: 
                linear-gradient(180deg, #fafafa 0%, #ede3d4 100%);
            border: 3px solid #654321;
            border-radius: 2px;
            transform: rotate(5deg);
            left: 12px;
            top: 8px;
            box-shadow: 
                3px 3px 15px rgba(0, 0, 0, 0.3),
                inset 0 0 20px rgba(101, 67, 33, 0.05);
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 18px,
                    rgba(101, 67, 33, 0.15) 18px,
                    rgba(101, 67, 33, 0.15) 19px
                );
        }

        .navbar {
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 30px rgba(74, 158, 255, 0.2);
            padding: 15px 0;
            border-bottom: 3px solid #4a9eff;
            position: relative;
        }

        .navbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(74, 158, 255, 0.05) 2px,
                    rgba(74, 158, 255, 0.05) 4px
                );
            pointer-events: none;
        }

        .navbar-brand {
            font-family: 'VT323', monospace;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 3px;
            color: #4a9eff !important;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.8),
                0 0 15px rgba(74, 158, 255, 0.6);
            position: relative;
            z-index: 1;
        }

        .navbar .text-white {
            font-family: 'VT323', monospace;
            font-size: 1.3rem;
            color: #e0e0e0 !important;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.8),
                0 0 10px rgba(255, 255, 255, 0.3);
        }

        .navbar .bi-bell-fill {
            color: #4a9eff;
            filter: drop-shadow(0 0 10px rgba(74, 158, 255, 0.6));
            transition: all 0.3s;
        }

        .navbar .bi-bell-fill:hover {
            color: #ffd700;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            transform: scale(1.1);
        }

        .navbar .btn-outline-light {
            font-family: 'VT323', monospace;
            font-size: 1.15rem;
            border: 2px solid #4a9eff;
            color: #4a9eff;
            background: transparent;
            border-radius: 0;
            padding: 8px 20px;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(74, 158, 255, 0.3);
        }

        .navbar .btn-outline-light:hover {
            background: #4a9eff;
            color: #000;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.8);
            transform: translateY(-2px);
        }

        .navbar .badge {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
        }

        .sidebar {
            min-height: calc(100vh - 70px);
            background: linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 100%);
            backdrop-filter: blur(10px);
            border-right: 3px solid #4a9eff;
            padding: 25px 0;
            box-shadow: 5px 0 15px rgba(74, 158, 255, 0.3);
            position: relative;
            z-index: 10;
        }

        /* Efecto de carpeta clasificada en sidebar */
        .sidebar::before {
            content: 'TOP SECRET';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) rotate(-3deg);
            font-family: 'Press Start 2P', cursive;
            font-size: 0.65rem;
            font-weight: bold;
            color: #ff0000;
            border: 2px solid #ff0000;
            padding: 4px 12px;
            opacity: 0.5;
            letter-spacing: 2px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .sidebar .nav-link {
            color: #e0e0e0;
            padding: 14px 20px;
            margin: 8px 15px;
            border-radius: 0;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            font-family: 'VT323', monospace;
            font-size: 1.3rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.8),
                0 0 8px rgba(255, 255, 255, 0.2);
        }

        .sidebar .nav-link::before {
            content: '‚ñ∂';
            position: absolute;
            left: 5px;
            opacity: 0;
            transition: all 0.3s;
            color: #4a9eff;
        }

        .sidebar .nav-link i {
            font-size: 1.3rem;
            color: #4a9eff;
            filter: drop-shadow(0 0 5px rgba(74, 158, 255, 0.5));
        }

        .sidebar .nav-link:hover {
            background: rgba(74, 158, 255, 0.15);
            color: #ffffff;
            transform: translateX(5px);
            border-left: 3px solid #4a9eff;
            box-shadow: inset 0 0 20px rgba(74, 158, 255, 0.2);
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.8),
                0 0 15px rgba(255, 255, 255, 0.5);
        }

        .sidebar .nav-link:hover::before {
            opacity: 1;
            left: 8px;
        }

        .sidebar .nav-link.active {
            background: rgba(74, 158, 255, 0.25);
            color: #ffd700;
            border-left: 4px solid #ffd700;
            box-shadow: inset 0 0 25px rgba(74, 158, 255, 0.3);
        }

        .sidebar .nav-link.active i {
            color: #ffd700;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(139, 90, 43, 0.15);
            transition: all 0.3s ease;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            position: relative;
            border: 2px solid rgba(139, 90, 43, 0.2);
        }

        /* Sello decorativo en las cards */
        .card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(211, 47, 47, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-card {
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .stat-card:hover::before {
            animation: shine 1.5s ease;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .stat-icon {
            font-size: 48px;
            opacity: 0.85;
            transition: all 0.3s;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1);
            opacity: 1;
        }

        .welcome-card {
            background: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent),
                radial-gradient(1px 1px at 33% 80%, white, transparent),
                radial-gradient(2px 2px at 10% 90%, white, transparent),
                radial-gradient(1px 1px at 70% 20%, white, transparent),
                radial-gradient(1px 1px at 25% 60%, white, transparent),
                radial-gradient(2px 2px at 45% 15%, white, transparent),
                linear-gradient(135deg, rgba(5, 15, 35, 0.98) 0%, rgba(10, 25, 50, 0.95) 30%, rgba(13, 71, 161, 0.85) 70%, rgba(21, 101, 192, 0.95) 100%);
            background-size: 
                200% 200%,
                200% 200%,
                200% 200%,
                200% 200%,
                200% 200%,
                200% 200%,
                200% 200%,
                200% 200%,
                200% 200%,
                200% 200%,
                cover;
            background-position: 0% 0%;
            animation: starfield 120s linear infinite;
            color: #e3f2fd;
            padding: 50px;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 
                0 15px 50px rgba(13, 71, 161, 0.5),
                0 0 80px rgba(33, 150, 243, 0.3),
                inset 0 0 100px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border: 3px solid #2196f3;
            border-top: 6px solid #1976d2;
        }

        @keyframes starfield {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* Efecto de resplandor ne√≥n animado */
        .welcome-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(33, 150, 243, 0.1) 0%, 
                transparent 50%);
            animation: rotateGlow 8s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes rotateGlow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Luz roja misteriosa en movimiento - parte superior */
        .welcome-card::after {
            content: '';
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, #ff0000 0%, #ff4444 30%, #ff0000 60%, rgba(255, 0, 0, 0) 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 20px 5px rgba(255, 0, 0, 0.8),
                0 0 40px 10px rgba(255, 0, 0, 0.5),
                0 0 60px 15px rgba(255, 0, 0, 0.3),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: mysteriousRedLight 5s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes mysteriousRedLight {
            0% { 
                transform: translateX(-50%) translateY(0);
                opacity: 1;
                box-shadow: 
                    0 0 20px 5px rgba(255, 0, 0, 0.8),
                    0 0 40px 10px rgba(255, 0, 0, 0.5),
                    0 0 60px 15px rgba(255, 0, 0, 0.3);
            }
            20% { 
                transform: translateX(calc(-50% + 80px)) translateY(-20px);
                opacity: 0.7;
                box-shadow: 
                    0 0 30px 8px rgba(255, 0, 0, 1),
                    0 0 50px 15px rgba(255, 0, 0, 0.7),
                    0 0 80px 20px rgba(255, 0, 0, 0.4);
            }
            40% { 
                transform: translateX(calc(-50% - 100px)) translateY(-10px);
                opacity: 0.9;
                box-shadow: 
                    0 0 25px 6px rgba(255, 0, 0, 0.9),
                    0 0 45px 12px rgba(255, 0, 0, 0.6),
                    0 0 70px 18px rgba(255, 0, 0, 0.35);
            }
            60% { 
                transform: translateX(calc(-50% + 60px)) translateY(-25px);
                opacity: 0.6;
                box-shadow: 
                    0 0 35px 10px rgba(255, 0, 0, 1),
                    0 0 60px 18px rgba(255, 0, 0, 0.8),
                    0 0 90px 25px rgba(255, 0, 0, 0.5);
            }
            80% { 
                transform: translateX(calc(-50% - 50px)) translateY(-15px);
                opacity: 0.8;
                box-shadow: 
                    0 0 28px 7px rgba(255, 0, 0, 0.85),
                    0 0 48px 13px rgba(255, 0, 0, 0.65),
                    0 0 75px 19px rgba(255, 0, 0, 0.4);
            }
            100% { 
                transform: translateX(-50%) translateY(0);
                opacity: 1;
                box-shadow: 
                    0 0 20px 5px rgba(255, 0, 0, 0.8),
                    0 0 40px 10px rgba(255, 0, 0, 0.5),
                    0 0 60px 15px rgba(255, 0, 0, 0.3);
            }
        }

        .welcome-card > * {
            position: relative;
            z-index: 1;
        }

        .welcome-card h2 {
            font-family: 'VT323', monospace;
            font-weight: 900;
            font-size: 3rem;
            color: #00ffff;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 
                0 0 5px #00ffff,
                0 0 10px #00ffff,
                0 0 20px #00ffff,
                0 0 40px #00d4ff,
                0 0 80px #0099ff,
                0 0 120px #0066ff,
                0 0 160px #0033ff,
                2px 2px 2px rgba(0, 0, 0, 0.8);
            animation: neonFlicker 3s ease-in-out infinite alternate, neonPulse 2s ease-in-out infinite alternate;
            filter: brightness(1.2) contrast(1.3);
        }

        @keyframes neonFlicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow: 
                    0 0 5px #00ffff,
                    0 0 10px #00ffff,
                    0 0 20px #00ffff,
                    0 0 40px #00d4ff,
                    0 0 80px #0099ff,
                    0 0 120px #0066ff,
                    0 0 160px #0033ff;
            }
            20%, 24%, 55% {
                text-shadow: 
                    0 0 2px #00ffff,
                    0 0 5px #00ffff,
                    0 0 10px #00ffff;
            }
        }

        @keyframes neonPulse {
            from {
                text-shadow: 
                    0 0 5px #00ffff,
                    0 0 10px #00ffff,
                    0 0 20px #00ffff,
                    0 0 40px #00d4ff,
                    0 0 80px #0099ff,
                    0 0 120px #0066ff;
            }
            to {
                text-shadow: 
                    0 0 10px #00ffff,
                    0 0 20px #00ffff,
                    0 0 30px #00ffff,
                    0 0 60px #00d4ff,
                    0 0 100px #0099ff,
                    0 0 140px #0066ff,
                    0 0 180px #0033ff;
            }
        }

        .welcome-card p {
            font-family: 'VT323', monospace;
            font-size: 1.4rem;
            color: #80d4ff;
            text-shadow: 
                0 0 5px #00d4ff,
                0 0 10px #0099ff,
                0 0 15px #0066ff,
                2px 2px 4px rgba(0, 0, 0, 0.8);
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        @keyframes textGlow {
            from {
                text-shadow: 
                    0 0 5px #00d4ff,
                    0 0 10px #0099ff,
                    0 0 15px #0066ff;
            }
            to {
                text-shadow: 
                    0 0 10px #00ffff,
                    0 0 20px #00d4ff,
                    0 0 30px #0099ff,
                    0 0 40px #0066ff;
            }
        }

        .badge-role {
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Press Start 2P', cursive;
            font-weight: 900;
            font-size: 0.65rem;
            background: linear-gradient(135deg, #001a33 0%, #003366 100%) !important;
            color: #00ffff !important;
            border: 2px solid #00ffff;
            letter-spacing: 1px;
            text-shadow: 
                0 0 5px #00ffff,
                0 0 10px #00ffff,
                0 0 20px #00d4ff,
                0 0 30px #0099ff,
                2px 2px 4px rgba(0, 0, 0, 0.9);
            box-shadow: 
                0 0 10px #00ffff,
                0 0 20px #00d4ff,
                0 0 30px #0099ff,
                0 4px 15px rgba(0, 0, 0, 0.7),
                inset 0 0 10px rgba(0, 255, 255, 0.2);
            animation: badgeNeonGlow 2s ease-in-out infinite alternate;
        }

        @keyframes badgeNeonGlow {
            from {
                box-shadow: 
                    0 0 10px #00ffff,
                    0 0 20px #00d4ff,
                    0 0 30px #0099ff,
                    0 4px 15px rgba(0, 0, 0, 0.7);
                border-color: #00ffff;
            }
            to {
                box-shadow: 
                    0 0 20px #00ffff,
                    0 0 40px #00d4ff,
                    0 0 60px #0099ff,
                    0 0 80px #0066ff,
                    0 4px 15px rgba(0, 0, 0, 0.7);
                border-color: #00d4ff;
            }
        }

        .content-area {
            padding: 35px;
            position: relative;
            z-index: 5;
        }

        /* Efecto de mesa de escritorio con documentos */
        .content-area::before {
            content: '';
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background: 
                linear-gradient(180deg, transparent 0%, rgba(101, 67, 33, 0.03) 100%);
            pointer-events: none;
            z-index: 1;
        }

        /* Marca de caf√© decorativa */
        .content-area::after {
            content: '';
            position: fixed;
            top: 200px;
            right: 150px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(101, 67, 33, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }

        .btn {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
        }

        .btn-success {
            background: var(--success-gradient);
            border: none;
        }

        .btn-danger {
            background: var(--secondary-gradient);
            border: none;
        }

        .alert {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress {
            border-radius: 10px;
            height: 30px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-bar {
            border-radius: 10px;
            background: var(--primary-gradient);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 12px 15px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .table {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .table thead {
            background: var(--primary-gradient);
            color: white;
        }

        .table tbody tr {
            transition: all 0.3s;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
        }

        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeIn 0.5s ease;
        }

        /* Estilos para el bot√≥n de PayPal */
        .paypal-button {
            display: inline-block;
            background: linear-gradient(135deg, #0070ba 0%, #1546a0 100%);
            color: white;
            text-decoration: none;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(0, 112, 186, 0.4);
            transition: all 0.3s ease;
        }

        .paypal-button:hover {
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 112, 186, 0.6);
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        /* Micr√≥fono vintage decorativo */
        .vintage-microphone {
            position: fixed;
            top: 120px;
            right: 50px;
            width: 40px;
            height: 80px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
        }

        .vintage-microphone::before {
            content: '';
            position: absolute;
            width: 35px;
            height: 50px;
            background: linear-gradient(180deg, #5a5a5a 0%, #3a3a3a 100%);
            border-radius: 15px 15px 5px 5px;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .vintage-microphone::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 30px;
            background: #4a4a4a;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        /* C√°mara antigua */
        .old-camera {
            position: fixed;
            top: 150px;
            left: 50px;
            width: 70px;
            height: 50px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
        }

        .old-camera::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 45px;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .old-camera::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, #666 0%, #333 100%);
            border-radius: 50%;
            top: 10px;
            right: 15px;
            border: 3px solid #444;
        }

        /* Teclas de m√°quina de escribir */
        .typewriter-keys {
            position: fixed;
            bottom: 180px;
            right: 60px;
            width: 80px;
            height: 60px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.08;
        }

        .typewriter-keys::before,
        .typewriter-keys::after {
            content: '';
            width: 15px;
            height: 15px;
            background: linear-gradient(135deg, #f5f5f5 0%, #d0d0d0 100%);
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Clips y chinchetas decorativas */
        .sidebar::after {
            content: '';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4a9eff, transparent);
            box-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
        }

        /* Sello "CONFIDENCIAL" en cards */
        .stat-card::after {
            content: 'CONFIDENCIAL';
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 0.5rem;
            color: rgba(211, 47, 47, 0.15);
            font-weight: bold;
            letter-spacing: 1px;
            transform: rotate(-10deg);
            border: 1px solid rgba(211, 47, 47, 0.15);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content-area {
                padding: 20px;
            }
            
            .welcome-card {
                padding: 25px;
            }
            
            .stat-card {
                padding: 20px;
            }

            .vintage-microphone,
            .old-camera,
            .typewriter-keys,
            .decorative-documents {
                display: none;
            }

            .ufo-animated {
                display: none;
            }
        }

        /* Logo UFO realista en navbar */
        .navbar-brand i.bi-disc {
            display: inline-block;
            position: relative;
            font-size: 1.8rem;
            color: #4a9eff;
            filter: drop-shadow(0 0 10px rgba(74, 158, 255, 0.8));
            animation: glow-logo 3s ease-in-out infinite;
        }

        @keyframes glow-logo {
            0%, 100% { 
                filter: drop-shadow(0 0 10px rgba(74, 158, 255, 0.8));
            }
            50% { 
                filter: drop-shadow(0 0 20px rgba(74, 158, 255, 1)) drop-shadow(0 0 30px rgba(255, 215, 0, 0.5));
            }
        }

        /* OVNI Realista - Solo en zona de cabecera */
        .ufo-animated {
            position: absolute;
            width: 200px;
            height: 90px;
            top: 50%;
            left: -250px;
            transform: translateY(-50%);
            z-index: 2;
            pointer-events: none;
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.6));
            animation: flyUFORealistic 20s ease-in-out infinite;
        }

        @keyframes flyUFORealistic {
            0% {
                left: -250px;
                transform: translateY(-50%) rotate(-8deg) scale(0.8);
                opacity: 0;
            }
            15% {
                opacity: 1;
            }
            20% {
                left: 20%;
                transform: translateY(-50%) rotate(2deg) scale(1);
            }
            40% {
                left: 40%;
                transform: translateY(-45%) rotate(-3deg) scale(1.05);
            }
            60% {
                left: 60%;
                transform: translateY(-55%) rotate(4deg) scale(0.95);
            }
            80% {
                left: 80%;
                transform: translateY(-50%) rotate(-2deg) scale(1);
            }
            85% {
                opacity: 1;
            }
            100% {
                left: 110%;
                transform: translateY(-50%) rotate(8deg) scale(0.8);
                opacity: 0;
            }
        }

        /* Estructura del OVNI Realista */
        .ufo-body {
            position: relative;
            width: 100%;
            height: 100%;
            filter: contrast(1.1) brightness(1.05);
        }

        /* Domo superior met√°lico */
        .ufo-dome {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 40px;
            background: 
                radial-gradient(ellipse at 50% 20%, #f0f0f0, #a8a8a8 40%, #606060 70%, #404040);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 
                inset 0 -5px 15px rgba(0, 0, 0, 0.6),
                inset 0 3px 10px rgba(255, 255, 255, 0.3),
                0 5px 20px rgba(0, 0, 0, 0.5);
            animation: ufo-pulse 3s ease-in-out infinite;
        }

        /* Reflejo en el domo */
        .ufo-dome::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 20%;
            width: 30px;
            height: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(2px);
        }

        /* Cuerpo principal del disco */
        .ufo-disc {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 50px;
            background: 
                linear-gradient(to bottom, 
                    #f5f5f5 0%, 
                    #d0d0d0 15%,
                    #a8a8a8 30%,
                    #787878 50%,
                    #606060 70%,
                    #404040 85%,
                    #2a2a2a 100%);
            border-radius: 50%;
            box-shadow: 
                0 8px 30px rgba(0, 0, 0, 0.8),
                inset 0 3px 15px rgba(255, 255, 255, 0.3),
                inset 0 -5px 20px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        /* Anillo met√°lico del disco */
        .ufo-disc::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 10px;
            background: linear-gradient(to right,
                #505050,
                #808080 20%,
                #a0a0a0 50%,
                #808080 80%,
                #505050
            );
            border-radius: 50%;
            box-shadow: 
                inset 0 2px 5px rgba(0, 0, 0, 0.5),
                0 1px 3px rgba(255, 255, 255, 0.2);
        }

        /* Ventanas del disco */
        .ufo-disc::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 8px;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 25px,
                    rgba(100, 200, 255, 0.4) 25px,
                    rgba(100, 200, 255, 0.4) 30px
                );
            border-radius: 50%;
        }

        /* Luces realistas del OVNI */
        .ufo-lights {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 12px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 10;
        }

        .ufo-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
        }

        /* Haz de luz proyectado */
        .ufo-light::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background: linear-gradient(to bottom, currentColor, transparent);
            opacity: 0.6;
            filter: blur(1px);
        }

        .ufo-light:nth-child(1) {
            background: radial-gradient(circle at 30% 30%, #ffaaaa, #ff3333, #aa0000);
            box-shadow: 
                0 0 15px #ff3333, 
                0 0 30px #ff0000,
                inset 0 1px 3px rgba(255, 255, 255, 0.5);
            color: #ff3333;
            animation: ufo-light-blink 1.2s ease-in-out infinite;
        }

        .ufo-light:nth-child(2) {
            background: radial-gradient(circle at 30% 30%, #aaffaa, #33ff33, #00aa00);
            box-shadow: 
                0 0 15px #33ff33, 
                0 0 30px #00ff00,
                inset 0 1px 3px rgba(255, 255, 255, 0.5);
            color: #33ff33;
            animation: ufo-light-blink 1.2s ease-in-out infinite;
            animation-delay: 0.3s;
        }

        .ufo-light:nth-child(3) {
            background: radial-gradient(circle at 30% 30%, #aaaaff, #3333ff, #0000aa);
            box-shadow: 
                0 0 15px #3333ff, 
                0 0 30px #0000ff,
                inset 0 1px 3px rgba(255, 255, 255, 0.5);
            color: #3333ff;
            animation: ufo-light-blink 1.2s ease-in-out infinite;
            animation-delay: 0.6s;
        }

        .ufo-light:nth-child(4) {
            background: radial-gradient(circle at 30% 30%, #ffffaa, #ffff33, #aaaa00);
            box-shadow: 
                0 0 15px #ffff33, 
                0 0 30px #ffff00,
                inset 0 1px 3px rgba(255, 255, 255, 0.5);
            color: #ffff33;
            animation: ufo-light-blink 1.2s ease-in-out infinite;
            animation-delay: 0.9s;
        }

        .ufo-light:nth-child(5) {
            background: radial-gradient(circle at 30% 30%, #ffaaff, #ff33ff, #aa00aa);
            box-shadow: 
                0 0 15px #ff33ff, 
                0 0 30px #ff00ff,
                inset 0 1px 3px rgba(255, 255, 255, 0.5);
            color: #ff33ff;
            animation: ufo-light-blink 1.2s ease-in-out infinite;
            animation-delay: 1.2s;
        }

        @keyframes ufo-pulse {
            0%, 100% { 
                transform: translateX(-50%) scaleY(1);
                filter: brightness(1);
            }
            50% { 
                transform: translateX(-50%) scaleY(1.05);
                filter: brightness(1.1);
            }
        }

        @keyframes ufo-light-blink {
            0%, 100% { 
                opacity: 0.4;
                transform: scale(0.9);
            }
            50% { 
                opacity: 1;
                transform: scale(1.1);
            }
        }

        /* Fix para modal de edici√≥n - asegurar que est√© por encima de todo */
        #editLibraryModal {
            z-index: 9999 !important;
        }

        #editLibraryModal .modal-dialog {
            z-index: 10000 !important;
        }

        .modal-backdrop {
            z-index: 9998 !important;
            pointer-events: auto !important;
        }

        /* Asegurar que el modal sea interactivo */
        .modal.show {
            display: block !important;
            pointer-events: auto !important;
            z-index: 9999 !important;
        }

        .modal-dialog {
            pointer-events: auto !important;
            z-index: 10000 !important;
        }
        
        .modal-content {
            pointer-events: auto !important;
        }
        
        /* Forzar que el modal est√© visible e interactivo */
        #analysisModal {
            z-index: 9999 !important;
        }
        
        #analysisModal .modal-dialog {
            z-index: 10000 !important;
        }

        /* Estilos para tarjetas de resultados */
        .border-left {
            border-left: 4px solid #999 !important;
        }

        .border-left.border-primary {
            border-left-color: #0d6efd !important;
        }

        .border-left.border-info {
            border-left-color: #0dcaf0 !important;
        }

        .border-left.border-success {
            border-left-color: #198754 !important;
        }

        .card-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Elementos decorativos -->
    <div class="decorative-documents"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-disc"></i> UAP Analysis System
            </a>
            <div class="d-flex align-items-center gap-3">
                <!-- Badge de notificaciones -->
                <a href="notifications.html" class="position-relative text-white text-decoration-none" title="Notificaciones">
                    <i class="bi bi-bell-fill" style="font-size: 1.5rem;"></i>
                    <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                        0
                    </span>
                </a>
                
                <span class="text-white">
                    <i class="bi bi-person-circle"></i> 
                    <span id="userName">Usuario</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('profile')">
                        <i class="bi bi-person"></i> Mi Perfil
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('uploads')">
                        <i class="bi bi-cloud-upload"></i> Subir An√°lisis
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('reports')">
                        <i class="bi bi-file-earmark-text"></i> Mis Reportes
                    </a>
                    <a class="nav-link" href="biblioteca.html" target="_blank">
                        <i class="bi bi-book"></i> Biblioteca Visual
                    </a>
                    <!-- ADMIN ONLY: Gesti√≥n de Biblioteca -->
                    <a class="nav-link admin-only" href="#" onclick="showSection('libraryAdmin')" style="display: none;">
                        <i class="bi bi-book-half"></i> Admin - Gesti√≥n Biblioteca
                    </a>
                    <!-- ADMIN ONLY: Configuraci√≥n del Sitio -->
                    <a class="nav-link admin-only" href="#" onclick="showSection('siteConfig')" style="display: none;">
                        <i class="bi bi-gear-fill"></i> Admin - Configuraci√≥n
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('donate')">
                        <i class="bi bi-heart-fill"></i> Donar
                    </a>
                    <a class="nav-link" href="https://www.ovniesp.com" target="_blank" rel="noopener" id="websiteLink">
                        <i class="bi bi-globe"></i> Nuestra Web
                    </a>
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-house"></i> Inicio
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 content-area">
                <!-- Welcome Card -->
                <div class="card welcome-card">
                    <!-- OVNI Realista volando dentro de la cabecera -->
                    <div class="ufo-animated">
                        <div class="ufo-body">
                            <div class="ufo-dome"></div>
                            <div class="ufo-disc"></div>
                            <div class="ufo-lights">
                                <div class="ufo-light"></div>
                                <div class="ufo-light"></div>
                                <div class="ufo-light"></div>
                                <div class="ufo-light"></div>
                                <div class="ufo-light"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2>¬°Bienvenido <span id="userFirstName">Usuario</span>!</h2>
                            <p class="mb-2">
                                <i class="bi bi-envelope"></i> 
                                <span id="userEmail">email@ejemplo.com</span>
                            </p>
                            <span class="badge-role bg-light text-dark" id="userRole">Usuario</span>
                        </div>
                        <div class="col-md-4 text-end">
                            <i class="bi bi-person-circle" style="font-size: 80px; color: #ffd700; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));"></i>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboardSection">
                    <h3 class="mb-4">Panel de Control</h3>
                    
                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <div class="card stat-card">
                                <div class="text-center">
                                    <i class="bi bi-cloud-upload stat-icon text-primary"></i>
                                    <h3 class="mt-3" id="totalAnalysisCount">0</h3>
                                    <p class="text-muted">An√°lisis Subidos</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card stat-card">
                                <div class="text-center">
                                    <i class="bi bi-file-earmark-check stat-icon text-success"></i>
                                    <h3 class="mt-3" id="completedAnalysisCount">0</h3>
                                    <p class="text-muted">Completados</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card stat-card">
                                <div class="text-center">
                                    <i class="bi bi-hourglass-split stat-icon text-warning"></i>
                                    <h3 class="mt-3" id="processingAnalysisCount">0</h3>
                                    <p class="text-muted">En Proceso</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üõ∏ SECCI√ìN RETRO 80s - EXPEDIENTE X -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="retro-file-container">
                                <div class="retro-file-header">
                                    <div class="file-stamp">CLASIFICADO</div>
                                    <h3 class="file-title">
                                        <i class="bi bi-file-earmark-text"></i> 
                                        EXPEDIENTE: SISTEMA UAP v3.0 - H√çBRIDO
                                    </h3>
                                    <div class="file-id">ID: UAP-SYS-2025-001-H3</div>
                                </div>

                                <div class="retro-tabs">
                                    <div class="tab-button active" onclick="openRetroTab(event, 'tab1')">
                                        <i class="bi bi-layers"></i> 3 CAPAS H√çBRIDAS
                                    </div>
                                    <div class="tab-button" onclick="openRetroTab(event, 'tab2')">
                                        <i class="bi bi-shield-check"></i> SCORING
                                    </div>
                                    <div class="tab-button" onclick="openRetroTab(event, 'tab3')">
                                        <i class="bi bi-globe"></i> VALIDACI√ìN
                                    </div>
                                    <div class="tab-button" onclick="openRetroTab(event, 'tab4')">
                                        <i class="bi bi-eye"></i> OPENCV
                                    </div>
                                </div>

                                <!-- TAB 1: An√°lisis Multicapa -->
                                <div id="tab1" class="retro-tab-content active">
                                    <div class="retro-section">
                                        <div class="section-header">
                                            <i class="bi bi-search"></i> AN√ÅLISIS H√çBRIDO DE 3 CAPAS
                                        </div>
                                        <div class="retro-grid">
                                            <div class="retro-item">
                                                <div class="item-icon">üî¨</div>
                                                <div class="item-title">Capa 1: Detecci√≥n Objetiva</div>
                                                <div class="item-desc">OpenCV (Sharp + Jimp) - An√°lisis local determin√≠stico</div>
                                                <div class="status-active">‚óè ACTIVO</div>
                                            </div>
                                            <div class="retro-item">
                                                <div class="item-icon">ÔøΩ</div>
                                                <div class="item-title">Capa 2: Training Dataset</div>
                                                <div class="item-desc">Aprendizaje supervisado + UFODatabase cient√≠fica</div>
                                                <div class="status-active">‚óè ACTIVO</div>
                                            </div>
                                            <div class="retro-item">
                                                <div class="item-icon">ü§ñ</div>
                                                <div class="item-title">Capa 3: Llama Vision (Complemento)</div>
                                                <div class="item-desc">An√°lisis sem√°ntico solo si confianza < 75%</div>
                                                <div class="status-active">‚óè ACTIVO</div>
                                            </div>
                                            <div class="retro-item">
                                                <div class="item-icon">üåê</div>
                                                <div class="item-title">Validaci√≥n Externa</div>
                                                <div class="item-desc">APIs en tiempo real (OpenSky, SunCalc, ISS)</div>
                                                <div class="status-active">‚óè ACTIVO</div>
                                            </div>
                                        </div>
                                        <div class="retro-note" style="background: rgba(74, 158, 255, 0.1); border-left: 4px solid #4a9eff; padding: 12px; margin-top: 15px;">
                                            <i class="bi bi-info-circle"></i> <strong>ARQUITECTURA H√çBRIDA:</strong> Combina precisi√≥n cient√≠fica local (OpenCV), aprendizaje continuo (Training) y contexto sem√°ntico (Llama Vision) para m√°xima fiabilidad.
                                        </div>
                                    </div>
                                </div>

                                <!-- TAB 2: Sistema de Confianza -->
                                <div id="tab2" class="retro-tab-content">
                                    <div class="retro-section">
                                        <div class="section-header">
                                            <i class="bi bi-bar-chart"></i> SISTEMA DE SCORING H√çBRIDO PONDERADO
                                        </div>
                                        
                                        <div class="retro-note" style="margin-bottom: 15px; background: rgba(255, 100, 100, 0.1); border-left: 4px solid #ff6464;">
                                            <i class="bi bi-camera"></i> <strong>DATOS EXIF - CR√çTICOS:</strong> Metadatos esenciales extra√≠dos de cada imagen (GPS, timestamp, modelo c√°mara, exposici√≥n, ISO). Se procesan autom√°ticamente antes del an√°lisis.
                                        </div>
                                        
                                        <div class="confidence-bars">
                                            <div class="confidence-item">
                                                <div class="conf-label">ÔøΩ Datos EXIF (GPS, Timestamp, C√°mara)</div>
                                                <div class="conf-bar-container">
                                                    <div class="conf-bar" style="width: 100%; background: linear-gradient(90deg, #ff6464, #cc3333);">CR√çTICO</div>
                                                </div>
                                            </div>
                                            <div class="confidence-item">
                                                <div class="conf-label">ÔøΩüî¨ OpenCV - Detecci√≥n Objetiva</div>
                                                <div class="conf-bar-container">
                                                    <div class="conf-bar" style="width: 40%; background: linear-gradient(90deg, #4a9eff, #2171d4);">40%</div>
                                                </div>
                                            </div>
                                            <div class="confidence-item">
                                                <div class="conf-label">üìö Training Dataset + Cient√≠fico</div>
                                                <div class="conf-bar-container">
                                                    <div class="conf-bar" style="width: 40%; background: linear-gradient(90deg, #00ff88, #00cc66);">40%</div>
                                                </div>
                                            </div>
                                            <div class="confidence-item">
                                                <div class="conf-label">ü§ñ Llama Vision (Complemento)</div>
                                                <div class="conf-bar-container">
                                                    <div class="conf-bar" style="width: 20%; background: linear-gradient(90deg, #ffd700, #ffaa00);">20%</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="retro-note" style="margin-top: 15px; background: rgba(255, 100, 100, 0.1); border-left: 4px solid #ff6464;">
                                            <i class="bi bi-info-circle"></i> <strong>METADATOS EXIF EXTRA√çDOS:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li><strong>Ubicaci√≥n:</strong> Coordenadas GPS (latitud/longitud) para validaci√≥n geogr√°fica</li>
                                                <li><strong>Temporal:</strong> Fecha y hora exacta de captura para correlaci√≥n astron√≥mica</li>
                                                <li><strong>Dispositivo:</strong> Marca, modelo, configuraci√≥n de c√°mara (ISO, exposici√≥n, focal)</li>
                                                <li><strong>Autenticidad:</strong> Verificaci√≥n de manipulaci√≥n digital mediante an√°lisis de metadatos</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="retro-note" style="margin-top: 15px;">
                                            <i class="bi bi-calculator"></i> <strong>F√ìRMULA H√çBRIDA:</strong> Score Final = (OpenCV √ó 0.40) + (Cient√≠fico √ó 0.40) + (Llama √ó 0.20)
                                        </div>
                                        <div class="retro-note" style="margin-top: 10px; background: rgba(255, 215, 0, 0.1); border-left: 4px solid #ffd700;">
                                            <i class="bi bi-trophy"></i> <strong>BONUS ADICIONALES:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>Training Match ‚â•75%: +0-7% bonus</li>
                                                <li>Llama coincide con cient√≠fico: +0-6% bonus</li>
                                            </ul>
                                        </div>
                                        <div class="retro-note" style="margin-top: 10px;">
                                            <i class="bi bi-lightning-charge"></i> <strong>VENTAJA:</strong> Llama solo se ejecuta si confianza inicial < 75%, ahorrando tiempo y recursos.
                                        </div>
                                    </div>
                                </div>

                                <!-- TAB 3: Validaci√≥n en Tiempo Real -->
                                <div id="tab3" class="retro-tab-content">
                                    <div class="retro-section">
                                        <div class="section-header">
                                            <i class="bi bi-broadcast"></i> VALIDACI√ìN EN TIEMPO REAL
                                        </div>
                                        <div class="api-list">
                                            <div class="api-item">
                                                <div class="api-icon">‚úàÔ∏è</div>
                                                <div class="api-info">
                                                    <div class="api-name">OpenSky Network</div>
                                                    <div class="api-desc">Tr√°fico a√©reo en radio 50km</div>
                                                </div>
                                                <div class="api-status">
                                                    <span class="status-dot"></span> ONLINE
                                                </div>
                                            </div>
                                            <div class="api-item">
                                                <div class="api-icon">‚òÄÔ∏è</div>
                                                <div class="api-info">
                                                    <div class="api-name">SunCalc</div>
                                                    <div class="api-desc">Posiciones de Sol, Luna y planetas</div>
                                                </div>
                                                <div class="api-status">
                                                    <span class="status-dot"></span> ONLINE
                                                </div>
                                            </div>
                                            <div class="api-item">
                                                <div class="api-icon">üõ∞Ô∏è</div>
                                                <div class="api-info">
                                                    <div class="api-name">N2YO</div>
                                                    <div class="api-desc">Sat√©lites visibles en tiempo real</div>
                                                </div>
                                                <div class="api-status">
                                                    <span class="status-dot"></span> ONLINE
                                                </div>
                                            </div>
                                            <div class="api-item">
                                                <div class="api-icon">üéà</div>
                                                <div class="api-info">
                                                    <div class="api-name">StratoCat DB</div>
                                                    <div class="api-desc">Globos estratosf√©ricos</div>
                                                </div>
                                                <div class="api-status">
                                                    <span class="status-dot"></span> ONLINE
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- TAB 4: An√°lisis de Imagen -->
                                <div id="tab4" class="retro-tab-content">
                                    <div class="retro-section">
                                        <div class="section-header">
                                            <i class="bi bi-camera"></i> AN√ÅLISIS DE IMAGEN - ALGORITMOS OPENCV
                                        </div>
                                        <div class="feature-list">
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Colores Dominantes:</strong> Extracci√≥n de 5 colores principales con frecuencia</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Detecci√≥n de Bordes:</strong> Algoritmo Sobel para identificar contornos</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Nitidez:</strong> Operador Laplaciano para medir calidad de imagen</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Simetr√≠a:</strong> Comparaci√≥n p√≠xel a p√≠xel horizontal y vertical</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Motion Blur:</strong> An√°lisis de gradientes direccionales</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Nivel de Ruido:</strong> Comparaci√≥n con p√≠xeles vecinos</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Varianza de Color:</strong> Dispersi√≥n crom√°tica en la imagen</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>EXIF Data:</strong> GPS, timestamp, modelo de c√°mara</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-check">‚úì</span>
                                                <span class="feature-text"><strong>Perceptual Hashing:</strong> Similitud con im√°genes conocidas</span>
                                            </div>
                                        </div>
                                        <div class="retro-note" style="margin-top: 15px; background: rgba(0, 255, 136, 0.1); border-left: 4px solid #00ff88;">
                                            <i class="bi bi-cpu"></i> <strong>PROCESAMIENTO LOCAL:</strong> An√°lisis 100% en servidor (100-500ms), sin dependencias externas
                                        </div>

                                        <!-- Nueva secci√≥n: B√∫squeda Inversa de Im√°genes -->
                                        <div class="reverse-search-section">
                                            <div class="section-header" style="margin-top: 30px;">
                                                <i class="bi bi-search"></i> B√öSQUEDA INVERSA DE IMAGEN
                                            </div>
                                            <p style="color: #c0c0c0; font-family: 'VT323', monospace; font-size: 18px; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">
                                                Verifica el origen de im√°genes o videos usando m√∫ltiples motores de b√∫squeda. Arrastra una imagen o pega una URL para buscar coincidencias en l√≠nea.
                                            </p>
                                            
                                            <!-- Input para URL de imagen -->
                                            <div class="reverse-search-input-group">
                                                <label style="font-family: 'VT323', monospace; font-size: 20px; color: #ffd700; display: block; margin-bottom: 10px;">
                                                    <i class="bi bi-link-45deg"></i> URL de la Imagen:
                                                </label>
                                                <input 
                                                    type="text" 
                                                    id="reverseSearchUrl" 
                                                    class="reverse-search-input" 
                                                    placeholder="https://ejemplo.com/imagen.jpg"
                                                >
                                            </div>

                                            <!-- Botones de motores de b√∫squeda -->
                                            <div class="reverse-search-engines">
                                                <button class="reverse-search-btn google-btn" onclick="searchOnGoogle()">
                                                    <i class="bi bi-google"></i>
                                                    <span>Google Images</span>
                                                </button>
                                                <button class="reverse-search-btn yandex-btn" onclick="searchOnYandex()">
                                                    <i class="bi bi-search"></i>
                                                    <span>Yandex</span>
                                                </button>
                                                <button class="reverse-search-btn tineye-btn" onclick="searchOnTinEye()">
                                                    <i class="bi bi-eye"></i>
                                                    <span>TinEye</span>
                                                </button>
                                            </div>

                                            <!-- Zona de drop para subir imagen -->
                                            <div class="reverse-search-dropzone" id="reverseSearchDropzone">
                                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #4a9eff; margin-bottom: 10px;"></i>
                                                <p style="font-family: 'VT323', monospace; font-size: 18px; color: #d0d0d0; margin: 0;">
                                                    Arrastra una imagen aqu√≠ o haz clic para seleccionar
                                                </p>
                                                <input type="file" id="reverseSearchFile" accept="image/*" style="display: none;">
                                            </div>

                                            <!-- Preview de la imagen -->
                                            <div id="reverseSearchPreview" style="display: none; margin-top: 20px;">
                                                <p style="font-family: 'VT323', monospace; font-size: 18px; color: #ffd700;">
                                                    <i class="bi bi-image"></i> Imagen Cargada:
                                                </p>
                                                <img id="reverseSearchPreviewImg" style="max-width: 100%; max-height: 300px; border: 2px solid #4a9eff; margin-top: 10px;">
                                            </div>
                                        </div>

                                        <div class="retro-warning">
                                            <div class="warning-icon">‚ö†Ô∏è</div>
                                            <div class="warning-text">
                                                <strong>IMPORTANTE:</strong> Para m√°xima precisi√≥n, las im√°genes deben contener datos GPS y timestamp en EXIF. Sin estos datos, la validaci√≥n externa tendr√° confianza 0%.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Footer del expediente -->
                                <div class="retro-footer">
                                    <div class="footer-left">
                                        <i class="bi bi-heart-fill"></i> Proyecto 100% gratuito y open-source
                                    </div>
                                    <div class="footer-right">
                                        <span class="classify-stamp">NIVEL DE ACCESO: P√öBLICO</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estilos Retro 80s -->
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');

                        .retro-file-container {
                            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
                            border: 3px solid #4a9eff;
                            border-radius: 0;
                            box-shadow: 
                                0 0 20px rgba(74, 158, 255, 0.5),
                                inset 0 0 50px rgba(0, 0, 0, 0.5);
                            padding: 0;
                            position: relative;
                            overflow: hidden;
                        }

                        .retro-file-container::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: 
                                repeating-linear-gradient(
                                    0deg,
                                    transparent,
                                    transparent 2px,
                                    rgba(74, 158, 255, 0.03) 2px,
                                    rgba(74, 158, 255, 0.03) 4px
                                );
                            pointer-events: none;
                            z-index: 1;
                        }

                        .retro-file-header {
                            background: linear-gradient(180deg, #1a1f3a 0%, #0a0e1a 100%);
                            padding: 25px;
                            position: relative;
                            border-bottom: 3px solid #4a9eff;
                            z-index: 2;
                        }

                        .file-stamp {
                            position: absolute;
                            top: 10px;
                            right: 20px;
                            background: #ff0000;
                            color: white;
                            padding: 5px 15px;
                            font-family: 'Press Start 2P', cursive;
                            font-size: 10px;
                            transform: rotate(15deg);
                            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
                            border: 2px solid #ffffff;
                        }

                        .file-title {
                            font-family: 'VT323', monospace;
                            font-size: 32px;
                            color: #4a9eff;
                            margin: 0;
                            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 15px rgba(74, 158, 255, 0.6);
                            letter-spacing: 2px;
                        }

                        .file-id {
                            font-family: 'VT323', monospace;
                            color: #4a9eff;
                            font-size: 18px;
                            margin-top: 5px;
                        }

                        .retro-tabs {
                            display: flex;
                            background: #0a0e1a;
                            border-bottom: 2px solid #4a9eff;
                            position: relative;
                            z-index: 2;
                        }

                        .tab-button {
                            flex: 1;
                            padding: 15px 10px;
                            font-family: 'VT323', monospace;
                            font-size: 18px;
                            color: #4a9eff;
                            background: #1a1f3a;
                            border-right: 2px solid #4a9eff;
                            cursor: pointer;
                            transition: all 0.3s;
                            text-align: center;
                        }

                        .tab-button:last-child {
                            border-right: none;
                        }

                        .tab-button:hover {
                            background: #4a9eff;
                            color: #ffffff;
                            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
                        }

                        .tab-button.active {
                            background: linear-gradient(180deg, #ff6b35 0%, #d4501d 100%);
                            color: #ffffff;
                            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.2);
                        }

                        .retro-tab-content {
                            display: none;
                            padding: 30px;
                            position: relative;
                            z-index: 2;
                            min-height: 400px;
                        }

                        .retro-tab-content.active {
                            display: block;
                            animation: fadeIn 0.5s;
                        }

                        @keyframes fadeIn {
                            from { opacity: 0; transform: translateY(10px); }
                            to { opacity: 1; transform: translateY(0); }
                        }

                        .section-header {
                            font-family: 'VT323', monospace;
                            font-size: 28px;
                            color: #ffd700;
                            border-bottom: 2px solid #4a9eff;
                            padding-bottom: 10px;
                            margin-bottom: 25px;
                            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                        }

                        .retro-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 20px;
                        }

                        .retro-item {
                            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e1a 100%);
                            border: 2px solid #4a9eff;
                            padding: 20px;
                            text-align: center;
                            transition: all 0.3s;
                            position: relative;
                        }

                        .retro-item:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 5px 20px rgba(74, 158, 255, 0.6);
                            border-color: #6bb3ff;
                        }

                        .item-icon {
                            font-size: 48px;
                            margin-bottom: 10px;
                            filter: drop-shadow(0 0 10px rgba(74, 158, 255, 0.8));
                        }

                        .item-title {
                            font-family: 'VT323', monospace;
                            font-size: 22px;
                            color: #ffd700;
                            margin: 10px 0;
                        }

        .item-desc {
            font-family: 'VT323', monospace;
            font-size: 16px;
            color: #c0c0c0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }                        .status-active {
                            color: #00ff00;
                            font-family: 'VT323', monospace;
                            margin-top: 10px;
                            font-size: 18px;
                            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
                        }

                        .confidence-bars {
                            max-width: 600px;
                            margin: 0 auto;
                        }

                        .confidence-item {
                            margin-bottom: 25px;
                        }

        .conf-label {
            font-family: 'VT323', monospace;
            font-size: 20px;
            color: #d0d0d0;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }                        .conf-bar-container {
                            background: #0a0e1a;
                            border: 2px solid #4a9eff;
                            height: 30px;
                            position: relative;
                        }

                        .conf-bar {
                            background: linear-gradient(90deg, #4a9eff 0%, #ffd700 100%);
                            height: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-family: 'Press Start 2P', cursive;
                            font-size: 12px;
                            color: #000;
                            font-weight: bold;
                            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
                            animation: loadBar 1.5s ease-out;
                        }

                        @keyframes loadBar {
                            from { width: 0; }
                        }

                        .api-list {
                            display: flex;
                            flex-direction: column;
                            gap: 15px;
                        }

                        .api-item {
                            display: flex;
                            align-items: center;
                            gap: 20px;
                            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e1a 100%);
                            border: 2px solid #4a9eff;
                            padding: 20px;
                            transition: all 0.3s;
                        }

                        .api-item:hover {
                            border-color: #6bb3ff;
                            box-shadow: 0 0 15px rgba(74, 158, 255, 0.5);
                        }

                        .api-icon {
                            font-size: 40px;
                            filter: drop-shadow(0 0 10px rgba(74, 158, 255, 0.8));
                        }

                        .api-info {
                            flex: 1;
                        }

                        .api-name {
                            font-family: 'VT323', monospace;
                            font-size: 24px;
                            color: #ffd700;
                        }

        .api-desc {
            font-family: 'VT323', monospace;
            font-size: 18px;
            color: #c0c0c0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }                        .api-status {
                            font-family: 'VT323', monospace;
                            font-size: 18px;
                            color: #00ff00;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .status-dot {
                            width: 12px;
                            height: 12px;
                            background: #00ff00;
                            border-radius: 50%;
                            box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
                            animation: pulse 2s infinite;
                        }

                        @keyframes pulse {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.5; }
                        }

                        .feature-list {
                            display: flex;
                            flex-direction: column;
                            gap: 15px;
                        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e1a 100%);
            border-left: 4px solid #00ff00;
            padding: 15px 20px;
            font-family: 'VT323', monospace;
            font-size: 20px;
            color: #d0d0d0;
            transition: all 0.3s;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .feature-item:hover {
            border-left-width: 8px;
            padding-left: 25px;
            background: linear-gradient(135deg, #2a2f4a 0%, #1a1e2a 100%);
            color: #ffffff;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.8),
                0 0 10px rgba(255, 255, 255, 0.3);
        }

        .feature-check {
                            color: #00ff00;
                            font-size: 24px;
                            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
                        }

                        /* Estilos para B√∫squeda Inversa */
                        .reverse-search-section {
                            margin-top: 30px;
                            padding: 25px;
                            background: rgba(74, 158, 255, 0.05);
                            border: 2px solid #4a9eff;
                            border-radius: 0;
                        }

                        .reverse-search-input-group {
                            margin-bottom: 20px;
                        }

                        .reverse-search-input {
                            width: 100%;
                            padding: 12px 15px;
                            background: rgba(0, 0, 0, 0.6);
                            border: 2px solid #4a9eff;
                            color: #e0e0e0;
                            font-family: 'Courier New', monospace;
                            font-size: 16px;
                            transition: all 0.3s;
                        }

                        .reverse-search-input:focus {
                            outline: none;
                            border-color: #ffd700;
                            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
                            background: rgba(0, 0, 0, 0.8);
                        }

                        .reverse-search-engines {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin-bottom: 25px;
                        }

                        .reverse-search-btn {
                            padding: 15px 20px;
                            font-family: 'VT323', monospace;
                            font-size: 1.2rem;
                            border: 2px solid;
                            border-radius: 0;
                            cursor: pointer;
                            transition: all 0.3s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 10px;
                            text-transform: uppercase;
                        }

                        .google-btn {
                            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
                            border-color: #ffd700;
                            color: #fff;
                        }

                        .google-btn:hover {
                            transform: translateY(-3px);
                            box-shadow: 0 5px 20px rgba(66, 133, 244, 0.6);
                            border-color: #fff;
                        }

                        .yandex-btn {
                            background: linear-gradient(135deg, #fc3f1d 0%, #d9231f 100%);
                            border-color: #ffd700;
                            color: #fff;
                        }

                        .yandex-btn:hover {
                            transform: translateY(-3px);
                            box-shadow: 0 5px 20px rgba(252, 63, 29, 0.6);
                            border-color: #fff;
                        }

                        .tineye-btn {
                            background: linear-gradient(135deg, #6e45e2 0%, #88d3ce 100%);
                            border-color: #ffd700;
                            color: #fff;
                        }

                        .tineye-btn:hover {
                            transform: translateY(-3px);
                            box-shadow: 0 5px 20px rgba(110, 69, 226, 0.6);
                            border-color: #fff;
                        }

                        .reverse-search-dropzone {
                            border: 3px dashed #4a9eff;
                            background: rgba(74, 158, 255, 0.05);
                            padding: 40px;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.3s;
                        }

                        .reverse-search-dropzone:hover {
                            background: rgba(74, 158, 255, 0.15);
                            border-color: #ffd700;
                        }

                        .reverse-search-dropzone.dragover {
                            background: rgba(74, 158, 255, 0.25);
                            border-color: #00ff00;
                            box-shadow: inset 0 0 30px rgba(74, 158, 255, 0.4);
                        }

                        #reverseSearchPreview {
                            margin-top: 20px;
                            padding: 15px;
                            background: rgba(0, 0, 0, 0.6);
                            border: 2px solid #4a9eff;
                            text-align: center;
                        }

                        #reverseSearchPreviewImg {
                            max-width: 100%;
                            max-height: 400px;
                            border: 2px solid #ffd700;
                            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
                        }

                        .retro-note, .retro-warning {
                            margin-top: 30px;
                            padding: 20px;
                            border: 2px solid #ffd700;
                            background: rgba(255, 215, 0, 0.1);
                            font-family: 'VT323', monospace;
                            font-size: 18px;
                            color: #ffd700;
                        }

                        .retro-warning {
                            border-color: #ff0000;
                            background: rgba(255, 0, 0, 0.1);
                            display: flex;
                            gap: 15px;
                            align-items: flex-start;
                        }

                        .warning-icon {
                            font-size: 32px;
                            flex-shrink: 0;
                        }

                        .warning-text {
                            color: #ffa07a;
                        }

                        .retro-footer {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 20px 30px;
                            background: #1a1a1a;
                            border-top: 2px solid #ff6b35;
                            font-family: 'VT323', monospace;
                            font-size: 18px;
                            color: #ffa07a;
                            position: relative;
                            z-index: 2;
                        }

                        .classify-stamp {
                            background: #ffd700;
                            color: #000;
                            padding: 5px 15px;
                            font-family: 'Press Start 2P', cursive;
                            font-size: 10px;
                            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
                        }

                        @media (max-width: 768px) {
                            .retro-tabs {
                                flex-direction: column;
                            }
                            
                            .tab-button {
                                border-right: none;
                                border-bottom: 2px solid #ff6b35;
                            }
                            
                            .retro-footer {
                                flex-direction: column;
                                gap: 15px;
                                text-align: center;
                            }
                        }
                    </style>

                    <script>
                        function openRetroTab(evt, tabName) {
                            // Ocultar todos los tabs
                            const tabcontents = document.getElementsByClassName("retro-tab-content");
                            for (let i = 0; i < tabcontents.length; i++) {
                                tabcontents[i].classList.remove("active");
                            }
                            
                            // Quitar active de todos los botones
                            const tabbuttons = document.getElementsByClassName("tab-button");
                            for (let i = 0; i < tabbuttons.length; i++) {
                                tabbuttons[i].classList.remove("active");
                            }
                            
                            // Mostrar tab seleccionado
                            document.getElementById(tabName).classList.add("active");
                            evt.currentTarget.classList.add("active");
                        }
                    </script>
                </div>

                <!-- Profile Section (Hidden by default) -->
                <div id="profileSection" style="display: none;">
                    <h3 class="mb-4">Mi Perfil</h3>
                    <div class="card p-4">
                        <div id="profileAlertContainer"></div>
                        
                        <form id="profileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="profileFirstName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Apellido</label>
                                    <input type="text" class="form-control" id="profileLastName" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="profileUsername" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profileEmail" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tel√©fono</label>
                                    <input type="tel" class="form-control" id="profilePhone">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Pa√≠s</label>
                                    <input type="text" class="form-control" id="profileCountry">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Biograf√≠a</label>
                                <textarea class="form-control" id="profileBio" rows="3"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Guardar Cambios
                            </button>
                        </form>

                        <hr class="my-4">

                        <h5>Cambiar Contrase√±a</h5>
                        <form id="changePasswordForm" class="mt-3">
                            <div class="mb-3">
                                <label class="form-label">Contrase√±a Actual</label>
                                <input type="password" class="form-control" id="currentPassword" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nueva Contrase√±a</label>
                                <input type="password" class="form-control" id="newPassword" required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-key"></i> Cambiar Contrase√±a
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Other sections placeholders -->
                <div id="uploadsSection" style="display: none;">
                    <h3 class="mb-4">Subir An√°lisis</h3>
                    
                    <div class="card p-4 mb-4">
                        <h5><i class="bi bi-cloud-upload"></i> Subir Imagen o Video</h5>
                        <p class="text-muted">Sube una foto o video de tu avistamiento UAP para analizarlo.</p>
                        
                        <div id="uploadAlertContainer"></div>
                        
                        <form id="uploadForm">
                            <!-- Paso 1: Archivo -->
                            <div class="mb-4">
                                <h5><i class="bi bi-1-circle"></i> Seleccionar Archivo</h5>
                                <div class="mb-3">
                                    <label class="form-label">Imagen o video del avistamiento</label>
                                    <input 
                                        type="file" 
                                        class="form-control" 
                                        id="fileInput" 
                                        accept="image/*,video/*"
                                        required
                                    >
                                    <small class="text-muted">
                                        Formatos: JPG, PNG, GIF, WEBP, MP4, MOV, AVI, WEBM | M√°ximo: 50MB
                                    </small>
                                </div>
                                
                                <!-- Preview -->
                                <div id="previewContainer" style="display: none;" class="mb-3">
                                    <label class="form-label">Vista previa:</label>
                                    <div id="previewContent"></div>
                                </div>
                            </div>

                            <!-- Paso 2: Contexto del Avistamiento -->
                            <div class="mb-4 border-top pt-4">
                                <h5><i class="bi bi-2-circle"></i> Informaci√≥n del Avistamiento</h5>
                                <p class="text-muted small">Esta informaci√≥n mejora significativamente la precisi√≥n del an√°lisis.</p>

                                <div class="row">
                                    <!-- Movimiento -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Tipo de movimiento observado</label>
                                        <select class="form-select" id="contextMovement">
                                            <option value="no observado">No observado / No recuerdo</option>
                                            <option value="est√°tico">Est√°tico (sin movimiento)</option>
                                            <option value="lento">Lento y constante</option>
                                            <option value="moderado">Moderado</option>
                                            <option value="r√°pido">R√°pido</option>
                                            <option value="muy r√°pido">Muy r√°pido</option>
                                            <option value="err√°tico">Err√°tico (impredecible)</option>
                                            <option value="zigzag">Zigzag</option>
                                            <option value="circular">Circular</option>
                                        </select>
                                    </div>

                                    <!-- Velocidad -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Velocidad estimada (1-5)</label>
                                        <input type="range" class="form-range" id="contextSpeed" min="1" max="5" value="3">
                                        <div class="d-flex justify-content-between">
                                            <small>Muy lento</small>
                                            <small id="speedValue">Normal</small>
                                            <small>Muy r√°pido</small>
                                        </div>
                                    </div>

                                    <!-- Altura -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Altura estimada</label>
                                        <select class="form-select" id="contextAltitude">
                                            <option value="no determinada">No determinada</option>
                                            <option value="muy baja">Muy baja (< 100m)</option>
                                            <option value="baja">Baja (100-500m)</option>
                                            <option value="media">Media (500-3000m)</option>
                                            <option value="alta">Alta (3000-10000m)</option>
                                            <option value="muy alta">Muy alta (> 10000m)</option>
                                        </select>
                                    </div>

                                    <!-- Color de luz -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Color(es) de luz observado(s)</label>
                                        <select class="form-select" id="contextLightColor" multiple size="3">
                                            <option value="sin luz visible" selected>Sin luz visible</option>
                                            <option value="blanco">Blanco</option>
                                            <option value="amarillo">Amarillo</option>
                                            <option value="naranja">Naranja</option>
                                            <option value="rojo">Rojo</option>
                                            <option value="verde">Verde</option>
                                            <option value="azul">Azul</option>
                                            <option value="p√∫rpura">P√∫rpura</option>
                                            <option value="multicolor">Multicolor</option>
                                        </select>
                                        <small class="text-muted">Mant√©n Ctrl para seleccionar m√∫ltiples</small>
                                    </div>

                                    <!-- Intensidad luz -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Intensidad de la luz</label>
                                        <select class="form-select" id="contextLightIntensity">
                                            <option value="sin luz">Sin luz</option>
                                            <option value="tenue">Tenue</option>
                                            <option value="media" selected>Media</option>
                                            <option value="brillante">Brillante</option>
                                            <option value="muy brillante">Muy brillante</option>
                                            <option value="cegadora">Cegadora</option>
                                            <option value="parpadeante">Parpadeante</option>
                                            <option value="intermitente">Intermitente</option>
                                        </select>
                                    </div>

                                    <!-- Sonido -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Sonido escuchado</label>
                                        <select class="form-select" id="contextSound">
                                            <option value="sin sonido" selected>Sin sonido</option>
                                            <option value="zumbido">Zumbido</option>
                                            <option value="silbido">Silbido</option>
                                            <option value="motor">Motor</option>
                                            <option value="explosi√≥n">Explosi√≥n</option>
                                            <option value="otro">Otro (especificar abajo)</option>
                                        </select>
                                    </div>

                                    <!-- Duraci√≥n -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Duraci√≥n del avistamiento</label>
                                        <input type="text" class="form-control" id="contextDuration" placeholder="Ej: 30 segundos, 5 minutos">
                                    </div>

                                    <!-- Clima -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Condiciones clim√°ticas</label>
                                        <select class="form-select" id="contextWeather">
                                            <option value="no recuerdo">No recuerdo</option>
                                            <option value="despejado" selected>Despejado</option>
                                            <option value="parcialmente nublado">Parcialmente nublado</option>
                                            <option value="nublado">Nublado</option>
                                            <option value="lluvia">Lluvia</option>
                                            <option value="tormenta">Tormenta</option>
                                            <option value="niebla">Niebla</option>
                                        </select>
                                    </div>

                                    <!-- Actividad testigo -->
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">¬øQu√© estaba haciendo en el momento del avistamiento?</label>
                                        <input type="text" class="form-control" id="contextActivity" placeholder="Ej: caminando, conduciendo, observando el cielo...">
                                    </div>
                                </div>
                            </div>

                            <!-- Paso 3: Contexto Personal -->
                            <div class="mb-4 border-top pt-4">
                                <h5><i class="bi bi-3-circle"></i> Contexto Personal (Opcional pero Importante)</h5>
                                <p class="text-muted small">Esta informaci√≥n ayuda a evaluar la credibilidad y contexto del testimonio.</p>

                                <div class="row">
                                    <!-- Consumo sustancias -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">¬øHab√≠a consumido alcohol o sustancias?</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="substanceUse" id="substanceNo" value="false" checked>
                                            <label class="form-check-label" for="substanceNo">No</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="substanceUse" id="substanceYes" value="true">
                                            <label class="form-check-label" for="substanceYes">S√≠</label>
                                        </div>
                                    </div>

                                    <!-- Creencias -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Su nivel de creencia en OVNIs</label>
                                        <select class="form-select" id="contextBelief">
                                            <option value="muy esc√©ptico">Muy esc√©ptico</option>
                                            <option value="esc√©ptico">Esc√©ptico</option>
                                            <option value="neutral" selected>Neutral</option>
                                            <option value="creyente">Creyente</option>
                                            <option value="muy creyente">Muy creyente</option>
                                        </select>
                                    </div>

                                    <!-- Acompa√±ado -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">¬øEstaba acompa√±ado?</label>
                                        <select class="form-select" id="contextAccompanied" onchange="toggleWitnessCount()">
                                            <option value="false" selected>Solo</option>
                                            <option value="true">Acompa√±ado</option>
                                        </select>
                                        <input type="number" class="form-control mt-2" id="contextWitnessCount" min="1" max="100" value="1" placeholder="N√∫mero de testigos" style="display: none;">
                                    </div>

                                    <!-- Estado emocional -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Estado emocional durante el avistamiento</label>
                                        <select class="form-select" id="contextEmotional">
                                            <option value="calmado">Calmado</option>
                                            <option value="curioso" selected>Curioso</option>
                                            <option value="asustado">Asustado</option>
                                            <option value="emocionado">Emocionado</option>
                                            <option value="confundido">Confundido</option>
                                            <option value="otro">Otro</option>
                                        </select>
                                    </div>

                                    <!-- Avistamientos previos -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">¬øHa tenido avistamientos previos?</label>
                                        <select class="form-select" id="contextPreviousSightings" onchange="togglePreviousCount()">
                                            <option value="false" selected>No</option>
                                            <option value="true">S√≠</option>
                                        </select>
                                        <input type="number" class="form-control mt-2" id="contextPreviousCount" min="1" max="100" placeholder="N√∫mero de avistamientos previos" style="display: none;">
                                    </div>

                                    <!-- Descripci√≥n del incidente -->
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Descripci√≥n detallada del suceso</label>
                                        <textarea class="form-control" id="contextDescription" rows="4" placeholder="Describa con el mayor detalle posible lo que vio, sinti√≥ y experiment√≥ durante el avistamiento..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Barra de progreso -->
                            <div id="progressContainer" style="display: none;" class="mb-3">
                                <div class="progress">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="progressText" class="text-muted"></small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                <i class="bi bi-cloud-upload"></i> Subir y Analizar
                            </button>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> El an√°lisis comenzar√° autom√°ticamente tras la subida
                            </small>
                        </form>
                    </div>
                    
                    <!-- Resultados del An√°lisis y Descargas -->
                    <div id="analysisResultsCard" class="card p-4 mb-4" style="display: none;">
                        <h5><i class="bi bi-graph-up"></i> Resultados del An√°lisis</h5>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <i class="bi bi-eye-fill" style="font-size: 2rem; color: #0d6efd;"></i>
                                        <h6 class="mt-3">Previsualizar PDF</h6>
                                        <p class="text-muted small">Ver un resumen del an√°lisis en formato PDF</p>
                                        <button class="btn btn-outline-primary btn-sm" id="previewPdfBtn" onclick="previewAnalysisPDF()">
                                            <i class="bi bi-file-earmark-pdf"></i> Previsualizar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <i class="bi bi-download" style="font-size: 2rem; color: #28a745;"></i>
                                        <h6 class="mt-3">Descargar Reporte</h6>
                                        <p class="text-muted small">Descargar el reporte completo del an√°lisis</p>
                                        <button class="btn btn-outline-success btn-sm" id="downloadReportBtn" onclick="downloadAnalysisReport()">
                                            <i class="bi bi-file-earmark-pdf"></i> Descargar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="analysisStatsContainer" class="mt-4"></div>
                    </div>
                    
                    <!-- Lista de uploads -->
                    <div class="card p-4">
                        <h5><i class="bi bi-list"></i> Mis Uploads</h5>
                        <div id="uploadsListContainer">
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Cargando...
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reportsSection" style="display: none;">
                    <h3 class="mb-4"><i class="bi bi-file-earmark-text"></i> Mis Reportes</h3>
                    
                    <!-- Filtros -->
                    <div class="card p-3 mb-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small">Filtrar por categor√≠a</label>
                                <select class="form-select form-select-sm" id="filterCategory">
                                    <option value="">Todas las categor√≠as</option>
                                    <option value="celestial">Celestial</option>
                                    <option value="aircraft">Aeronave</option>
                                    <option value="satellite">Sat√©lite</option>
                                    <option value="drone">Drone</option>
                                    <option value="balloon">Globo</option>
                                    <option value="bird">Ave</option>
                                    <option value="natural">Natural</option>
                                    <option value="uap">UAP</option>
                                    <option value="unknown">Desconocido</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Filtrar por estado</label>
                                <select class="form-select form-select-sm" id="filterStatus">
                                    <option value="">Todos los estados</option>
                                    <option value="completed">Completado</option>
                                    <option value="analyzing">Analizando</option>
                                    <option value="pending">Pendiente</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Buscar</label>
                                <input type="text" class="form-control form-control-sm" id="searchReports" placeholder="Buscar por nombre...">
                            </div>
                        </div>
                        <div class="mt-3 text-end">
                            <button class="btn btn-sm btn-primary" onclick="loadReports()">
                                <i class="bi bi-funnel"></i> Aplicar Filtros
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                    </div>

                    <!-- Estad√≠sticas R√°pidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h4 class="mb-0" id="totalReports">0</h4>
                                <small class="text-muted">Total An√°lisis</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h4 class="mb-0" id="completedReports">0</h4>
                                <small class="text-muted">Completados</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h4 class="mb-0" id="uapReports">0</h4>
                                <small class="text-muted">UAP Detectados</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h4 class="mb-0" id="avgConfidence">0%</h4>
                                <small class="text-muted">Confianza Promedio</small>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Reportes -->
                    <div class="card p-4">
                        <div id="reportsListContainer">
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Cargando reportes...
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Library Admin Section (ADMIN ONLY) -->
                <div id="libraryAdminSection" style="display: none;" class="admin-only">
                    <h3 class="mb-4"><i class="bi bi-book-half"></i> Administraci√≥n de Biblioteca Visual</h3>
                    
                    <p class="text-muted mb-4">
                        Gestiona objetos en la biblioteca visual. Los objetos creados aqu√≠ se sincronizan autom√°ticamente con el sistema de entrenamiento.
                    </p>

                    <!-- Add Object Card -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-plus-circle"></i> A√±adir Objeto Manual</h5>
                        </div>
                        <div class="card-body">
                            <form id="libraryObjectForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Nombre del Objeto *</label>
                                        <input type="text" class="form-control" id="libraryName" required
                                               placeholder="Ej: Boeing 737-800, Luna Llena, Esfera Met√°lica">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Categor√≠a *</label>
                                        <select class="form-select" id="libraryCategory" required>
                                            <option value="">Seleccione...</option>
                                            <option value="aircraft">Aeronave</option>
                                            <option value="drone">Drone</option>
                                            <option value="satellite">Sat√©lite</option>
                                            <option value="balloon">Globo/Dirigible</option>
                                            <option value="celestial">Objeto Celeste</option>
                                            <option value="natural">Fen√≥meno Natural</option>
                                            <option value="bird">Ave/Fauna</option>
                                            <option value="hoax">Fake/Hoax</option>
                                            <option value="uap">UAP/OVNI</option>
                                            <option value="unknown">Desconocido</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tipolog√≠a/Subtipo</label>
                                    <input type="text" class="form-control" id="libraryTypology"
                                           placeholder="Ej: Avi√≥n comercial, Imagen generada por IA, Sat√©lite artificial">
                                    <div class="form-text">Subtipo espec√≠fico del objeto (opcional pero recomendado)</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Descripci√≥n Detallada *</label>
                                    <textarea class="form-control" id="libraryDescription" rows="4" required
                                              placeholder="Describe caracter√≠sticas visuales, comportamiento, colores, formas, patrones de luz, movimiento t√≠pico..."></textarea>
                                    <div class="form-text">Cuanto m√°s detallada, mejor ser√° el matching</div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Palabras Clave (Keywords)</label>
                                        <input type="text" class="form-control" id="libraryKeywords"
                                               placeholder="metal, esf√©rico, brillante, plateado (separadas por comas)">
                                        <div class="form-text">M√°ximo 20 keywords para matching</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Patrones Visuales</label>
                                        <input type="text" class="form-control" id="libraryVisualPatterns"
                                               placeholder="circular, luminoso, est√°tico (separadas por comas)">
                                        <div class="form-text">Tags descriptivos para comparaci√≥n visual</div>
                                    </div>
                                </div>

                                <!-- Caracter√≠sticas -->
                                <div class="card mb-3 bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3"><i class="bi bi-sliders"></i> Caracter√≠sticas (Opcional)</h6>
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label small">Forma</label>
                                                <select class="form-select form-select-sm" id="libraryShape">
                                                    <option value="">N/A</option>
                                                    <option value="circular">Circular</option>
                                                    <option value="oval">Oval</option>
                                                    <option value="triangular">Triangular</option>
                                                    <option value="rectangular">Rectangular</option>
                                                    <option value="irregular">Irregular</option>
                                                    <option value="cylindrical">Cil√≠ndrico</option>
                                                    <option value="point">Punto</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label small">Tama√±o</label>
                                                <select class="form-select form-select-sm" id="librarySize">
                                                    <option value="">N/A</option>
                                                    <option value="muy peque√±o">Muy Peque√±o</option>
                                                    <option value="peque√±o">Peque√±o</option>
                                                    <option value="mediano">Mediano</option>
                                                    <option value="grande">Grande</option>
                                                    <option value="muy grande">Muy Grande</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label small">Velocidad</label>
                                                <select class="form-select form-select-sm" id="librarySpeed">
                                                    <option value="">N/A</option>
                                                    <option value="est√°tico">Est√°tico</option>
                                                    <option value="lento">Lento</option>
                                                    <option value="moderado">Moderado</option>
                                                    <option value="r√°pido">R√°pido</option>
                                                    <option value="muy r√°pido">Muy R√°pido</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label small">Luminosidad</label>
                                                <select class="form-select form-select-sm" id="libraryLuminosity">
                                                    <option value="">N/A</option>
                                                    <option value="sin luz">Sin Luz</option>
                                                    <option value="tenue">Tenue</option>
                                                    <option value="media">Media</option>
                                                    <option value="brillante">Brillante</option>
                                                    <option value="muy brillante">Muy Brillante</option>
                                                    <option value="intermitente">Intermitente</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small">Colores</label>
                                                <input type="text" class="form-control form-control-sm" id="libraryColors"
                                                       placeholder="blanco, rojo, azul (separados por comas)">
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small">Comportamiento</label>
                                                <input type="text" class="form-control form-control-sm" id="libraryBehavior"
                                                       placeholder="vuelo rectil√≠neo, estacionario, err√°tico">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Im√°genes -->
                                <div class="mb-3">
                                    <label class="form-label">Im√°genes de Referencia (m√°x 5)</label>
                                    <input type="file" class="form-control" id="libraryImages" accept="image/*" multiple>
                                    <div class="form-text">JPG, PNG o WEBP. M√°x. 10MB por imagen</div>
                                </div>

                                <!-- Preview de im√°genes -->
                                <div id="libraryImagesPreview" class="row mb-3" style="display: none;"></div>

                                <div id="libraryFormMsg" class="mb-3"></div>

                                <div class="text-end">
                                    <button type="reset" class="btn btn-secondary">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-plus-circle"></i> Crear Objeto
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Objects List -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Todos los Objetos de Biblioteca (<span id="libraryTotalCount">0</span>)</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadLibraryObjects()">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Filtros y B√∫squeda -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" class="form-control form-control-sm" id="librarySearchBox"
                                           placeholder="üîç Buscar por nombre o descripci√≥n..." 
                                           onkeyup="searchLibraryObjects()">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="libraryFilterCategory" onchange="loadLibraryObjects()">
                                        <option value="">Todas las categor√≠as</option>
                                        <option value="aircraft">Aeronaves</option>
                                        <option value="drone">Drones</option>
                                        <option value="satellite">Sat√©lites</option>
                                        <option value="balloon">Globos</option>
                                        <option value="celestial">Objetos Celestes</option>
                                        <option value="natural">Fen√≥menos Naturales</option>
                                        <option value="bird">Aves</option>
                                        <option value="hoax">Fake/Hoax</option>
                                        <option value="uap">UAP/OVNI</option>
                                        <option value="unknown">Desconocidos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" id="libraryFilterManual" onchange="loadLibraryObjects()">
                                        <option value="">Todos</option>
                                        <option value="true">Solo Manuales</option>
                                        <option value="false">Solo Originales</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="libraryPageSize" onchange="loadLibraryObjects()">
                                        <option value="10">10 por p√°gina</option>
                                        <option value="25" selected>25 por p√°gina</option>
                                        <option value="50">50 por p√°gina</option>
                                        <option value="100">100 por p√°gina</option>
                                    </select>
                                </div>
                            </div>

                            <div id="libraryObjectsContainer">
                                <div class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Paginaci√≥n -->
                            <nav id="libraryPagination" class="mt-3"></nav>
                        </div>
                    </div>
                </div>

                <!-- Modal para Editar Objeto de Biblioteca -->
                <div class="modal fade" id="editLibraryModal" tabindex="-1" aria-labelledby="editLibraryModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Editar Objeto de Biblioteca</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editLibraryForm">
                                    <input type="hidden" id="editLibraryId">
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nombre del Objeto *</label>
                                            <input type="text" class="form-control" id="editLibraryName" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Categor√≠a *</label>
                                            <select class="form-select" id="editLibraryCategory" required>
                                                <option value="aircraft">Aeronave</option>
                                                <option value="drone">Drone</option>
                                                <option value="satellite">Sat√©lite</option>
                                                <option value="balloon">Globo/Dirigible</option>
                                                <option value="celestial">Objeto Celeste</option>
                                                <option value="natural">Fen√≥meno Natural</option>
                                                <option value="bird">Ave/Fauna</option>
                                                <option value="hoax">Fake/Hoax</option>
                                                <option value="uap">UAP/OVNI</option>
                                                <option value="unknown">Desconocido</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Tipolog√≠a/Subtipo</label>
                                        <input type="text" class="form-control" id="editLibraryTypology">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Descripci√≥n Detallada *</label>
                                        <textarea class="form-control" id="editLibraryDescription" rows="4" required></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Palabras Clave (Keywords)</label>
                                        <input type="text" class="form-control" id="editLibraryKeywords"
                                               placeholder="separadas por comas (m√°x 20)">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Patrones Visuales</label>
                                        <input type="text" class="form-control" id="editLibraryVisualPatterns"
                                               placeholder="separados por comas">
                                    </div>

                                    <!-- Caracter√≠sticas -->
                                    <div class="card mb-3 bg-light">
                                        <div class="card-body">
                                            <h6 class="mb-3">Caracter√≠sticas</h6>
                                            <div class="row">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small">Forma</label>
                                                    <select class="form-select form-select-sm" id="editLibraryShape">
                                                        <option value="">N/A</option>
                                                        <option value="circular">Circular</option>
                                                        <option value="oval">Oval</option>
                                                        <option value="triangular">Triangular</option>
                                                        <option value="rectangular">Rectangular</option>
                                                        <option value="irregular">Irregular</option>
                                                        <option value="cylindrical">Cil√≠ndrico</option>
                                                        <option value="point">Punto</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small">Tama√±o</label>
                                                    <input type="text" class="form-control form-control-sm" id="editLibrarySize">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small">Velocidad</label>
                                                    <input type="text" class="form-control form-control-sm" id="editLibrarySpeed">
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label small">Luminosidad</label>
                                                    <input type="text" class="form-control form-control-sm" id="editLibraryLuminosity">
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label small">Colores</label>
                                                    <input type="text" class="form-control form-control-sm" id="editLibraryColors">
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label small">Comportamiento</label>
                                                    <input type="text" class="form-control form-control-sm" id="editLibraryBehavior">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Agregar nuevas im√°genes -->
                                    <div class="mb-3">
                                        <label class="form-label">Agregar Nuevas Im√°genes (m√°x 5)</label>
                                        <input type="file" class="form-control" id="editLibraryNewImages" accept="image/*" multiple>
                                        <div class="form-text">Se agregar√°n a las im√°genes existentes</div>
                                    </div>

                                    <!-- Im√°genes existentes -->
                                    <div id="editLibraryExistingImages" class="mb-3"></div>

                                    <div id="editLibraryFormMsg" class="mb-3"></div>

                                    <div class="text-end">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle"></i> Guardar Cambios
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Site Configuration Section (ADMIN ONLY) -->
                <div id="siteConfigSection" style="display: none;" class="admin-only">
                    <h3 class="mb-4"><i class="bi bi-gear-fill"></i> Configuraci√≥n del Sitio</h3>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Aqu√≠ puedes modificar los enlaces y configuraciones globales del sitio.
                    </div>

                    <!-- Config Cards -->
                    <div class="row">
                        <!-- Donation URL -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header" style="background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%); color: #4a9eff; border-bottom: 2px solid #4a9eff;">
                                    <h5 class="mb-0"><i class="bi bi-heart-fill"></i> URL de Donaci√≥n</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small">
                                        URL a la que redirige el bot√≥n "Donar". Generalmente un enlace de PayPal, Ko-fi, etc.
                                    </p>
                                    <div class="mb-3">
                                        <label class="form-label">URL Actual:</label>
                                        <input type="url" class="form-control" id="donationUrlInput" 
                                               placeholder="https://paypal.me/tuusuario">
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="updateConfig('donation_url')">
                                        <i class="bi bi-save"></i> Guardar URL de Donaci√≥n
                                    </button>
                                    <div id="donationUrlMsg" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Website URL -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header" style="background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%); color: #4a9eff; border-bottom: 2px solid #4a9eff;">
                                    <h5 class="mb-0"><i class="bi bi-globe"></i> URL del Sitio Web</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small">
                                        URL de tu sitio web principal. Se muestra en el enlace "Nuestra Web".
                                    </p>
                                    <div class="mb-3">
                                        <label class="form-label">URL Actual:</label>
                                        <input type="url" class="form-control" id="websiteUrlInput" 
                                               placeholder="https://www.ovniesp.com">
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="updateConfig('website_url')">
                                        <i class="bi bi-save"></i> Guardar URL del Sitio
                                    </button>
                                    <div id="websiteUrlMsg" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%); color: #ffd700; border-bottom: 2px solid #ffd700;">
                            <h5 class="mb-0"><i class="bi bi-eye"></i> Vista Previa</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Los cambios se aplicar√°n inmediatamente en toda la aplicaci√≥n.</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Bot√≥n Donar:</strong>
                                    <div class="mt-2">
                                        <a href="#" id="previewDonateLink" class="btn btn-danger btn-sm" target="_blank">
                                            <i class="bi bi-heart-fill"></i> Donar (Preview)
                                        </a>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <strong>Enlace Web:</strong>
                                    <div class="mt-2">
                                        <a href="#" id="previewWebsiteLink" class="btn btn-info btn-sm" target="_blank">
                                            <i class="bi bi-globe"></i> Nuestra Web (Preview)
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Initialize Button -->
                    <div class="mt-4">
                        <button class="btn btn-warning" onclick="initializeConfigs()">
                            <i class="bi bi-arrow-repeat"></i> Inicializar Configuraciones por Defecto
                        </button>
                    </div>
                </div>

                <!-- Donate Section -->
                <div id="donateSection" style="display: none;">
                    <h3 class="mb-4"><i class="bi bi-heart-fill text-danger"></i> Apoya el Proyecto</h3>
                    
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="card p-4 shadow-sm">
                                <div class="text-center mb-4">
                                    <i class="bi bi-rocket-takeoff" style="font-size: 64px; color: #0d6efd;"></i>
                                    <h4 class="mt-3">UAP Analysis System</h4>
                                    <p class="text-muted">Un proyecto open-source para la investigaci√≥n de fen√≥menos a√©reos no identificados</p>
                                </div>

                                <div class="alert alert-info">
                                    <h5><i class="bi bi-info-circle"></i> ¬øPor qu√© donar?</h5>
                                    <ul class="mb-0">
                                        <li>üöÄ Mantener los servidores y servicios activos</li>
                                        <li>ü§ñ Cubrir costos de APIs de IA (cuando sea necesario)</li>
                                        <li>üíª Desarrollo de nuevas funcionalidades</li>
                                        <li>üìö Documentaci√≥n y soporte a la comunidad</li>
                                        <li>üî¨ Investigaci√≥n y mejora de algoritmos de detecci√≥n</li>
                                    </ul>
                                </div>

                                <div class="text-center my-4">
                                    <h5 class="mb-3">Dona con PayPal</h5>
                                    <p class="text-muted small mb-3">Cualquier cantidad es bienvenida y apreciada</p>
                                    
                                    <!-- Bot√≥n de Donaci√≥n -->
                                    <a href="https://paypal.me/tuusuario" target="_blank" id="donateButton" class="paypal-button">
                                        <i class="bi bi-paypal"></i> Donar con PayPal
                                    </a>

                                    <p class="text-muted small mt-3">
                                        <i class="bi bi-shield-check"></i> Pago seguro procesado por PayPal
                                    </p>
                                </div>

                                <hr>

                                <div class="mt-4">
                                    <h5><i class="bi bi-github"></i> Otras formas de contribuir</h5>
                                    <ul>
                                        <li><strong>GitHub:</strong> Contribuye con c√≥digo, reporta bugs o sugiere mejoras</li>
                                        <li><strong>Documentaci√≥n:</strong> Ayuda a mejorar la documentaci√≥n del proyecto</li>
                                        <li><strong>Difusi√≥n:</strong> Comparte el proyecto con otros investigadores</li>
                                        <li><strong>Datos:</strong> Aporta im√°genes de calidad para entrenar modelos</li>
                                    </ul>
                                    
                                    <div class="text-center mt-3">
                                        <a href="https://github.com/ufoteoria-sudo/PROYECT-OVNI-ESP" target="_blank" class="btn btn-dark">
                                            <i class="bi bi-github"></i> Ver en GitHub
                                        </a>
                                    </div>
                                </div>

                                <div class="alert alert-success mt-4">
                                    <strong><i class="bi bi-heart-fill"></i> ¬°Gracias por tu apoyo!</strong><br>
                                    Cada contribuci√≥n nos ayuda a mantener este proyecto abierto y gratuito para todos.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client - Cargar ANTES del script principal -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        const API_URL = 'http://localhost:3000';
        let currentUser = null;
        let socket = null;
        const activeAnalysis = new Map(); // Almacenar an√°lisis activos
        let currentAnalysisData = null; // Guardar datos del an√°lisis actual para PDF

        // ========== WEBSOCKET CONNECTION ==========
        function initializeWebSocket() {
            if (!socket) {
                socket = io(API_URL, {
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    console.log('üîå WebSocket conectado:', socket.id);
                });

                socket.on('disconnect', () => {
                    console.log('‚ùå WebSocket desconectado');
                });

                socket.on('error', (error) => {
                    console.error('‚ö†Ô∏è Error WebSocket:', error);
                });
                
                // üì° Listeners para sincronizaci√≥n de biblioteca
                socket.on('library:object-created', (event) => {
                    console.log('üì° Admin: Objeto creado', event.data);
                    showLibraryNotification(`‚úÖ Nuevo objeto: ${event.data.name}`);
                });
                
                socket.on('library:object-updated', (event) => {
                    console.log('üì° Admin: Objeto actualizado', event.data);
                    showLibraryNotification(`‚úèÔ∏è Objeto actualizado: ${event.data.name}`);
                });
                
                socket.on('library:object-deleted', (event) => {
                    console.log('üì° Admin: Objeto eliminado', event.data);
                    showLibraryNotification(`üóëÔ∏è Objeto eliminado: ${event.data.name}`);
                });
                
                socket.on('library:phenomenon-created', (event) => {
                    console.log('üì° Admin: Fen√≥meno creado', event.data);
                    showLibraryNotification(`‚úÖ Nuevo fen√≥meno: ${event.data.name}`);
                });
                
                socket.on('library:phenomenon-updated', (event) => {
                    console.log('üì° Admin: Fen√≥meno actualizado', event.data);
                    showLibraryNotification(`‚úèÔ∏è Fen√≥meno actualizado: ${event.data.name}`);
                });
                
                socket.on('library:phenomenon-deleted', (event) => {
                    console.log('üì° Admin: Fen√≥meno eliminado', event.data);
                    showLibraryNotification(`üóëÔ∏è Fen√≥meno eliminado: ${event.data.name}`);
                });
            }
        }

        // Suscribirse a eventos de un an√°lisis espec√≠fico
        function subscribeToAnalysis(analysisId) {
            if (!socket) {
                console.warn('WebSocket no inicializado');
                return;
            }

            const channel = `analysis:${analysisId}`;
            console.log('üì° Suscrito a canal:', channel);

            // Escuchar evento de inicio
            socket.on(channel, (event) => {
                console.log('üì® Evento recibido:', event);

                switch(event.type) {
                    case 'started':
                        handleAnalysisStarted(analysisId, event);
                        break;
                    case 'progress':
                        handleAnalysisProgress(analysisId, event);
                        break;
                    case 'layer_complete':
                        handleLayerComplete(analysisId, event);
                        break;
                    case 'complete':
                        handleAnalysisComplete(analysisId, event);
                        break;
                    case 'error':
                        handleAnalysisError(analysisId, event);
                        break;
                }
            });

            activeAnalysis.set(analysisId, { startTime: Date.now() });
        }

        // Handlers de eventos WebSocket
        function handleAnalysisStarted(analysisId, event) {
            console.log(`‚úÖ An√°lisis iniciado: ${analysisId}`);
            showUploadAlert('An√°lisis iniciado en tiempo real...', 'info');
            // Mostrar barra de progreso si existe
            updateProgressBar(analysisId, 0, 'Iniciando an√°lisis');
        }

        function handleAnalysisProgress(analysisId, event) {
            console.log(`üìä Progreso ${event.progress}%: ${event.currentLayer}`);
            updateProgressBar(analysisId, event.progress, event.currentLayer);
        }

        function handleLayerComplete(analysisId, event) {
            console.log(`‚úÖ Capa ${event.layer.number} completada: ${event.layer.name}`);
            showLayerNotification(event.layer);
        }

        function handleAnalysisComplete(analysisId, event) {
            console.log(`üéâ An√°lisis completado: ${analysisId}`);
            activeAnalysis.delete(analysisId);
            updateProgressBar(analysisId, 100, 'Completado');
            showUploadAlert('¬°An√°lisis completado con √©xito!', 'success');
            
            // Recargar lista despu√©s de 1 segundo
            setTimeout(() => {
                loadUploads();
            }, 1000);
        }

        function handleAnalysisError(analysisId, event) {
            console.error(`‚ùå Error en an√°lisis ${analysisId}:`, event.error);
            activeAnalysis.delete(analysisId);
            updateProgressBar(analysisId, 0, 'Error');
            showUploadAlert(`Error: ${event.error.message}`, 'danger');
            loadUploads();
        }

        // Actualizar barra de progreso
        function updateProgressBar(analysisId, progress, message) {
            const row = document.querySelector(`tr[data-analysis-id="${analysisId}"]`);
            if (!row) return;

            // Buscar o crear contenedor de progreso
            let progressContainer = row.querySelector('.progress-container');
            if (!progressContainer) {
                const statusCell = row.querySelector('td:nth-child(3)'); // Columna de estado
                if (!statusCell) return;
                
                progressContainer = document.createElement('div');
                progressContainer.className = 'progress-container';
                progressContainer.innerHTML = `
                    <div class="progress mb-1" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: ${progress}%">
                            ${progress}%
                        </div>
                    </div>
                    <small class="text-muted progress-message">${message}</small>
                `;
                statusCell.innerHTML = '';
                statusCell.appendChild(progressContainer);
            } else {
                // Actualizar progreso existente
                const bar = progressContainer.querySelector('.progress-bar');
                const msg = progressContainer.querySelector('.progress-message');
                if (bar) {
                    bar.style.width = `${progress}%`;
                    bar.textContent = `${progress}%`;
                }
                if (msg) msg.textContent = message;
            }
        }

        // Mostrar notificaci√≥n de capa completada
        function showLayerNotification(layer) {
            // Usar toast de Bootstrap si est√° disponible
            const toastHtml = `
                <div class="toast align-items-center text-white bg-info border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ‚úÖ Capa ${layer.number}: ${layer.name}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            // Crear contenedor si no existe
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '11';
                document.body.appendChild(toastContainer);
            }
            
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);
            
            const toast = new bootstrap.Toast(toastElement.firstElementChild, { delay: 3000 });
            toast.show();
        }

        // ========== FIN WEBSOCKET ==========

        // Verificar autenticaci√≥n
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token inv√°lido');
                }

                const data = await response.json();
                // El backend devuelve { user: {...} }
                currentUser = data.user || data;
                console.log('üîê Usuario cargado desde /me:', currentUser);
                displayUserInfo();
                loadProfileData();
                loadDashboardStats(); // Cargar estad√≠sticas al iniciar

            } catch (error) {
                console.error('Error:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        function displayUserInfo() {
            if (!currentUser) return;

            console.log('üë§ Usuario actual:', currentUser);
            console.log('üîë Rol:', currentUser.role);

            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userFirstName').textContent = currentUser.firstName || currentUser.username;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usuario';
            
            // Mostrar/ocultar elementos de administrador
            const adminElements = document.querySelectorAll('.admin-only');
            console.log('üîç Elementos admin encontrados:', adminElements.length);
            
            if (currentUser.role === 'admin') {
                console.log('‚úÖ Usuario es admin - mostrando elementos');
                adminElements.forEach(el => {
                    console.log('  Mostrando elemento:', el);
                    el.style.removeProperty('display');
                });
            } else {
                console.log('‚ùå Usuario NO es admin - ocultando elementos');
                adminElements.forEach(el => {
                    el.style.display = 'none';
                });
            }
        }

        function loadProfileData() {
            if (!currentUser) return;

            document.getElementById('profileFirstName').value = currentUser.firstName || '';
            document.getElementById('profileLastName').value = currentUser.lastName || '';
            document.getElementById('profileUsername').value = currentUser.username || '';
            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profilePhone').value = currentUser.profile?.phone || '';
            document.getElementById('profileCountry').value = currentUser.profile?.country || '';
            document.getElementById('profileBio').value = currentUser.profile?.bio || '';
        }

        function showSection(section) {
            // LIMPIEZA PREVENTIVA: Cerrar cualquier modal abierto al cambiar de secci√≥n
            document.querySelectorAll('.modal').forEach(modal => {
                const instance = bootstrap.Modal.getInstance(modal);
                if (instance) {
                    instance.hide();
                }
            });
            
            // Limpiar backdrops y resetear body
            setTimeout(() => {
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            }, 100);
            
            // Ocultar todas las secciones
            document.querySelectorAll('[id$="Section"]').forEach(el => el.style.display = 'none');
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(section + 'Section').style.display = 'block';

            // Cargar datos espec√≠ficos de la secci√≥n
            if (section === 'dashboard') {
                loadDashboardStats();
            } else if (section === 'training' && currentUser?.role === 'admin') {
                loadTrainingImages();
                loadTrainingStats();
            } else if (section === 'libraryAdmin' && currentUser?.role === 'admin') {
                loadLibraryObjects();
            } else if (section === 'reports') {
                loadReports();
            }

            // Actualizar nav activo
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Actualizar perfil
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const formData = {
                username: document.getElementById('profileUsername').value,
                email: document.getElementById('profileEmail').value,
                firstName: document.getElementById('profileFirstName').value,
                lastName: document.getElementById('profileLastName').value,
                profile: {
                    phone: document.getElementById('profilePhone').value,
                    country: document.getElementById('profileCountry').value,
                    bio: document.getElementById('profileBio').value
                }
            };

            try {
                const response = await fetch(`${API_URL}/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showProfileAlert('Perfil actualizado exitosamente', 'success');
                    currentUser = data;
                    displayUserInfo();
                } else {
                    showProfileAlert(data.error || 'Error al actualizar perfil', 'danger');
                }
            } catch (error) {
                showProfileAlert('Error de conexi√≥n', 'danger');
            }
        });

        // Cambiar contrase√±a
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    showProfileAlert('Contrase√±a actualizada exitosamente', 'success');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showProfileAlert(data.error || 'Error al cambiar contrase√±a', 'danger');
                }
            } catch (error) {
                showProfileAlert('Error de conexi√≥n', 'danger');
            }
        });

        function showProfileAlert(message, type) {
            const container = document.getElementById('profileAlertContainer');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        // === UPLOADS ===
        
        // Preview de archivo
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const previewContainer = document.getElementById('previewContainer');
            const previewContent = document.getElementById('previewContent');
            
            previewContainer.style.display = 'block';
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewContent.innerHTML = `
                        <img src="${e.target.result}" class="img-fluid" style="max-height: 300px; border-radius: 8px;">
                        <p class="mt-2"><strong>${file.name}</strong> (${formatFileSize(file.size)})</p>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith('video/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewContent.innerHTML = `
                        <video controls class="img-fluid" style="max-height: 300px; border-radius: 8px;">
                            <source src="${e.target.result}" type="${file.type}">
                        </video>
                        <p class="mt-2"><strong>${file.name}</strong> (${formatFileSize(file.size)})</p>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        // Subir archivo CON contexto del avistamiento
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showUploadAlert('Por favor selecciona un archivo', 'danger');
                return;
            }

            // Verificar tama√±o (50MB)
            if (file.size > 50 * 1024 * 1024) {
                showUploadAlert('El archivo es demasiado grande. M√°ximo: 50MB', 'danger');
                return;
            }

            const token = localStorage.getItem('token');
            const formData = new FormData();
            formData.append('file', file);

            // NUEVO: Agregar contexto del avistamiento
            const sightingContext = {
                movement: document.getElementById('contextMovement').value,
                speedEstimate: parseInt(document.getElementById('contextSpeed').value),
                altitudeEstimate: document.getElementById('contextAltitude').value,
                lightColor: Array.from(document.getElementById('contextLightColor').selectedOptions).map(opt => opt.value),
                lightIntensity: document.getElementById('contextLightIntensity').value,
                soundHeard: document.getElementById('contextSound').value,
                duration: document.getElementById('contextDuration').value,
                weatherConditions: document.getElementById('contextWeather').value,
                witnessActivity: document.getElementById('contextActivity').value,
                substanceUse: document.querySelector('input[name="substanceUse"]:checked').value === 'true',
                beliefLevel: document.getElementById('contextBelief').value,
                accompanied: document.getElementById('contextAccompanied').value === 'true',
                witnessCount: document.getElementById('contextAccompanied').value === 'true' ? 
                    parseInt(document.getElementById('contextWitnessCount').value) || 1 : 1,
                emotionalState: document.getElementById('contextEmotional').value,
                previousSightings: document.getElementById('contextPreviousSightings').value === 'true',
                previousSightingsCount: document.getElementById('contextPreviousSightings').value === 'true' ? 
                    parseInt(document.getElementById('contextPreviousCount').value) || 0 : 0,
                incidentDescription: document.getElementById('contextDescription').value
            };

            formData.append('sightingContext', JSON.stringify(sightingContext));

            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Subiendo...';
            progressContainer.style.display = 'block';

            try {
                const xhr = new XMLHttpRequest();

                // Progreso
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                        progressText.textContent = `Subiendo: ${Math.round(percentComplete)}%`;
                    }
                });

                // Completado
                xhr.addEventListener('load', () => {
                    if (xhr.status === 201) {
                        const data = JSON.parse(xhr.responseText);
                        showUploadAlert('¬°Archivo y contexto subidos exitosamente! El an√°lisis comenzar√° autom√°ticamente.', 'success');
                        
                        // Mostrar resultados del an√°lisis
                        if (data.analysis || data.analysisData) {
                            showAnalysisResults(data.analysis || data.analysisData || data);
                        }
                        
                        // Limpiar formulario
                        document.getElementById('uploadForm').reset();
                        document.getElementById('previewContainer').style.display = 'none';
                        progressContainer.style.display = 'none';
                        
                        // Resetear campos especiales
                        document.getElementById('contextWitnessCount').style.display = 'none';
                        document.getElementById('contextPreviousCount').style.display = 'none';
                        
                        // Recargar lista de uploads
                        loadUploads();
                    } else {
                        const error = JSON.parse(xhr.responseText);
                        showUploadAlert(error.error || 'Error al subir archivo', 'danger');
                    }
                    
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Subir y Analizar';
                });

                // Error
                xhr.addEventListener('error', () => {
                    showUploadAlert('Error de conexi√≥n', 'danger');
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Subir y Analizar';
                    progressContainer.style.display = 'none';
                });

                // Enviar
                xhr.open('POST', `${API_URL}/api/uploads`);
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);

            } catch (error) {
                console.error('Error:', error);
                showUploadAlert('Error al subir archivo', 'danger');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Subir Archivo';
                progressContainer.style.display = 'none';
            }
        });

        // üìÑ Mostrar resultados de an√°lisis despu√©s de subida
        function showAnalysisResults(analysisData) {
            currentAnalysisData = analysisData;
            const resultsCard = document.getElementById('analysisResultsCard');
            const statsContainer = document.getElementById('analysisStatsContainer');
            
            if (!resultsCard) return;
            
            // Mostrar tarjeta de resultados
            resultsCard.style.display = 'block';
            
            // Mostrar estad√≠sticas si existen
            if (analysisData.analysis && analysisData.analysis.results) {
                const results = analysisData.analysis.results;
                statsContainer.innerHTML = `
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card border-left border-primary">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">Confianza General</h6>
                                    <h5>${(results.confidence * 100).toFixed(1)}%</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card border-left border-info">
                                <div class="card-body">
                                    <h6 class="card-title text-info">Clasificaci√≥n</h6>
                                    <h5>${results.classification || 'An√°lisis en curso'}</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card border-left border-success">
                                <div class="card-body">
                                    <h6 class="card-title text-success">Estado</h6>
                                    <h5>${analysisData.status || 'Completado'}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // üìã Previsualizar PDF del an√°lisis
        async function previewAnalysisPDF() {
            if (!currentAnalysisData) {
                alert('No hay an√°lisis disponible para previsualizar');
                return;
            }

            try {
                // Mostrar modal o ventana emergente con opciones
                const pdfWindow = window.open('', '_blank', 'width=800,height=600');
                pdfWindow.document.write(`
                    <html>
                        <head>
                            <title>Previsualizaci√≥n de PDF</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                h1 { color: #0d6efd; }
                                .info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
                                .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
                                .btn-primary { background: #0d6efd; color: white; }
                                .btn-success { background: #28a745; color: white; }
                            </style>
                        </head>
                        <body>
                            <h1><i class="bi bi-file-earmark-pdf"></i> Previsualizaci√≥n del Reporte</h1>
                            <div class="info">
                                <h3>An√°lisis de Archivo</h3>
                                <p><strong>Archivo:</strong> ${currentAnalysisData.filename || 'N/A'}</p>
                                <p><strong>Tipo:</strong> ${currentAnalysisData.fileType || 'N/A'}</p>
                                <p><strong>Tama√±o:</strong> ${(currentAnalysisData.fileSize / 1024).toFixed(2)} KB</p>
                                <p><strong>Fecha:</strong> ${new Date(currentAnalysisData.uploadedAt).toLocaleDateString()}</p>
                            </div>
                            <div class="info">
                                <h3>Resultados del An√°lisis</h3>
                                <p><strong>Confianza:</strong> ${(currentAnalysisData.analysis?.results?.confidence * 100).toFixed(1)}%</p>
                                <p><strong>Clasificaci√≥n:</strong> ${currentAnalysisData.analysis?.results?.classification || 'En an√°lisis'}</p>
                                <p><strong>Estado:</strong> ${currentAnalysisData.status}</p>
                            </div>
                            <button class="btn btn-success" onclick="window.close()">Cerrar</button>
                        </body>
                    </html>
                `);
                pdfWindow.document.close();
            } catch (error) {
                console.error('Error en previsualizaci√≥n:', error);
                alert('Error al previsualizar: ' + error.message);
            }
        }

        // üì• Descargar reporte PDF
        async function downloadAnalysisReport() {
            if (!currentAnalysisData) {
                alert('No hay an√°lisis disponible para descargar');
                return;
            }

            try {
                const btn = document.getElementById('downloadReportBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Descargando...';

                const token = localStorage.getItem('token');
                const analysisId = currentAnalysisData._id || currentAnalysisData.id;

                // Llamar al endpoint de generaci√≥n de PDF
                const response = await fetch(`${API_URL}/api/reports/generate-pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        type: 'analysis-summary',
                        data: currentAnalysisData
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al generar PDF');
                }

                // Descargar archivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte-analisis-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showUploadAlert('‚úÖ PDF descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error al descargar:', error);
                showUploadAlert('‚ùå Error al descargar PDF: ' + error.message, 'danger');
            } finally {
                const btn = document.getElementById('downloadReportBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> Descargar';
            }
        }

        // Cargar lista de uploads
        async function loadUploads() {
            const token = localStorage.getItem('token');
            const container = document.getElementById('uploadsListContainer');

            try {
                const response = await fetch(`${API_URL}/api/uploads`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.analyses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox" style="font-size: 48px;"></i>
                            <p class="mt-2">No has subido ning√∫n archivo a√∫n</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Archivo</th>
                                    <th>Tipo</th>
                                    <th>Tama√±o</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="uploadsTableBody"></tbody>
                        </table>
                    </div>
                `;

                const tbody = document.getElementById('uploadsTableBody');
                data.analyses.forEach(analysis => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-analysis-id', analysis.id); // Para WebSocket updates
                    
                    const statusBadge = getStatusBadge(analysis.status);
                    const typeIcon = analysis.fileType === 'image' ? 'bi-image' : 'bi-camera-video';
                    
                    // Botones seg√∫n estado
                    let actionButtons = '';
                    
                    if (analysis.status === 'pending' && analysis.fileType === 'image') {
                        actionButtons = `
                            <button class="btn btn-sm btn-primary" onclick="analyzeImage('${analysis.id}')" title="Analizar con IA">
                                <i class="bi bi-robot"></i>
                            </button>
                        `;
                    } else if (analysis.status === 'analyzing') {
                        actionButtons = `
                            <button class="btn btn-sm btn-secondary" disabled>
                                <span class="spinner-border spinner-border-sm"></span>
                            </button>
                        `;
                    } else if (analysis.status === 'completed') {
                        actionButtons = `
                            <button class="btn btn-sm btn-success" onclick="viewAnalysis('${analysis.id}')" title="Ver resultados">
                                <i class="bi bi-eye"></i>
                            </button>
                        `;
                    }
                    
                    actionButtons += `
                        <button class="btn btn-sm btn-danger ms-1" onclick="deleteUpload('${analysis.id}')" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    
                    row.innerHTML = `
                        <td><i class="bi ${typeIcon}"></i> ${analysis.fileName}</td>
                        <td><span class="badge bg-secondary">${analysis.fileType}</span></td>
                        <td>${formatFileSize(analysis.fileSize)}</td>
                        <td>${statusBadge}</td>
                        <td>${new Date(analysis.uploadDate).toLocaleString('es-ES')}</td>
                        <td class="text-nowrap">${actionButtons}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        Error al cargar uploads
                    </div>
                `;
            }
        }

        // Eliminar upload
        async function deleteUpload(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este archivo?')) return;

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/uploads/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showUploadAlert('Archivo eliminado exitosamente', 'success');
                    loadUploads();
                } else {
                    const data = await response.json();
                    showUploadAlert(data.error || 'Error al eliminar', 'danger');
                }
            } catch (error) {
                showUploadAlert('Error de conexi√≥n', 'danger');
            }
        }

        // ========== B√öSQUEDA INVERSA DE IM√ÅGENES ==========
        let reverseSearchImageUrl = null;

        // Inicializar event listeners para b√∫squeda inversa
        document.addEventListener('DOMContentLoaded', function() {
            const dropzone = document.getElementById('reverseSearchDropzone');
            const fileInput = document.getElementById('reverseSearchFile');
            const urlInput = document.getElementById('reverseSearchUrl');
            const preview = document.getElementById('reverseSearchPreview');
            const previewImg = document.getElementById('reverseSearchPreviewImg');

            // Click en dropzone abre selector de archivo
            if (dropzone) {
                dropzone.addEventListener('click', () => {
                    fileInput.click();
                });

                // Prevenir comportamiento por defecto en drag & drop
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });

                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('dragover');
                });

                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length > 0) {
                        handleReverseSearchFile(e.dataTransfer.files[0]);
                    }
                });
            }

            // Cuando se selecciona archivo desde input
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleReverseSearchFile(e.target.files[0]);
                    }
                });
            }

            // Actualizar URL cuando se escribe en el input
            if (urlInput) {
                urlInput.addEventListener('input', (e) => {
                    reverseSearchImageUrl = e.target.value.trim();
                    if (reverseSearchImageUrl) {
                        // Mostrar preview de URL
                        previewImg.src = reverseSearchImageUrl;
                        preview.style.display = 'block';
                    } else {
                        preview.style.display = 'none';
                    }
                });
            }
        });

        // Procesar archivo subido para b√∫squeda inversa
        function handleReverseSearchFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen v√°lido');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                reverseSearchImageUrl = e.target.result;
                const preview = document.getElementById('reverseSearchPreview');
                const previewImg = document.getElementById('reverseSearchPreviewImg');
                
                previewImg.src = reverseSearchImageUrl;
                preview.style.display = 'block';
                
                // Limpiar input de URL
                document.getElementById('reverseSearchUrl').value = '';
            };
            reader.readAsDataURL(file);
        }

        // Buscar en Google Images
        async function searchOnGoogle() {
            const url = reverseSearchImageUrl || document.getElementById('reverseSearchUrl').value.trim();
            
            if (!url) {
                alert('Por favor ingresa una URL de imagen o sube una imagen');
                return;
            }

            // Si es una imagen local (data URL), primero subirla al servidor
            if (url.startsWith('data:')) {
                const publicUrl = await uploadImageForReverseSearch(url);
                if (publicUrl) {
                    const googleUrl = `https://www.google.com/searchbyimage?image_url=${encodeURIComponent(publicUrl)}`;
                    window.open(googleUrl, '_blank');
                }
                return;
            }

            // Google Images reverse search URL
            const googleUrl = `https://www.google.com/searchbyimage?image_url=${encodeURIComponent(url)}`;
            window.open(googleUrl, '_blank');
        }

        // Buscar en Yandex Images
        async function searchOnYandex() {
            const url = reverseSearchImageUrl || document.getElementById('reverseSearchUrl').value.trim();
            
            if (!url) {
                alert('Por favor ingresa una URL de imagen o sube una imagen');
                return;
            }

            // Si es una imagen local (data URL), primero subirla al servidor
            if (url.startsWith('data:')) {
                const publicUrl = await uploadImageForReverseSearch(url);
                if (publicUrl) {
                    const yandexUrl = `https://yandex.com/images/search?rpt=imageview&url=${encodeURIComponent(publicUrl)}`;
                    window.open(yandexUrl, '_blank');
                }
                return;
            }

            // Yandex Images reverse search URL
            const yandexUrl = `https://yandex.com/images/search?rpt=imageview&url=${encodeURIComponent(url)}`;
            window.open(yandexUrl, '_blank');
        }

        // Buscar en TinEye
        async function searchOnTinEye() {
            const url = reverseSearchImageUrl || document.getElementById('reverseSearchUrl').value.trim();
            
            if (!url) {
                alert('Por favor ingresa una URL de imagen o sube una imagen');
                return;
            }

            // Si es una imagen local (data URL), primero subirla al servidor
            if (url.startsWith('data:')) {
                const publicUrl = await uploadImageForReverseSearch(url);
                if (publicUrl) {
                    const tineyeUrl = `https://tineye.com/search?url=${encodeURIComponent(publicUrl)}`;
                    window.open(tineyeUrl, '_blank');
                }
                return;
            }

            // TinEye reverse search URL
            const tineyeUrl = `https://tineye.com/search?url=${encodeURIComponent(url)}`;
            window.open(tineyeUrl, '_blank');
        }

        // Subir imagen local al servidor para obtener URL p√∫blica
        async function uploadImageForReverseSearch(dataUrl) {
            const token = localStorage.getItem('token');
            
            if (!token) {
                alert('Debes iniciar sesi√≥n para subir im√°genes');
                return null;
            }

            try {
                // Mostrar mensaje de carga
                const loadingMsg = document.createElement('div');
                loadingMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: #4a9eff;
                    padding: 30px 50px;
                    border: 3px solid #4a9eff;
                    font-family: 'VT323', monospace;
                    font-size: 24px;
                    z-index: 10000;
                    box-shadow: 0 0 30px rgba(74, 158, 255, 0.6);
                `;
                loadingMsg.innerHTML = '<i class="bi bi-cloud-upload"></i> Subiendo imagen al servidor...';
                document.body.appendChild(loadingMsg);

                // Convertir data URL a blob
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                
                // Crear FormData
                const formData = new FormData();
                formData.append('file', blob, 'reverse-search-' + Date.now() + '.jpg');

                // Subir al servidor
                const uploadResponse = await fetch(`${API_URL}/api/uploads`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                document.body.removeChild(loadingMsg);

                if (uploadResponse.ok) {
                    const data = await uploadResponse.json();
                    // Construir URL p√∫blica de la imagen (est√° en uploads/images/)
                    const publicUrl = `${API_URL}/uploads/images/${data.image.filename}`;
                    return publicUrl;
                } else {
                    const errorData = await uploadResponse.json();
                    alert('Error al subir imagen: ' + (errorData.error || 'Error desconocido'));
                    return null;
                }
            } catch (error) {
                console.error('Error subiendo imagen:', error);
                alert('Error de conexi√≥n al subir imagen');
                return null;
            }
        }

        // Analizar imagen con IA
        async function analyzeImage(id) {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/analyze/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showUploadAlert('An√°lisis iniciado. Conectando en tiempo real...', 'info');
                    // Suscribirse a eventos WebSocket del an√°lisis
                    subscribeToAnalysis(id);
                } else {
                    const data = await response.json();
                    showUploadAlert(data.error || 'Error al iniciar an√°lisis', 'danger');
                }
            } catch (error) {
                showUploadAlert('Error de conexi√≥n', 'danger');
            }
        }

        // OBSOLETO: Polling eliminado - ahora usamos WebSocket
        // La funci√≥n pollAnalysisStatus ha sido reemplazada por subscribeToAnalysis

        // Ver resultados de an√°lisis
        async function viewAnalysis(id) {
            const token = localStorage.getItem('token');

            try {
                console.log('üîç Solicitando an√°lisis:', id);
                const response = await fetch(`${API_URL}/api/analyze/${id}/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Datos recibidos:', data);
                    console.log('  - fileName:', data.fileName);
                    console.log('  - uploadDate:', data.uploadDate);
                    console.log('  - hasExifData:', data.hasExifData);
                    console.log('  - hasAiAnalysis:', data.hasAiAnalysis);
                    // Guardar el ID del an√°lisis
                    data.analysisId = id;
                    displayAnalysisResults(data);
                } else {
                    const error = await response.json();
                    console.error('‚ùå Error del servidor:', error);
                    showUploadAlert(error.error || 'Error al cargar resultados', 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showUploadAlert('Error de conexi√≥n', 'danger');
            }
        }

        // Mostrar resultados en modal
        function displayAnalysisResults(data) {
            console.log('üìä Mostrando resultados:', data);
            console.log('üë§ Usuario actual:', currentUser);
            console.log('üîë Es admin?', currentUser?.role === 'admin');
            console.log('‚úÖ Status completed?', data.status === 'completed');
            console.log('üéì Ya usado para training?', data.usedForTraining);
            
            // Determinar si mostrar bot√≥n de training
            const showTrainingButton = currentUser && 
                                      currentUser.role === 'admin' && 
                                      data.status === 'completed' && 
                                      !data.usedForTraining;
            
            console.log('üîò Mostrar bot√≥n training?', showTrainingButton);
            
            const modalHtml = `
                <div class="modal fade" id="analysisModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-robot"></i> Resultados del An√°lisis
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${generateAnalysisContent(data)}
                            </div>
                            <div class="modal-footer">
                                ${showTrainingButton ? `
                                    <button type="button" class="btn btn-success" onclick="convertToTraining('${data.analysisId || data._id}')">
                                        <i class="bi bi-database-add"></i> Agregar a Training
                                    </button>
                                ` : ''}
                                <button type="button" class="btn btn-info" onclick="downloadAnalysisPDF('${data.analysisId || data._id}')">
                                    <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                                </button>
                                <button type="button" class="btn btn-primary" onclick="openReportForm('${data.analysisId || data._id}')" data-bs-dismiss="modal">
                                    <i class="bi bi-file-earmark-text"></i> Generar Reporte PDF
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // LIMPIEZA AGRESIVA DE MODALES Y BACKDROPS
            console.log('üßπ Limpiando modales anteriores...');
            
            // Destruir instancias de Bootstrap Modal previas
            const existingModal = document.getElementById('analysisModal');
            if (existingModal) {
                const modalInstance = bootstrap.Modal.getInstance(existingModal);
                if (modalInstance) {
                    modalInstance.dispose();
                }
                existingModal.remove();
            }

            // Limpiar TODOS los backdrops
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            
            // Limpiar todos los modales hu√©rfanos
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.id !== 'analysisModal') {
                    const instance = bootstrap.Modal.getInstance(modal);
                    if (instance) instance.dispose();
                }
            });
            
            // Resetear body completamente
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            // Agregar nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Peque√±o delay para asegurar que el DOM se actualice
            setTimeout(() => {
                const modalElement = document.getElementById('analysisModal');
                if (!modalElement) {
                    console.error('‚ùå Modal no encontrado en el DOM');
                    return;
                }
                
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                
                // Event listener para limpiar al cerrar
                modalElement.addEventListener('hidden.bs.modal', function cleanupModal() {
                    console.log('üßπ Limpiando al cerrar modal...');
                    
                    // Limpiar todos los backdrops
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                        backdrop.remove();
                    });
                    
                    // Resetear body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    // Remover el modal del DOM
                    modalElement.remove();
                }, { once: true });
                
                console.log('‚úÖ Mostrando modal...');
                modal.show();
            }, 100);
        }

        function generateAnalysisContent(data) {
            let html = '<div class="container-fluid">';

            // Informaci√≥n del archivo
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2"><i class="bi bi-file-earmark"></i> Archivo</h6>
                        <p><strong>Nombre:</strong> ${data.fileName || 'N/A'}</p>
                        <p><strong>Fecha de subida:</strong> ${data.uploadDate ? new Date(data.uploadDate).toLocaleString('es-ES') : 'N/A'}</p>
                    </div>
                </div>
            `;

            // RESUMEN DE CONFIANZA (CAPA 9 - Primero porque es el resultado final)
            if (data.analysisData?.confidence !== undefined) {
                html += generateConfidenceSummary(data.analysisData);
            }

            // AN√ÅLISIS FORENSE (CAPA 3)
            if (data.forensicAnalysis || data.analysisData?.forensicAnalysis) {
                html += generateForensicSection(data.forensicAnalysis || data.analysisData.forensicAnalysis);
            }

            // DATOS EXIF (CAPA 1)
            if (data.hasExifData && data.analysisData?.exifData) {
                html += generateExifSection(data.analysisData.exifData);
            }

            // AN√ÅLISIS VISUAL (CAPA 2)
            if (data.analysisData?.visualAnalysis) {
                html += generateVisualAnalysisSection(data.analysisData.visualAnalysis);
            }

            // AN√ÅLISIS IA (CAPA 2 continuaci√≥n)
            if (data.hasAiAnalysis && data.analysisData?.aiAnalysis) {
                html += generateAiSection(data.analysisData.aiAnalysis);
            }

            // COMPARACI√ìN CIENT√çFICA (CAPA 4)
            if (data.hasMatches && data.analysisData?.matchResults?.length > 0) {
                html += generateMatchesSection(data.analysisData.matchResults);
            }

            // TRAINING ENHANCEMENT (CAPA 5)
            if (data.analysisData?.trainingEnhancement) {
                html += generateTrainingSection(data.analysisData.trainingEnhancement);
            }

            // VALIDACI√ìN EXTERNA (CAPA 6)
            if (data.analysisData?.externalValidation) {
                html += generateExternalValidationSection(data.analysisData.externalValidation);
            }

            // DATOS METEOROL√ìGICOS (CAPA 7)
            if (data.analysisData?.weatherData) {
                html += generateWeatherSection(data.analysisData.weatherData);
            }

            // COMPARACI√ìN ATMOSF√âRICA (CAPA 8)
            if (data.analysisData?.atmosphericComparison) {
                html += generateAtmosphericSection(data.analysisData.atmosphericComparison);
            }

            // Si no hay an√°lisis
            if (!data.hasExifData && !data.hasAiAnalysis) {
                html += '<div class="alert alert-warning">No hay datos de an√°lisis disponibles.</div>';
            }

            html += '</div>';
            return html;
        }

// FUNCI√ìN PARA INSERTAR EN dashboard.html ANTES DE generateExifSection

function generateForensicSection(forensic) {
    const verdictInfo = {
        'LIKELY_AUTHENTIC': { text: 'Muy Probablemente Aut√©ntica', color: 'success', icon: '‚úÖ', bg: 'success' },
        'POSSIBLY_AUTHENTIC': { text: 'Probablemente Aut√©ntica', color: 'info', icon: '‚úÖ', bg: 'info' },
        'INCONCLUSIVE': { text: 'No Concluyente', color: 'warning', icon: '‚ö†Ô∏è', bg: 'warning' },
        'POSSIBLY_MANIPULATED': { text: 'Probablemente Manipulada', color: 'warning', icon: '‚ö†Ô∏è', bg: 'warning' },
        'LIKELY_MANIPULATED': { text: 'Muy Probablemente Manipulada', color: 'danger', icon: '‚ùå', bg: 'danger' }
    };

    const verdict = verdictInfo[forensic.verdict] || verdictInfo['INCONCLUSIVE'];
    const score = forensic.manipulationScore || 0;
    const authenticityScore = 100 - score;

    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-shield-exclamation"></i> An√°lisis Forense de Manipulaci√≥n
                    <small class="text-muted">- T√©cnicas avanzadas de detecci√≥n</small>
                </h6>

                <!-- VEREDICTO PRINCIPAL -->
                <div class="alert alert-${verdict.bg} mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="alert-heading mb-2">
                                ${verdict.icon} ${verdict.text}
                            </h5>
                            <p class="mb-2"><strong>Score de Manipulaci√≥n:</strong> ${score}/100</p>
                            <p class="mb-0"><strong>Score de Autenticidad:</strong> ${authenticityScore}/100</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="display-4">
                                <span class="badge bg-${verdict.bg}" style="font-size: 2rem;">${score}/100</span>
                            </div>
                            <small class="text-muted">Manipulaci√≥n</small>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 25px;">
                        <div class="progress-bar bg-success" style="width: ${authenticityScore}%">
                            Aut√©ntico: ${authenticityScore}%
                        </div>
                        <div class="progress-bar bg-danger" style="width: ${score}%">
                            Manipulado: ${score}%
                        </div>
                    </div>
                </div>

                <!-- DETALLES POR T√âCNICA -->
                <div class="row">
    `;

    // 1. AN√ÅLISIS DE ILUMINACI√ìN
    if (forensic.lightingAnalysis) {
        const lighting = forensic.lightingAnalysis;
        const lightColor = lighting.isSuspicious ? 'danger' : 'success';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${lightColor}">
                    <div class="card-header bg-${lightColor} text-white">
                        <strong>üí° Iluminaci√≥n</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Score:</strong> 
                            <span class="badge bg-${lightColor}">${lighting.inconsistencyScore}/100</span>
                        </p>
                        <p class="mb-1 small"><strong>Direcci√≥n:</strong> ${lighting.averageDirection}¬∞</p>
                        <div class="mt-2">
                            ${lighting.isSuspicious ? 
                                '<span class="badge bg-danger">‚ö†Ô∏è Sospechoso</span>' : 
                                '<span class="badge bg-success">‚úÖ Normal</span>'}
                        </div>
                        <small class="text-muted d-block mt-2">
                            Consistencia de sombras y direcci√≥n de luz.
                        </small>
                    </div>
                </div>
            </div>
        `;
    }

    // 2. AN√ÅLISIS DE RUIDO
    if (forensic.noiseAnalysis) {
        const noise = forensic.noiseAnalysis;
        const noiseColor = noise.isSuspicious ? 'danger' : 'success';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${noiseColor}">
                    <div class="card-header bg-${noiseColor} text-white">
                        <strong>üìä Ruido Digital</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Score:</strong> 
                            <span class="badge bg-${noiseColor}">${noise.inconsistencyScore}/100</span>
                        </p>
                        <div class="mt-2">
                            ${noise.isSuspicious ? 
                                '<span class="badge bg-danger">‚ö†Ô∏è Sospechoso</span>' : 
                                '<span class="badge bg-success">‚úÖ Normal</span>'}
                        </div>
                        <small class="text-muted d-block mt-2">
                            Diferencias de compresi√≥n (tipo ELA).
                        </small>
                    </div>
                </div>
            </div>
        `;
    }

    // 3. CLONACI√ìN
    if (forensic.cloneDetection) {
        const clone = forensic.cloneDetection;
        const cloneColor = clone.isSuspicious ? 'danger' : 'success';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${cloneColor}">
                    <div class="card-header bg-${cloneColor} text-white">
                        <strong>üîç Clonaci√≥n</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Score:</strong> 
                            <span class="badge bg-${cloneColor}">${clone.cloneScore}/100</span>
                        </p>
                        <p class="mb-1 small"><strong>Clones:</strong> ${clone.clonedRegions}</p>
                        <div class="mt-2">
                            ${clone.isSuspicious ? 
                                '<span class="badge bg-danger">‚ö†Ô∏è Detectado</span>' : 
                                '<span class="badge bg-success">‚úÖ Sin Clones</span>'}
                        </div>
                        <small class="text-muted d-block mt-2">
                            √Åreas duplicadas (copia-pega).
                        </small>
                    </div>
                </div>
            </div>
        `;
    }

    // 4. BORDES
    if (forensic.edgeConsistency) {
        const edge = forensic.edgeConsistency;
        const edgeColor = edge.isSuspicious ? 'danger' : 'success';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${edgeColor}">
                    <div class="card-header bg-${edgeColor} text-white">
                        <strong>‚úÇÔ∏è Bordes</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Score:</strong> 
                            <span class="badge bg-${edgeColor}">${edge.inconsistencyScore}/100</span>
                        </p>
                        <div class="mt-2">
                            ${edge.isSuspicious ? 
                                '<span class="badge bg-danger">‚ö†Ô∏è Sospechoso</span>' : 
                                '<span class="badge bg-success">‚úÖ Normal</span>'}
                        </div>
                        <small class="text-muted d-block mt-2">
                            Bordes artificiales y halos.
                        </small>
                    </div>
                </div>
            </div>
        `;
    }

    html += `
                </div>

                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Interpretaci√≥n</h6>
                    <ul class="mb-0 small">
                        <li><strong>0-20:</strong> Aut√©ntica ‚úÖ</li>
                        <li><strong>20-40:</strong> Probablemente aut√©ntica ‚úÖ</li>
                        <li><strong>40-60:</strong> No concluyente ‚ö†Ô∏è</li>
                        <li><strong>60-80:</strong> Probablemente manipulada ‚ö†Ô∏è</li>
                        <li><strong>80-100:</strong> Manipulada ‚ùå</li>
                    </ul>
                </div>
            </div>
        </div>
    `;

    return html;
}
        function generateExifSection(exifData) {
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-camera"></i> Datos T√©cnicos de Captura (EXIF) 
                            <small class="text-muted">- An√°lisis forense de metadatos</small>
                        </h6>
            `;

            // ===== INDICADORES DE MANIPULACI√ìN (PRIMERO - M√ÅS IMPORTANTE) =====
            if (exifData.isManipulated !== undefined || exifData.manipulationScore !== undefined) {
                const score = 100 - (exifData.manipulationScore || 0);
                const isManipulated = exifData.isManipulated || exifData.manipulationScore > 50;
                const scoreColor = score >= 70 ? 'success' : score >= 40 ? 'warning' : 'danger';
                
                html += `
                    <div class="alert ${isManipulated ? 'alert-warning' : 'alert-success'} mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="alert-heading mb-2">
                                    ${isManipulated ? '‚ö†Ô∏è POSIBLE MANIPULACI√ìN DETECTADA' : '‚úÖ SIN INDICIOS DE MANIPULACI√ìN'}
                                </h6>
                                <strong>Puntuaci√≥n de Autenticidad:</strong>
                            </div>
                            <div class="h2 mb-0">
                                <span class="badge bg-${scoreColor}">${score}/100</span>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 20px;">
                            <div class="progress-bar bg-${scoreColor}" style="width: ${score}%">${score}%</div>
                        </div>
                        ${exifData.manipulationDetails ? 
                            `<div class="mt-2"><small><strong>Detalles:</strong> ${exifData.manipulationDetails}</small></div>` 
                            : ''}
                        ${exifData.isAIGenerated ? 
                            '<div class="mt-2 text-danger"><strong>‚ö†Ô∏è ADVERTENCIA: Imagen posiblemente generada por IA</strong></div>' 
                            : ''}
                    </div>
                `;
            }

            // ===== INFORMACI√ìN DE LA C√ÅMARA Y LENTE =====
            if (exifData.camera || exifData.cameraModel || exifData.lens || exifData.lensMake) {
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-camera2"></i> Equipo de Captura</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    ${exifData.camera || exifData.cameraModel ? `
                                        <p class="mb-1">
                                            <strong>C√°mara:</strong> 
                                            ${exifData.camera || ''} ${exifData.cameraModel || 'N/A'}
                                        </p>
                                    ` : ''}
                                    ${exifData.cameraSerialNumber ? `
                                        <p class="mb-1"><small class="text-muted">S/N: ${exifData.cameraSerialNumber}</small></p>
                                    ` : ''}
                                    ${exifData.firmware ? `
                                        <p class="mb-1"><small class="text-muted">Firmware: ${exifData.firmware}</small></p>
                                    ` : ''}
                                </div>
                                <div class="col-md-6">
                                    ${exifData.lens || exifData.lensMake ? `
                                        <p class="mb-1">
                                            <strong>Lente:</strong> 
                                            ${exifData.lensMake || ''} ${exifData.lens || 'N/A'}
                                        </p>
                                    ` : ''}
                                    ${exifData.lensSerialNumber ? `
                                        <p class="mb-1"><small class="text-muted">S/N: ${exifData.lensSerialNumber}</small></p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ===== CONFIGURACI√ìN DE CAPTURA (TRI√ÅNGULO DE EXPOSICI√ìN) =====
            if (exifData.iso || exifData.aperture || exifData.shutterSpeed || exifData.focalLength) {
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-gear"></i> Tri√°ngulo de Exposici√≥n y Configuraci√≥n</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    ${exifData.iso ? `
                                        <div class="text-center p-2 border rounded">
                                            <div class="text-muted small">ISO</div>
                                            <div class="h5 mb-0">${exifData.iso}</div>
                                            <div class="small text-muted">
                                                ${exifData.iso > 1600 ? 'üåô Poca luz' : exifData.iso < 400 ? '‚òÄÔ∏è Buena luz' : '‚òÅÔ∏è Normal'}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-md-3">
                                    ${exifData.aperture ? `
                                        <div class="text-center p-2 border rounded">
                                            <div class="text-muted small">Apertura</div>
                                            <div class="h5 mb-0">${exifData.aperture}</div>
                                            <div class="small text-muted">
                                                ${parseFloat(exifData.aperture.replace('f/', '')) < 2.8 ? 'Muy abierta' : 'Normal'}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-md-3">
                                    ${exifData.shutterSpeed ? `
                                        <div class="text-center p-2 border rounded">
                                            <div class="text-muted small">Obturador</div>
                                            <div class="h5 mb-0">${exifData.shutterSpeed}</div>
                                            <div class="small text-muted">
                                                ${exifData.shutterSpeed.includes('s') && !exifData.shutterSpeed.includes('/') ? '‚è±Ô∏è Larga exp.' : '‚ö° R√°pido'}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-md-3">
                                    ${exifData.focalLength ? `
                                        <div class="text-center p-2 border rounded">
                                            <div class="text-muted small">Focal</div>
                                            <div class="h5 mb-0">${exifData.focalLength}</div>
                                            <div class="small text-muted">
                                                ${parseInt(exifData.focalLength) > 100 ? 'üî≠ Tele' : parseInt(exifData.focalLength) < 35 ? 'üìê Angular' : 'üì∑ Normal'}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n adicional -->
                            <div class="row mt-3">
                                ${exifData.exposureMode || exifData.exposureProgram || exifData.meteringMode ? `
                                    <div class="col-md-12">
                                        <div class="bg-white p-2 rounded">
                                            ${exifData.exposureMode ? `<small><strong>Modo:</strong> ${exifData.exposureMode} | </small>` : ''}
                                            ${exifData.exposureProgram ? `<small><strong>Programa:</strong> ${exifData.exposureProgram} | </small>` : ''}
                                            ${exifData.meteringMode ? `<small><strong>Medici√≥n:</strong> ${exifData.meteringMode}</small>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                                ${exifData.exposureBias ? `
                                    <div class="col-md-6 mt-2">
                                        <small><strong>Compensaci√≥n EV:</strong> ${exifData.exposureBias > 0 ? '+' : ''}${exifData.exposureBias}</small>
                                    </div>
                                ` : ''}
                                ${exifData.focalLengthIn35mm ? `
                                    <div class="col-md-6 mt-2">
                                        <small><strong>Focal equiv. 35mm:</strong> ${exifData.focalLengthIn35mm}mm</small>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Flash -->
                            ${exifData.flash !== undefined || exifData.flashMode ? `
                                <div class="mt-2 pt-2 border-top">
                                    <small>
                                        <i class="bi bi-lightning"></i> 
                                        <strong>Flash:</strong> 
                                        ${exifData.flashFired ? '‚úÖ Disparado' : '‚ùå No usado'}
                                        ${exifData.flashMode ? ` (${exifData.flashMode})` : ''}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // ===== ENFOQUE Y AJUSTES DE IMAGEN =====
            if (exifData.focusMode || exifData.whiteBalance || exifData.colorSpace || exifData.saturation || exifData.sharpness || exifData.contrast) {
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-sliders"></i> Ajustes de Imagen</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    ${exifData.focusMode ? `<p class="mb-1"><strong>Enfoque:</strong> ${exifData.focusMode}</p>` : ''}
                                    ${exifData.focusDistance ? `<p class="mb-1"><small>Distancia: ${exifData.focusDistance}m</small></p>` : ''}
                                    ${exifData.whiteBalance ? `<p class="mb-1"><strong>Balance de blancos:</strong> ${exifData.whiteBalance}</p>` : ''}
                                    ${exifData.colorSpace ? `<p class="mb-1"><strong>Espacio de color:</strong> ${exifData.colorSpace}</p>` : ''}
                                </div>
                                <div class="col-md-6">
                                    ${exifData.saturation ? `<p class="mb-1"><strong>Saturaci√≥n:</strong> ${exifData.saturation}</p>` : ''}
                                    ${exifData.sharpness ? `<p class="mb-1"><strong>Nitidez:</strong> ${exifData.sharpness}</p>` : ''}
                                    ${exifData.contrast ? `<p class="mb-1"><strong>Contraste:</strong> ${exifData.contrast}</p>` : ''}
                                    ${exifData.lightSource ? `<p class="mb-1"><strong>Fuente de luz:</strong> ${exifData.lightSource}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ===== FECHA Y HORA (M√öLTIPLES TIMESTAMPS) =====
            if (exifData.captureDate || exifData.dateTime || exifData.dateTimeDigitized) {
                const captureDate = exifData.captureDate ? new Date(exifData.captureDate) : null;
                const modifyDate = exifData.dateTime ? new Date(exifData.dateTime) : null;
                
                let timeOfDay = '';
                if (captureDate) {
                    const hour = captureDate.getHours();
                    if (hour >= 6 && hour < 12) timeOfDay = 'üåÖ Amanecer';
                    else if (hour >= 12 && hour < 18) timeOfDay = '‚òÄÔ∏è D√≠a';
                    else if (hour >= 18 && hour < 21) timeOfDay = 'üåá Atardecer';
                    else timeOfDay = 'üåô Noche';
                }
                
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-calendar-event"></i> Fecha y Hora</h6>
                            ${captureDate ? `
                                <p class="mb-1">
                                    <strong>üì∏ Captura original:</strong> 
                                    ${captureDate.toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'medium' })}
                                    <span class="badge bg-info ms-2">${timeOfDay}</span>
                                </p>
                            ` : ''}
                            ${modifyDate && modifyDate.getTime() !== captureDate?.getTime() ? `
                                <p class="mb-1 text-warning">
                                    <strong>‚ö†Ô∏è √öltima modificaci√≥n:</strong> 
                                    ${modifyDate.toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'medium' })}
                                </p>
                                <small class="text-muted">
                                    La fecha de modificaci√≥n difiere de la captura original (posible edici√≥n)
                                </small>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // ===== UBICACI√ìN GPS =====
            if (exifData.location) {
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-geo-alt-fill"></i> Ubicaci√≥n GPS</h6>
                            <p class="mb-2">
                                <strong>Coordenadas:</strong> 
                                ${exifData.location.latitude?.toFixed(6) || 'N/A'}${exifData.location.latitudeRef || ''}, 
                                ${exifData.location.longitude?.toFixed(6) || 'N/A'}${exifData.location.longitudeRef || ''}
                                ${exifData.location.altitude ? `
                                    <br><strong>Altitud:</strong> ${exifData.location.altitude} m ${exifData.location.altitudeRef || 'sobre nivel del mar'}
                                ` : ''}
                                ${exifData.location.gpsDateStamp ? `
                                    <br><small class="text-muted">Timestamp GPS: ${exifData.location.gpsDateStamp} ${exifData.location.gpsTimeStamp || ''}</small>
                                ` : ''}
                            </p>
                            ${exifData.location.latitude ? `
                                <a href="https://www.google.com/maps?q=${exifData.location.latitude},${exifData.location.longitude}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-map"></i> Ver en Google Maps
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // ===== DIMENSIONES Y CALIDAD =====
            if (exifData.imageWidth || exifData.imageHeight || exifData.quality || exifData.fileSize) {
                const megapixels = (exifData.imageWidth && exifData.imageHeight) 
                    ? ((exifData.imageWidth * exifData.imageHeight) / 1000000).toFixed(1) 
                    : null;
                const fileSizeMB = exifData.fileSize ? (exifData.fileSize / 1024 / 1024).toFixed(2) : null;
                
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-image"></i> Dimensiones y Calidad</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    ${exifData.imageWidth && exifData.imageHeight ? `
                                        <p class="mb-1"><strong>Resoluci√≥n:</strong> ${exifData.imageWidth} √ó ${exifData.imageHeight} px</p>
                                        ${megapixels ? `<p class="mb-1"><small>${megapixels} megap√≠xeles</small></p>` : ''}
                                    ` : ''}
                                    ${exifData.xResolution && exifData.yResolution ? `
                                        <p class="mb-1"><small>DPI: ${exifData.xResolution} √ó ${exifData.yResolution} ${exifData.resolutionUnit || ''}</small></p>
                                    ` : ''}
                                </div>
                                <div class="col-md-6">
                                    ${exifData.quality ? `<p class="mb-1"><strong>Calidad:</strong> ${exifData.quality}</p>` : ''}
                                    ${exifData.compression ? `<p class="mb-1"><strong>Compresi√≥n:</strong> ${exifData.compression}</p>` : ''}
                                    ${fileSizeMB ? `<p class="mb-1"><strong>Tama√±o:</strong> ${fileSizeMB} MB</p>` : ''}
                                    ${exifData.fileType ? `<p class="mb-1"><strong>Tipo:</strong> ${exifData.fileType}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ===== SOFTWARE Y PROCESAMIENTO =====
            if (exifData.software || exifData.processingSoftware || exifData.artist || exifData.copyright) {
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-cpu"></i> Software y Metadata</h6>
                            ${exifData.software ? `
                                <p class="mb-1">
                                    <strong>Software:</strong> ${exifData.software}
                                    ${exifData.software.toLowerCase().includes('photoshop') || 
                                      exifData.software.toLowerCase().includes('gimp') || 
                                      exifData.software.toLowerCase().includes('lightroom') ? 
                                        ' <span class="badge bg-warning">‚ö†Ô∏è Editada</span>' : ''}
                                </p>
                            ` : ''}
                            ${exifData.processingSoftware ? `
                                <p class="mb-1 text-warning">
                                    <strong>‚ö†Ô∏è Procesada con:</strong> ${exifData.processingSoftware}
                                </p>
                            ` : ''}
                            ${exifData.artist ? `<p class="mb-1"><strong>Autor:</strong> ${exifData.artist}</p>` : ''}
                            ${exifData.copyright ? `<p class="mb-1"><strong>Copyright:</strong> ${exifData.copyright}</p>` : ''}
                            ${exifData.imageDescription ? `<p class="mb-1"><small><strong>Descripci√≥n:</strong> ${exifData.imageDescription}</small></p>` : ''}
                        </div>
                    </div>
                `;
            }

            // ===== DATOS RAW (EXPANDIBLE) =====
            if (exifData.rawTags && Object.keys(exifData.rawTags).length > 0) {
                html += `
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-code-square"></i> Datos EXIF Completos 
                                <button class="btn btn-sm btn-outline-secondary float-end" 
                                        onclick="toggleRawExif()"
                                        id="toggleRawExifBtn">
                                    <i class="bi bi-eye"></i> Mostrar
                                </button>
                            </h6>
                            <div id="rawExifData" style="display: none;">
                                <pre class="bg-dark text-light p-3 rounded mt-2" style="max-height: 400px; overflow-y: auto; font-size: 0.85em;">${JSON.stringify(exifData.rawTags, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Funci√≥n para mostrar/ocultar datos RAW
        function toggleRawExif() {
            const element = document.getElementById('rawExifData');
            const btn = document.getElementById('toggleRawExifBtn');
            if (element.style.display === 'none') {
                element.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-eye-slash"></i> Ocultar';
            } else {
                element.style.display = 'none';
                btn.innerHTML = '<i class="bi bi-eye"></i> Mostrar';
            }
        }

        function generateAiSection(aiAnalysis) {
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2"><i class="bi bi-robot"></i> An√°lisis de IA (${aiAnalysis.provider || 'Claude'})</h6>
            `;

            // NUEVO: Indicador de mejora con entrenamiento
            if (aiAnalysis.enhancedWithTraining && aiAnalysis.trainingData) {
                const trainingData = aiAnalysis.trainingData;
                html += `
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading">
                            <i class="bi bi-mortarboard-fill"></i> An√°lisis Mejorado con Datos de Entrenamiento
                        </h6>
                        <p class="mb-1">
                            <strong>Este an√°lisis fue mejorado</strong> usando ${trainingData.matchCount} imagen(es) de referencia de la base de datos de entrenamiento.
                        </p>
                        ${trainingData.bestMatch ? `
                            <div class="mt-2 p-2 bg-light rounded">
                                <strong>Mejor coincidencia:</strong> ${trainingData.bestMatch.type}
                                <br><small class="text-muted">
                                    Similitud: ${trainingData.bestMatch.confidence}% | 
                                    Categor√≠a: ${trainingData.bestMatch.category}
                                </small>
                                ${trainingData.bestMatch.technicalData && trainingData.bestMatch.technicalData.manufacturer ? `
                                    <br><small><strong>Fabricante:</strong> ${trainingData.bestMatch.technicalData.manufacturer}</small>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            if (aiAnalysis.description) {
                html += `<p class="lead">${aiAnalysis.description}</p>`;
            }

            // Categor√≠a y confianza
            if (aiAnalysis.category) {
                const categoryBadge = getCategoryBadge(aiAnalysis.category);
                html += `<p><strong>Categor√≠a:</strong> ${categoryBadge}</p>`;
            }

            if (aiAnalysis.confidence !== undefined) {
                const confidenceColor = aiAnalysis.confidence >= 70 ? 'success' : aiAnalysis.confidence >= 40 ? 'warning' : 'danger';
                html += `
                    <div class="mb-3">
                        <strong>Nivel de confianza:</strong>
                        <div class="progress mt-2" style="height: 25px;">
                            <div class="progress-bar bg-${confidenceColor}" style="width: ${aiAnalysis.confidence}%">
                                ${aiAnalysis.confidence}%
                            </div>
                        </div>
                    </div>
                `;
            }

            // Objetos detectados
            if (aiAnalysis.detectedObjects?.length > 0) {
                html += `
                    <div class="mb-3">
                        <h6>Objetos Detectados</h6>
                        <ul class="list-group">
                            ${aiAnalysis.detectedObjects.map(obj => `
                                <li class="list-group-item">
                                    <strong>${obj.object}</strong>
                                    ${obj.confidence ? ` - Confianza: ${obj.confidence}%` : ''}
                                    ${obj.description ? `<br><small class="text-muted">${obj.description}</small>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // Caracter√≠sticas inusuales
            if (aiAnalysis.isUnusual) {
                html += `
                    <div class="alert alert-info">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Caracter√≠sticas inusuales detectadas</strong>
                        ${aiAnalysis.unusualFeatures ? '<p class="mb-0 mt-2">' + aiAnalysis.unusualFeatures + '</p>' : ''}
                    </div>
                `;
            }

            // Recomendaciones
            if (aiAnalysis.recommendations?.length > 0) {
                html += `
                    <div class="mb-3">
                        <h6>Recomendaciones</h6>
                        <ul>
                            ${aiAnalysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function generateMatchesSection(matches) {
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2"><i class="bi bi-search"></i> Coincidencias con Base de Datos</h6>
                        <ul class="list-group">
                            ${matches.map(match => `
                                <li class="list-group-item">
                                    <strong>${match.objectName}</strong> - Similitud: ${match.similarity}%
                                    ${match.category ? `<br><small>Categor√≠a: ${match.category}</small>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;

            return html;
        }

        // ========== NUEVAS FUNCIONES PARA LAS 9 CAPAS ==========

        function generateConfidenceSummary(analysisData) {
            const confidence = analysisData.confidence || 0;
            const category = analysisData.aiAnalysis?.category || 'unknown';
            const recommendations = analysisData.recommendations || analysisData.aiAnalysis?.recommendations || [];
            
            const confidenceColor = confidence >= 70 ? 'success' : confidence >= 40 ? 'warning' : 'danger';
            const confidenceLabel = confidence >= 70 ? 'Alta' : confidence >= 40 ? 'Media' : 'Baja';
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-${confidenceColor} border-${confidenceColor}">
                            <h5 class="alert-heading">
                                <i class="bi bi-bullseye"></i> Resumen del An√°lisis - Confianza ${confidenceLabel}
                            </h5>
                            <div class="row align-items-center mt-3">
                                <div class="col-md-6">
                                    <h6>Confianza Final: <strong>${confidence}%</strong></h6>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${confidenceColor}" style="width: ${confidence}%">
                                            ${confidence}%
                                        </div>
                                    </div>
                                    <p class="mt-3 mb-0"><strong>Categor√≠a:</strong> ${getCategoryBadge(category)}</p>
                                </div>
                                <div class="col-md-6">
                                    ${recommendations.length > 0 ? `
                                        <h6>Principales Hallazgos:</h6>
                                        <ul class="mb-0">
                                            ${recommendations.slice(0, 3).map(rec => `<li><small>${rec}</small></li>`).join('')}
                                        </ul>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function generateVisualAnalysisSection(visualAnalysis) {
            if (!visualAnalysis || !visualAnalysis.objectType) return '';
            
            const objType = visualAnalysis.objectType;
            const category = objType.category || 'unknown';
            const confidence = objType.confidence || 0;
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-eye"></i> An√°lisis Visual Avanzado
                            <small class="text-muted">- Capa 2</small>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Tipo de Objeto:</strong> ${getCategoryBadge(category)}</p>
                                <p><strong>Confianza Visual:</strong> ${confidence}%</p>
                                <div class="progress mb-3" style="height: 20px;">
                                    <div class="progress-bar" style="width: ${confidence}%">${confidence}%</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                ${objType.alternativeCategories ? `
                                    <p><strong>Categor√≠as Alternativas:</strong></p>
                                    <ul>
                                        ${Object.entries(objType.alternativeCategories)
                                            .map(([cat, conf]) => `<li>${cat}: ${conf}%</li>`)
                                            .join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        </div>
                        ${objType.reasoning ? `
                            <div class="alert alert-info mt-2">
                                <strong>Razonamiento:</strong> ${objType.reasoning}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return html;
        }

        function generateTrainingSection(training) {
            if (!training || !training.enhanced) return '';
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-book"></i> Mejora con Training
                            <small class="text-muted">- Capa 5</small>
                        </h6>
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 
                            <strong>An√°lisis mejorado con datos de entrenamiento</strong>
                            <p class="mb-2 mt-2">
                                Coincidencias encontradas: <strong>${training.trainingMatchCount || 0}</strong>
                            </p>
                            ${training.improvementDelta ? `
                                <p class="mb-0">
                                    Mejora de confianza: <strong>+${training.improvementDelta}%</strong>
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function generateExternalValidationSection(external) {
            if (!external || !external.results) return '';
            
            const results = external.results;
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-globe"></i> Validaci√≥n Externa (APIs)
                            <small class="text-muted">- Capa 6</small>
                        </h6>
            `;
            
            // Objetos Celestes (SunCalc)
            if (results.celestialBodies && Object.keys(results.celestialBodies).length > 0) {
                html += `
                    <div class="mb-3">
                        <h6><i class="bi bi-star"></i> Objetos Celestes Visibles</h6>
                        <div class="row">
                `;
                
                Object.entries(results.celestialBodies).forEach(([name, data]) => {
                    const visible = data.visible !== false;
                    html += `
                        <div class="col-md-6">
                            <div class="card mb-2 ${visible ? 'border-success' : ''}">
                                <div class="card-body py-2">
                                    <strong>${name.charAt(0).toUpperCase() + name.slice(1)}</strong>
                                    ${visible ? '<span class="badge bg-success ms-2">Visible</span>' : ''}
                                    <br><small>Altitud: ${data.altitude?.toFixed(1)}¬∞</small>
                                    ${data.azimuth ? `<br><small>Azimut: ${data.azimuth.toFixed(1)}¬∞</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Aeronaves (OpenSky Network)
            if (results.nearbyAircraft) {
                const aircraftCount = Array.isArray(results.nearbyAircraft) ? results.nearbyAircraft.length : 0;
                html += `
                    <div class="mb-3">
                        <h6><i class="bi bi-airplane"></i> Aeronaves Cercanas (OpenSky Network)</h6>
                        <p>Detectadas: <strong>${aircraftCount}</strong> aeronave(s)</p>
                        ${aircraftCount > 0 ? `
                            <ul class="list-group">
                                ${results.nearbyAircraft.slice(0, 5).map(aircraft => `
                                    <li class="list-group-item py-2">
                                        <strong>${aircraft.callsign || 'N/A'}</strong>
                                        - Distancia: ${aircraft.distance ? aircraft.distance.toFixed(1) : 'N/A'} km
                                        ${aircraft.altitude ? `<br><small>Altitud: ${aircraft.altitude.toFixed(0)} m</small>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-muted">No hay aeronaves en el √°rea.</p>'}
                    </div>
                `;
            }
            
            // Sat√©lites (N2YO)
            if (results.visibleSatellites) {
                const satCount = Array.isArray(results.visibleSatellites) ? results.visibleSatellites.length : 0;
                html += `
                    <div class="mb-3">
                        <h6><i class="bi bi-rocket"></i> Sat√©lites Visibles (N2YO)</h6>
                        <p>Detectados: <strong>${satCount}</strong> sat√©lite(s)</p>
                        ${satCount > 0 ? `
                            <ul class="list-group">
                                ${results.visibleSatellites.slice(0, 5).map(sat => `
                                    <li class="list-group-item py-2">
                                        <strong>${sat.name || 'N/A'}</strong>
                                        ${sat.magnitude ? `<br><small>Magnitud: ${sat.magnitude}</small>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-muted">No configurado o sin sat√©lites visibles.</p>'}
                    </div>
                `;
            }
            
            // Globos (StratoCat)
            if (results.nearbyBalloons) {
                const balloonCount = Array.isArray(results.nearbyBalloons) ? results.nearbyBalloons.length : 0;
                html += `
                    <div class="mb-3">
                        <h6><i class="bi bi-balloon"></i> Globos Estratosf√©ricos (StratoCat)</h6>
                        <p>Detectados: <strong>${balloonCount}</strong> globo(s)</p>
                        ${balloonCount > 0 ? `
                            <ul class="list-group">
                                ${results.nearbyBalloons.slice(0, 5).map(balloon => `
                                    <li class="list-group-item py-2">
                                        <strong>${balloon.type || 'N/A'}</strong>
                                        ${balloon.description ? `<br><small>${balloon.description}</small>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-muted">No hay globos en el √°rea.</p>'}
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function generateWeatherSection(weather) {
            if (!weather || weather.error) {
                return `
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="bi bi-cloud-sun"></i> An√°lisis Meteorol√≥gico
                                <small class="text-muted">- Capa 7</small>
                            </h6>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> 
                                API de OpenWeatherMap no configurada
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const temp = weather.temperature || {};
            const conditions = weather.conditions || {};
            const clouds = weather.clouds || {};
            const analysis = weather.analysis || {};
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-cloud-sun"></i> An√°lisis Meteorol√≥gico (OpenWeatherMap)
                            <small class="text-muted">- Capa 7</small>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Temperatura:</strong> ${temp.current || 'N/A'}¬∞${temp.unit || 'C'}</p>
                                <p><strong>Condiciones:</strong> ${conditions.description || 'N/A'}</p>
                                <p><strong>Nubes:</strong> ${clouds.coverage || 'N/A'}%</p>
                                <p><strong>Visibilidad:</strong> ${weather.visibility ? (weather.visibility/1000).toFixed(1) : 'N/A'} km</p>
                            </div>
                            <div class="col-md-6">
                                ${analysis.visibility_quality ? `
                                    <p><strong>Calidad de Visibilidad:</strong> ${analysis.visibility_quality}</p>
                                ` : ''}
                                ${analysis.likelihood_of_optical_phenomena ? `
                                    <p><strong>Probabilidad Fen√≥menos √ìpticos:</strong> ${analysis.likelihood_of_optical_phenomena}</p>
                                ` : ''}
                                ${analysis.weather_explanation_probability ? `
                                    <p><strong>Explicaci√≥n Meteorol√≥gica:</strong> ${analysis.weather_explanation_probability}</p>
                                ` : ''}
                            </div>
                        </div>
                        ${analysis.relevant_conditions && analysis.relevant_conditions.length > 0 ? `
                            <div class="alert alert-info mt-2">
                                <strong>Condiciones Relevantes:</strong>
                                <ul class="mb-0 mt-2">
                                    ${analysis.relevant_conditions.map(cond => `<li>${cond}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${analysis.warnings && analysis.warnings.length > 0 ? `
                            <div class="alert alert-warning mt-2">
                                <strong><i class="bi bi-exclamation-triangle"></i> Advertencias:</strong>
                                <ul class="mb-0 mt-2">
                                    ${analysis.warnings.map(warn => `<li>${warn}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return html;
        }

        function generateAtmosphericSection(atmospheric) {
            if (!atmospheric || !atmospheric.bestMatch) return '';
            
            const bestMatch = atmospheric.bestMatch;
            const phenomenon = bestMatch.phenomenon || {};
            const hasStrongMatch = atmospheric.hasStrongMatch;
            const topMatches = atmospheric.topMatches || [];
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-cloud-lightning"></i> Comparaci√≥n Atmosf√©rica (23 Fen√≥menos)
                            <small class="text-muted">- Capa 8</small>
                        </h6>
            `;
            
            if (phenomenon.name) {
                html += `
                    <div class="alert ${hasStrongMatch ? 'alert-warning' : 'alert-info'}">
                        <h6 class="alert-heading">
                            ${hasStrongMatch ? '<i class="bi bi-exclamation-triangle"></i>' : '<i class="bi bi-info-circle"></i>'}
                            Mejor Coincidencia: ${phenomenon.name}
                        </h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Categor√≠a:</strong> ${phenomenon.category || 'N/A'}</p>
                                <p><strong>Rareza:</strong> ${phenomenon.rarity || 'N/A'}</p>
                                <p><strong>Score:</strong> ${bestMatch.score || 0}/100</p>
                                <p><strong>Confianza:</strong> ${bestMatch.confidence || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar ${hasStrongMatch ? 'bg-warning' : 'bg-info'}" 
                                         style="width: ${bestMatch.score || 0}%">
                                        ${bestMatch.score || 0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${bestMatch.explanation ? `
                            <p class="mt-3 mb-0"><strong>Explicaci√≥n:</strong> ${bestMatch.explanation}</p>
                        ` : ''}
                        ${phenomenon.description ? `
                            <p class="mt-2 mb-0"><small><strong>Descripci√≥n:</strong> ${phenomenon.description}</small></p>
                        ` : ''}
                    </div>
                `;
                
                if (topMatches.length > 1) {
                    html += `
                        <div class="mt-3">
                            <h6>Otras Coincidencias:</h6>
                            <ul class="list-group">
                                ${topMatches.slice(0, 5).map(match => `
                                    <li class="list-group-item">
                                        <strong>${match.phenomenon?.name || 'N/A'}</strong> 
                                        - Score: ${match.score || 0}/100
                                        <br><small>${match.phenomenon?.description || ''}</small>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
            } else {
                html += `
                    <p class="text-muted">No se encontraron coincidencias atmosf√©ricas significativas.</p>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        // ========== FIN DE NUEVAS FUNCIONES ==========

        function getCategoryBadge(category) {
            const badges = {
                'aircraft': '<span class="badge bg-primary">Aeronave</span>',
                'bird': '<span class="badge bg-success">Ave</span>',
                'drone': '<span class="badge bg-info">Drone</span>',
                'celestial': '<span class="badge bg-warning">Objeto Celestial</span>',
                'balloon': '<span class="badge bg-secondary">Globo</span>',
                'natural': '<span class="badge bg-success">Fen√≥meno Natural</span>',
                'hoax': '<span class="badge bg-danger">Posible Fraude</span>',
                'uap': '<span class="badge bg-dark">UAP/OVNI</span>',
                'unknown': '<span class="badge bg-secondary">Desconocido</span>'
            };

            return badges[category.toLowerCase()] || `<span class="badge bg-secondary">${category}</span>`;
        }

        // Funciones auxiliares
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-secondary">Pendiente</span>',
                'uploading': '<span class="badge bg-info">Subiendo</span>',
                'analyzing': '<span class="badge bg-warning">Analizando</span>',
                'completed': '<span class="badge bg-success">Completado</span>',
                'error': '<span class="badge bg-danger">Error</span>'
            };
            return badges[status] || badges['pending'];
        }

        // ========== FUNCIONES AUXILIARES FORMULARIO CONTEXTO ==========

        // Actualizar valor de velocidad
        document.getElementById('contextSpeed').addEventListener('input', (e) => {
            const value = e.target.value;
            const labels = ['Muy lento', 'Lento', 'Normal', 'R√°pido', 'Muy r√°pido'];
            document.getElementById('speedValue').textContent = labels[value - 1];
        });

        // Toggle n√∫mero de testigos
        function toggleWitnessCount() {
            const accompanied = document.getElementById('contextAccompanied').value === 'true';
            const witnessCountInput = document.getElementById('contextWitnessCount');
            witnessCountInput.style.display = accompanied ? 'block' : 'none';
            if (accompanied) {
                witnessCountInput.value = 2;
            }
        }

        // Toggle avistamientos previos
        function togglePreviousCount() {
            const hasPrevious = document.getElementById('contextPreviousSightings').value === 'true';
            const previousCountInput = document.getElementById('contextPreviousCount');
            previousCountInput.style.display = hasPrevious ? 'block' : 'none';
            if (hasPrevious) {
                previousCountInput.value = 1;
            }
        }

        function showUploadAlert(message, type) {
            const container = document.getElementById('uploadAlertContainer');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        function showLibraryNotification(message) {
            const container = document.getElementById('libraryAdminMsg') || document.querySelector('.admin-msg');
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-info alert-dismissible fade show">
                        üì° ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                setTimeout(() => container.innerHTML = '', 4000);
            } else {
                console.log('üì° Notificaci√≥n biblioteca:', message);
            }
        }

        // Cargar uploads al mostrar la secci√≥n
        document.querySelector('a[onclick*="uploads"]').addEventListener('click', () => {
            loadUploads();
        });

        // ========== FUNCIONES DE REPORTES ==========

        async function loadReports() {
            const token = localStorage.getItem('token');
            const container = document.getElementById('reportsListContainer');

            try {
                // Obtener filtros
                const category = document.getElementById('filterCategory')?.value || '';
                const status = document.getElementById('filterStatus')?.value || '';
                const search = document.getElementById('searchReports')?.value || '';

                // Construir query params
                let queryParams = '?limit=100';
                if (status) queryParams += `&status=${status}`;
                if (category) queryParams += `&category=${category}`;

                const response = await fetch(`${API_URL}/api/uploads${queryParams}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al obtener reportes');
                }

                const data = await response.json();
                
                // Filtrar por b√∫squeda local
                let analyses = data.analyses || data || [];
                if (!Array.isArray(analyses)) {
                    analyses = [];
                }

                if (search) {
                    analyses = analyses.filter(a => 
                        (a.fileName || a.filename || '').toLowerCase().includes(search.toLowerCase())
                    );
                }

                // Actualizar estad√≠sticas
                updateReportStats(analyses);

                // Mostrar lista
                if (analyses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox" style="font-size: 48px;"></i>
                            <p class="mt-2">No se encontraron reportes</p>
                        </div>
                    `;
                    return;
                }

                // Generar lista de reportes
                container.innerHTML = analyses.map(analysis => generateReportCard(analysis)).join('');

            } catch (error) {
                console.error('Error al cargar reportes:', error);
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        No hay reportes disponibles o hubo un error al cargarlos.
                    </div>
                `;
                // Mostrar estad√≠sticas vac√≠as
                document.getElementById('totalReports').textContent = '0';
                document.getElementById('completedReports').textContent = '0';
                document.getElementById('uapReports').textContent = '0';
                document.getElementById('avgConfidence').textContent = '0%';
            }
        }

        function generateReportCard(analysis) {
            const statusBadge = getStatusBadge(analysis.status || 'pending');
            const categoryBadge = analysis.bestMatch?.category ? 
                getCategoryBadge(analysis.bestMatch.category) : 
                '<span class="badge bg-secondary">Sin categor√≠a</span>';
            
            const confidence = Math.round((analysis.aiAnalysis?.confidence || analysis.bestMatch?.matchPercentage || 0) * 100) / 100;
            const fileName = analysis.fileName || analysis.filename || 'Sin nombre';
            const uploadDate = analysis.uploadDate || analysis.uploadedAt || new Date().toISOString();
            const date = new Date(uploadDate).toLocaleString('es-ES');
            const analysisId = analysis.id || analysis._id || 'unknown';
            
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-2">
                                    <i class="bi bi-image"></i> ${fileName}
                                </h5>
                                <div class="mb-2">
                                    ${statusBadge} ${categoryBadge}
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> ${date}
                                </small>
                            </div>
                            <div class="col-md-3 text-center">
                                ${analysis.status === 'completed' ? `
                                    <div class="mb-2">
                                        <strong>Confianza</strong>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${getConfidenceColor(confidence)}" 
                                             style="width: ${confidence}%">
                                            ${confidence}%
                                        </div>
                                    </div>
                                ` : '<span class="text-muted">‚Äî</span>'}
                            </div>
                            <div class="col-md-3 text-end">
                                ${analysis.status === 'completed' ? `
                                    <button class="btn btn-sm btn-success" onclick="viewAnalysis('${analysisId}')" title="Ver an√°lisis">
                                        <i class="bi bi-eye"></i> Ver Detalles
                                    </button>
                                ` : ''}
                                ${analysis.status === 'pending' ? `
                                    <button class="btn btn-sm btn-primary" onclick="analyzeImage('${analysisId}')" title="Analizar">
                                        <i class="bi bi-robot"></i> Analizar
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-danger ms-1" onclick="deleteUpload('${analysisId}')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        ${analysis.status === 'completed' && analysis.aiAnalysis?.description ? `
                            <div class="mt-3 pt-3 border-top">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> ${analysis.aiAnalysis.description.substring(0, 150)}...
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function updateReportStats(analyses) {
            document.getElementById('totalReports').textContent = analyses.length;
            
            const completed = analyses.filter(a => a.status === 'completed').length;
            document.getElementById('completedReports').textContent = completed;
            
            const uaps = analyses.filter(a => 
                (a.bestMatch?.category === 'uap' || 
                 a.aiAnalysis?.category === 'uap' ||
                 (a.analysis?.results?.classification && a.analysis.results.classification.toLowerCase().includes('uap')))
            ).length;
            document.getElementById('uapReports').textContent = uaps;
            
            const confidences = analyses
                .filter(a => a.status === 'completed')
                .map(a => {
                    const conf = a.aiAnalysis?.confidence || a.bestMatch?.matchPercentage || a.analysis?.results?.confidence || 0;
                    return Math.min(100, Math.max(0, conf * (conf <= 1 ? 100 : 1)));
                });
            
            const avgConf = confidences.length > 0 
                ? Math.round(confidences.reduce((a, b) => a + b, 0) / confidences.length)
                : 0;
            
            document.getElementById('avgConfidence').textContent = avgConf + '%';
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 70) return 'bg-success';
            if (confidence >= 40) return 'bg-warning';
            return 'bg-danger';
        }

        function clearFilters() {
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('searchReports').value = '';
            loadReports();
        }

        // ==================== FUNCIONES DE TRAINING ====================
        
        // Convertir an√°lisis a imagen de entrenamiento
        async function convertToTraining(analysisId) {
            if (!confirm('¬øDeseas agregar este an√°lisis a la base de datos de entrenamiento?\n\nEsto permitir√° mejorar la precisi√≥n del sistema para futuros an√°lisis.')) {
                return;
            }

            const modalHtml = `
                <div class="modal fade" id="trainingModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-database-add"></i> Agregar a Training
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="trainingForm">
                                    <div class="mb-3">
                                        <label class="form-label">Categor√≠a Verificada</label>
                                        <select class="form-control" id="verifiedCategory">
                                            <option value="">-- Usar categor√≠a del an√°lisis --</option>
                                            <option value="aircraft_commercial">Avi√≥n Comercial</option>
                                            <option value="drone">Dron/UAV</option>
                                            <option value="helicopter">Helic√≥ptero</option>
                                            <option value="satellite">Sat√©lite</option>
                                            <option value="celestial">Objeto Celestial</option>
                                            <option value="bird">Ave</option>
                                            <option value="natural">Fen√≥meno Natural</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Tipo/Modelo (opcional)</label>
                                        <input type="text" class="form-control" id="verifiedType" placeholder="Ej: Boeing 737">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notas (opcional)</label>
                                        <textarea class="form-control" id="additionalNotes" rows="2"></textarea>
                                    </div>
                                    <div class="alert alert-info small">
                                        <i class="bi bi-info-circle"></i> Incluir√° datos forenses autom√°ticamente.
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-success" onclick="submitTrainingConversion('${analysisId}')">
                                    <i class="bi bi-check-circle"></i> Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const analysisModal = bootstrap.Modal.getInstance(document.getElementById('analysisModal'));
            if (analysisModal) analysisModal.hide();

            const existingModal = document.getElementById('trainingModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('trainingModal'));
            modal.show();
        }

        async function submitTrainingConversion(analysisId) {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/training/from-analysis/${analysisId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        verifiedCategory: document.getElementById('verifiedCategory').value || undefined,
                        verifiedType: document.getElementById('verifiedType').value || undefined,
                        additionalNotes: document.getElementById('additionalNotes').value || undefined
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('trainingModal'));
                    if (modal) modal.hide();
                    showAlert('success', `‚úÖ Agregado a training: ${data.trainingImage.category}`);
                    loadAnalyses();
                } else {
                    const error = await response.json();
                    showAlert('danger', `Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('danger', 'Error de conexi√≥n');
            }
        }

        // ==================== FUNCIONES DE REPORTES ====================
        
        // Abrir formulario de reporte
        function openReportForm(analysisId) {
            const modalHtml = `
                <div class="modal fade" id="reportModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-file-earmark-text"></i> Generar Informe UAP
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="reportForm">
                                    <input type="hidden" id="reportAnalysisId" value="${analysisId}">
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        Complete los siguientes campos para generar un informe profesional en PDF del avistamiento.
                                    </div>

                                    <!-- Descripci√≥n del fen√≥meno -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <strong>Descripci√≥n del fen√≥meno observado *</strong>
                                        </label>
                                        <textarea 
                                            class="form-control" 
                                            id="reportSituation" 
                                            rows="4" 
                                            required
                                            placeholder="Describa detalladamente lo que observ√≥..."
                                        ></textarea>
                                        <small class="text-muted">M√°ximo 2000 caracteres</small>
                                    </div>

                                    <!-- Ubicaci√≥n -->
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label class="form-label"><strong>Ubicaci√≥n del avistamiento *</strong></label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="reportLocation" 
                                                required
                                                placeholder="Ej: Madrid, Espa√±a o coordenadas GPS"
                                            >
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label"><strong>Fecha y Hora *</strong></label>
                                            <input 
                                                type="datetime-local" 
                                                class="form-control" 
                                                id="reportDatetime" 
                                                required
                                            >
                                        </div>
                                    </div>

                                    <!-- Testigos y duraci√≥n -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>N√∫mero de testigos</strong></label>
                                            <input 
                                                type="number" 
                                                class="form-control" 
                                                id="reportWitnesses" 
                                                min="1" 
                                                value="1"
                                            >
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Duraci√≥n aproximada</strong></label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="reportDuration" 
                                                placeholder="Ej: 5 minutos, 30 segundos"
                                            >
                                        </div>
                                    </div>

                                    <!-- Condiciones -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Condiciones clim√°ticas</strong></label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="reportWeather" 
                                                placeholder="Ej: Despejado, Nublado"
                                            >
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Visibilidad</strong></label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="reportVisibility" 
                                                placeholder="Ej: Buena, Excelente"
                                            >
                                        </div>
                                    </div>

                                    <!-- Notas adicionales -->
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Notas adicionales</strong></label>
                                        <textarea 
                                            class="form-control" 
                                            id="reportNotes" 
                                            rows="3"
                                            placeholder="Cualquier informaci√≥n adicional relevante..."
                                        ></textarea>
                                    </div>

                                    <!-- Informaci√≥n de contacto (opcional) -->
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Informaci√≥n de contacto (opcional)</strong></label>
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="reportContact" 
                                            placeholder="Nombre y email para seguimiento"
                                        >
                                    </div>

                                    <div id="reportFormMsg" class="mt-2"></div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="submitReport()">
                                    <i class="bi bi-file-pdf"></i> Generar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Eliminar modal previo
            const existingModal = document.getElementById('reportModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Agregar y mostrar modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();

            // Establecer fecha actual por defecto
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('reportDatetime').value = now.toISOString().slice(0, 16);
        }

        // Enviar formulario de reporte
        async function submitReport() {
            const token = localStorage.getItem('token');
            const msgDiv = document.getElementById('reportFormMsg');

            try {
                // Obtener datos del formulario
                const analysisId = document.getElementById('reportAnalysisId').value;
                const situation = document.getElementById('reportSituation').value;
                const location = document.getElementById('reportLocation').value;
                const datetime = document.getElementById('reportDatetime').value;
                const witnesses = document.getElementById('reportWitnesses').value;
                const duration = document.getElementById('reportDuration').value;
                const weatherConditions = document.getElementById('reportWeather').value;
                const visibility = document.getElementById('reportVisibility').value;
                const additionalNotes = document.getElementById('reportNotes').value;
                const contactInfo = document.getElementById('reportContact').value;

                // Validar campos requeridos
                if (!situation || !location || !datetime) {
                    msgDiv.innerHTML = '<div class="alert alert-warning">Por favor, complete todos los campos requeridos (*)</div>';
                    return;
                }

                msgDiv.innerHTML = '<div class="alert alert-info">Creando reporte...</div>';

                // Paso 1: Crear reporte (borrador)
                const createResponse = await fetch(`${API_URL}/api/reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        analysisId,
                        situation,
                        location,
                        datetime,
                        witnesses: parseInt(witnesses) || 1,
                        duration,
                        weatherConditions,
                        visibility,
                        additionalNotes,
                        contactInfo
                    })
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'Error al crear reporte');
                }

                const { report: createdReport } = await createResponse.json();
                msgDiv.innerHTML = '<div class="alert alert-info">Generando PDF...</div>';

                // Paso 2: Generar PDF
                const generateResponse = await fetch(`${API_URL}/api/reports/${createdReport._id}/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!generateResponse.ok) {
                    const error = await generateResponse.json();
                    throw new Error(error.error || 'Error al generar PDF');
                }

                const { downloadUrl, report: generatedReport } = await generateResponse.json();

                msgDiv.innerHTML = '<div class="alert alert-success">¬°PDF generado exitosamente! Descargando...</div>';

                // Descargar PDF con autenticaci√≥n
                setTimeout(async () => {
                    try {
                        // Fetch del PDF con token
                        const pdfResponse = await fetch(`${API_URL}${downloadUrl}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (!pdfResponse.ok) {
                            throw new Error('Error al descargar PDF');
                        }

                        // Convertir respuesta a blob
                        const blob = await pdfResponse.blob();
                        
                        // Crear URL temporal del blob
                        const url = window.URL.createObjectURL(blob);
                        
                        // Crear enlace temporal y hacer clic
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = generatedReport.pdfFileName || `UAP-Report-${generatedReport.reportNumber}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        
                        // Limpiar
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        // Cerrar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                        modal.hide();

                        // Mostrar notificaci√≥n
                        showUploadAlert('Reporte generado y descargado exitosamente.', 'success');
                        
                    } catch (downloadError) {
                        console.error('Error al descargar PDF:', downloadError);
                        showUploadAlert('PDF generado pero hubo un error al descargarlo. Intenta descargarlo desde "Mis Reportes".', 'warning');
                    }
                }, 1000);

            } catch (error) {
                console.error('Error al generar reporte:', error);
                msgDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        // ==================== FIN FUNCIONES REPORTES ====================

        // ==================== NOTIFICACIONES ====================
        
        // Cargar contador de notificaciones no le√≠das
        async function loadNotificationCount() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch(`${API_URL}/api/notifications/unread/count`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notificationBadge');
                    
                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error al cargar notificaciones:', error);
            }
        }

        // Actualizar notificaciones cada 30 segundos
        setInterval(loadNotificationCount, 30000);

        // ==================== FIN NOTIFICACIONES ====================

        // ==================== TRAINING DATA MANAGEMENT ====================
        
        let trainingCurrentPage = 1;
        const trainingPageSize = 10;

        // Contador de keywords
        document.getElementById('trainingKeywords')?.addEventListener('input', function(e) {
            const keywords = e.target.value.split(',').map(k => k.trim()).filter(k => k.length > 0);
            const count = keywords.length;
            const counterEl = document.getElementById('keywordCount');
            
            if (count > 20) {
                counterEl.innerHTML = `<span class="text-danger">${count} / 20 keywords (excede el l√≠mite)</span>`;
                e.target.classList.add('is-invalid');
            } else {
                counterEl.innerHTML = `${count} / 20 keywords`;
                e.target.classList.remove('is-invalid');
            }
        });

        // Preview de imagen antes de subir
        document.getElementById('trainingImage')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('trainingPreviewImg').src = event.target.result;
                    document.getElementById('trainingPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Subir imagen de entrenamiento
        document.getElementById('trainingUploadForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const msgDiv = document.getElementById('trainingUploadMsg');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Subiendo...';

                const formData = new FormData();
                formData.append('image', document.getElementById('trainingImage').files[0]);
                formData.append('category', document.getElementById('trainingCategory').value);
                formData.append('type', document.getElementById('trainingType').value);
                formData.append('model', document.getElementById('trainingModel').value || '');
                formData.append('description', document.getElementById('trainingDescription').value);
                
                // Parsear keywords (separadas por comas)
                const keywordsInput = document.getElementById('trainingKeywords').value;
                const keywords = keywordsInput.split(',').map(k => k.trim()).filter(k => k.length > 0);
                
                // Validar m√°ximo 20 keywords
                if (keywords.length > 20) {
                    msgDiv.innerHTML = `<div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> M√°ximo 20 palabras clave permitidas (tienes ${keywords.length})
                    </div>`;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-upload"></i> Subir Imagen';
                    return;
                }
                
                formData.append('keywords', JSON.stringify(keywords));

                const response = await fetch(`${API_URL}/api/training`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    msgDiv.innerHTML = `<div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> ${data.message || 'Imagen subida exitosamente'}
                    </div>`;
                    
                    // Limpiar formulario
                    document.getElementById('trainingUploadForm').reset();
                    document.getElementById('trainingPreview').style.display = 'none';
                    
                    // Recargar lista y stats
                    loadTrainingImages();
                    loadTrainingStats();
                } else {
                    msgDiv.innerHTML = `<div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error || 'Error al subir imagen'}
                    </div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                msgDiv.innerHTML = `<div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error de conexi√≥n: ${error.message}
                </div>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-upload"></i> Subir Imagen';
                
                // Limpiar mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    msgDiv.innerHTML = '';
                }, 5000);
            }
        });

        // Cargar im√°genes de entrenamiento
        async function loadTrainingImages(page = 1) {
            const token = localStorage.getItem('token');
            const container = document.getElementById('trainingImagesContainer');

            try {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                `;

                const category = document.getElementById('trainingFilterCategory').value;
                const verified = document.getElementById('trainingFilterVerified').value;
                
                let url = `${API_URL}/api/training?page=${page}&limit=${trainingPageSize}`;
                if (category) url += `&category=${category}`;
                if (verified) url += `&verified=${verified}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar im√°genes');
                }

                const data = await response.json();

                if (data.images && data.images.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-hover">';
                    html += `
                        <thead>
                            <tr>
                                <th>Miniatura</th>
                                <th>Categor√≠a</th>
                                <th>Tipo</th>
                                <th>Descripci√≥n</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                    data.images.forEach(img => {
                        const categoryNames = {
                            'aircraft_commercial': 'Avi√≥n Comercial',
                            'aircraft_military': 'Avi√≥n Militar',
                            'drone': 'Drone',
                            'helicopter': 'Helic√≥ptero',
                            'balloon': 'Globo',
                            'satellite': 'Sat√©lite',
                            'bird': 'Ave',
                            'natural': 'Fen√≥meno Natural',
                            'celestial': 'Celeste',
                            'lens_flare': 'Destello',
                            'weather': 'Meteorol√≥gico',
                            'hoax': 'Fake/Hoax',
                            'unknown': 'Desconocido'
                        };

                        // SIMPLIFICADO: Construcci√≥n de URLs de imagen
                        let thumbnailUrl = null;
                        let fullImageUrl = null;
                        
                        // Prioridad: fullImageUrl > imageUrl > thumbnailUrl
                        if (img.fullImageUrl) {
                            fullImageUrl = img.fullImageUrl.startsWith('http') ? img.fullImageUrl : `${API_URL}${img.fullImageUrl}`;
                            thumbnailUrl = img.thumbnailUrl ? 
                                (img.thumbnailUrl.startsWith('http') ? img.thumbnailUrl : `${API_URL}${img.thumbnailUrl}`) : 
                                fullImageUrl;
                        } else if (img.imageUrl) {
                            fullImageUrl = img.imageUrl.startsWith('http') ? img.imageUrl : `${API_URL}${img.imageUrl}`;
                            thumbnailUrl = img.thumbnailUrl ? 
                                (img.thumbnailUrl.startsWith('http') ? img.thumbnailUrl : `${API_URL}${img.thumbnailUrl}`) : 
                                fullImageUrl;
                        } else if (img.thumbnailUrl) {
                            thumbnailUrl = img.thumbnailUrl.startsWith('http') ? img.thumbnailUrl : `${API_URL}${img.thumbnailUrl}`;
                            fullImageUrl = thumbnailUrl;
                        }

                        html += `
                            <tr>
                                <td class="text-center">
                                    ${thumbnailUrl ? `
                                        <div style="width: 80px; height: 80px; display: inline-block; position: relative; background: #f8f9fa; border-radius: 4px; overflow: hidden;">
                                            <img src="${thumbnailUrl}" 
                                                 class="img-thumbnail" 
                                                 style="width: 100%; height: 100%; cursor: pointer; object-fit: cover;"
                                                 onclick="window.open('${fullImageUrl}', '_blank')"
                                                 onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                 alt="${escapeHtml(img.type || 'Sin tipo')}">
                                            <div class="placeholder-text" style="display: none; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 11px; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                                <i class="bi bi-image"></i><br>Sin imagen
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; background: #e9ecef; border-radius: 4px;">
                                            <div class="text-muted" style="font-size: 11px; text-align: center;">
                                                <i class="bi bi-image"></i><br>Sin imagen
                                            </div>
                                        </div>
                                    `}
                                </td>
                                <td>
                                    <span class="badge bg-primary">${categoryNames[img.category] || img.category}</span>
                                </td>
                                <td><strong>${escapeHtml(img.type)}</strong></td>
                                <td class="small text-muted" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                    ${img.description ? escapeHtml(img.description) : '-'}
                                </td>
                                <td>
                                    ${img.verified ? 
                                        '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Verificada</span>' : 
                                        '<span class="badge bg-warning"><i class="bi bi-clock"></i> Pendiente</span>'
                                    }
                                    ${img.isActive ? '' : '<span class="badge bg-secondary">Inactiva</span>'}
                                </td>
                                <td class="small text-muted">
                                    ${new Date(img.createdAt).toLocaleDateString('es-ES')}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        ${!img.promotedToLibrary ? `
                                            <button class="btn btn-success" 
                                                    onclick="promoteToLibrary('${img._id}')" 
                                                    title="Promover a Biblioteca Visual">
                                                <i class="bi bi-book"></i>
                                            </button>
                                        ` : `
                                            <button class="btn btn-secondary" disabled
                                                    title="Ya est√° en Biblioteca Visual">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        `}
                                        <button class="btn btn-danger" 
                                                onclick="deleteTrainingImage('${img._id}')" 
                                                title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table></div>';
                    container.innerHTML = html;

                    // Paginaci√≥n
                    renderTrainingPagination(data.pagination);
                } else {
                    container.innerHTML = `
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> No hay im√°genes de entrenamiento a√∫n.
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar im√°genes: ${error.message}
                    </div>
                `;
            }
        }

        // Renderizar paginaci√≥n
        function renderTrainingPagination(pagination) {
            const container = document.getElementById('trainingPagination');
            if (!pagination || pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<ul class="pagination justify-content-center">';
            
            // Bot√≥n anterior
            html += `
                <li class="page-item ${pagination.currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadTrainingImages(${pagination.currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;

            // P√°ginas
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) {
                    html += `
                        <li class="page-item ${i === pagination.currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadTrainingImages(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Bot√≥n siguiente
            html += `
                <li class="page-item ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadTrainingImages(${pagination.currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;

            html += '</ul>';
            container.innerHTML = html;
        }

        // Ver imagen en modal
        function viewTrainingImage(url, title) {
            const modalHtml = `
                <div class="modal fade" id="imageViewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="${url}" class="img-fluid" alt="${title}">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('imageViewModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('imageViewModal'));
            modal.show();
        }

        // Eliminar imagen de entrenamiento
        async function deleteTrainingImage(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta imagen de entrenamiento?')) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/training/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Imagen eliminada exitosamente');
                    loadTrainingImages();
                    loadTrainingStats();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar la imagen'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        // Promover imagen de entrenamiento a biblioteca visual
        async function promoteToLibrary(id) {
            if (!confirm('¬øDeseas promover esta imagen a la Biblioteca Visual?\n\nEsto la har√° visible p√∫blicamente y estar√° disponible para matching con an√°lisis.')) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                showUploadAlert('Promoviendo a biblioteca visual...', 'info');

                const response = await fetch(`${API_URL}/api/training/${id}/promote-to-library`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showUploadAlert(`‚úÖ ${data.message}\n\nNombre: ${data.libraryEntry.name}\nCategor√≠a: ${data.libraryEntry.category}`, 'success');
                    loadTrainingImages(); // Recargar lista para actualizar estado
                } else {
                    showUploadAlert('‚ùå Error: ' + (data.error || 'No se pudo promover la imagen'), 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showUploadAlert('‚ùå Error de conexi√≥n: ' + error.message, 'danger');
            }
        }

        // ============================================
        // BIBLIOTECA VISUAL - GESTI√ìN MANUAL (ADMIN)
        // ============================================

        // Preview de im√°genes antes de subir
        document.getElementById('libraryImages')?.addEventListener('change', function(e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('libraryImagesPreview');
            previewContainer.innerHTML = '';
            
            if (files.length > 0) {
                previewContainer.style.display = 'flex';
                
                Array.from(files).slice(0, 5).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const col = document.createElement('div');
                        col.className = 'col-md-2 mb-2';
                        col.innerHTML = `
                            <div class="card">
                                <img src="${event.target.result}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-1 text-center">
                                    <small class="text-muted">Imagen ${index + 1}</small>
                                </div>
                            </div>
                        `;
                        previewContainer.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                previewContainer.style.display = 'none';
            }
        });

        // Crear objeto en biblioteca
        document.getElementById('libraryObjectForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const msgDiv = document.getElementById('libraryFormMsg');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creando...';

                const formData = new FormData();
                formData.append('name', document.getElementById('libraryName').value);
                formData.append('category', document.getElementById('libraryCategory').value);
                formData.append('typology', document.getElementById('libraryTypology').value || '');
                formData.append('description', document.getElementById('libraryDescription').value);

                // Keywords
                const keywordsInput = document.getElementById('libraryKeywords').value;
                const keywords = keywordsInput.split(',').map(k => k.trim()).filter(k => k.length > 0);
                formData.append('keywords', JSON.stringify(keywords));

                // Visual patterns
                const patternsInput = document.getElementById('libraryVisualPatterns').value;
                const patterns = patternsInput.split(',').map(p => p.trim()).filter(p => p.length > 0);
                formData.append('visualPatterns', JSON.stringify(patterns));

                // Caracter√≠sticas
                const characteristics = {
                    shape: document.getElementById('libraryShape').value || null,
                    size: document.getElementById('librarySize').value || null,
                    speed: document.getElementById('librarySpeed').value || null,
                    luminosity: document.getElementById('libraryLuminosity').value || null,
                    color: (document.getElementById('libraryColors').value || '').split(',').map(c => c.trim()).filter(c => c),
                    behavior: document.getElementById('libraryBehavior').value || null
                };
                formData.append('characteristics', JSON.stringify(characteristics));

                // Im√°genes
                const imageFiles = document.getElementById('libraryImages').files;
                if (imageFiles.length === 0) {
                    msgDiv.innerHTML = `<div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Debes subir al menos una imagen
                    </div>`;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Crear Objeto';
                    return;
                }

                for (let i = 0; i < imageFiles.length && i < 5; i++) {
                    formData.append('images', imageFiles[i]);
                }

                const response = await fetch(`${API_URL}/api/library/manual`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    msgDiv.innerHTML = `<div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> ${data.message}
                        <br><small>Sincronizado autom√°ticamente con sistema de entrenamiento</small>
                    </div>`;
                    
                    // Limpiar formulario
                    document.getElementById('libraryObjectForm').reset();
                    document.getElementById('libraryImagesPreview').style.display = 'none';
                    document.getElementById('libraryImagesPreview').innerHTML = '';
                    
                    // Recargar lista
                    loadLibraryObjects();

                    // Limpiar mensaje despu√©s de 5s
                    setTimeout(() => {
                        msgDiv.innerHTML = '';
                    }, 5000);
                } else {
                    msgDiv.innerHTML = `<div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error || 'Error al crear objeto'}
                    </div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                msgDiv.innerHTML = `<div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> Error de conexi√≥n: ${error.message}
                </div>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Crear Objeto';
            }
        });

        // Variable global para paginaci√≥n de biblioteca
        let currentLibraryPage = 1;
        let librarySearchTimeout = null;

        // Funci√≥n global para limpiar modales bloqueados (√∫til para debugging)
        window.clearAllModals = function() {
            console.log('üßπ Limpiando TODOS los modales y backdrops...');
            
            // Destruir todas las instancias de modales
            document.querySelectorAll('.modal').forEach(modal => {
                const instance = bootstrap.Modal.getInstance(modal);
                if (instance) {
                    instance.dispose();
                }
                modal.classList.remove('show');
                modal.style.display = '';
                modal.setAttribute('aria-hidden', 'true');
                modal.removeAttribute('aria-modal');
                modal.removeAttribute('role');
            });
            
            // Limpiar todos los backdrops
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            
            // Limpiar body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            console.log('‚úÖ Limpieza global completada. Puedes usar los modales nuevamente.');
        };

        // Cargar TODOS los objetos de biblioteca con paginaci√≥n y filtros
        async function loadLibraryObjects(page = 1) {
            const token = localStorage.getItem('token');
            const container = document.getElementById('libraryObjectsContainer');
            const countElement = document.getElementById('libraryTotalCount');

            currentLibraryPage = page;

            try {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                `;

                // Obtener filtros
                const category = document.getElementById('libraryFilterCategory')?.value || '';
                const isManual = document.getElementById('libraryFilterManual')?.value || '';
                const search = document.getElementById('librarySearchBox')?.value || '';
                const limit = parseInt(document.getElementById('libraryPageSize')?.value || '25');

                // Construir URL con par√°metros
                let url = `${API_URL}/api/library/objects?page=${page}&limit=${limit}`;
                if (category) url += `&category=${category}`;
                if (isManual) url += `&isManualEntry=${isManual}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar objetos');
                }

                const result = await response.json();
                const objects = result.data || [];
                const totalObjects = result.pagination?.total || 0;
                const totalPages = result.pagination?.totalPages || 1;

                // Actualizar contador
                if (countElement) {
                    countElement.textContent = totalObjects;
                }

                if (objects.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No se encontraron objetos con los filtros aplicados.
                        </div>
                    `;
                    document.getElementById('libraryPagination').innerHTML = '';
                    return;
                }

                // Generar tabla
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">Imagen</th>
                                    <th>Nombre</th>
                                    <th style="width: 120px;">Categor√≠a</th>
                                    <th style="width: 120px;">Tipolog√≠a</th>
                                    <th>Descripci√≥n</th>
                                    <th style="width: 80px;">Imgs</th>
                                    <th style="width: 100px;">Tipo</th>
                                    <th style="width: 150px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                objects.forEach(obj => {
                    // Imagen: priorizar manualImages, luego imageUrl
                    let firstImage = null;
                    let imageAlt = obj.name;
                    
                    if (obj.manualImages && obj.manualImages.length > 0) {
                        const img = obj.manualImages[0];
                        // Usar thumbnailUrl si existe, sino url completa
                        const imgPath = img.thumbnailUrl || img.url;
                        firstImage = imgPath.startsWith('http') ? imgPath : `${API_URL}${imgPath}`;
                    } else if (obj.imageUrl) {
                        firstImage = obj.imageUrl.startsWith('http') ? obj.imageUrl : `${API_URL}${obj.imageUrl}`;
                    }

                    const description = (obj.description || 'Sin descripci√≥n').substring(0, 80);
                    const truncatedDesc = description.length >= 80 ? description + '...' : description;
                    const imageCount = (obj.manualImages?.length || 0) + (obj.imageUrl ? 1 : 0);
                    const typeLabel = obj.isManualEntry ? 
                        '<span class="badge bg-success">Manual</span>' : 
                        '<span class="badge bg-secondary">Original</span>';
                    const hasTraining = obj.linkedTrainingId ? 
                        '<i class="bi bi-link-45deg text-success" title="Vinculado a Training"></i>' : '';

                    html += `
                        <tr>
                            <td>
                                ${firstImage ? `
                                    <img src="${firstImage}" 
                                         alt="${imageAlt}" 
                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; background: #f8f9fa;"
                                         onclick="window.open('${firstImage}', '_blank')"
                                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'width:60px;height:60px;background:#e9ecef;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#999;\\'>Sin imagen</div>';">
                                ` : `
                                    <div style="width:60px;height:60px;background:#e9ecef;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#999;">
                                        <i class="bi bi-image"></i>
                                    </div>
                                `}
                            </td>
                            <td>
                                <strong>${obj.name}</strong>
                                ${hasTraining}
                            </td>
                            <td><span class="badge bg-primary">${obj.category}</span></td>
                            <td><small>${obj.typology || '<em class="text-muted">N/A</em>'}</small></td>
                            <td><small class="text-muted">${truncatedDesc}</small></td>
                            <td class="text-center">
                                <span class="badge bg-info">${imageCount}</span>
                            </td>
                            <td>${typeLabel}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-library-btn" 
                                            data-id="${obj._id}"
                                            title="Editar objeto">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    ${obj.isManualEntry ? `
                                    <button class="btn btn-outline-danger" 
                                            onclick="deleteLibraryObject('${obj._id}', '${escapeHtml(obj.name)}')"
                                            title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="text-muted small mt-2">
                        Mostrando ${objects.length} de ${totalObjects} objetos (P√°gina ${page} de ${totalPages})
                    </div>
                `;

                container.innerHTML = html;

                // Generar paginaci√≥n
                generateLibraryPagination(page, totalPages);

            } catch (error) {
                console.error('Error cargando objetos:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Error al cargar objetos: ${error.message}
                    </div>
                `;
            }
        }

        // Generar controles de paginaci√≥n
        function generateLibraryPagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById('libraryPagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let html = '<ul class="pagination pagination-sm justify-content-center">';

            // Bot√≥n anterior
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadLibraryObjects(${currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;

            // P√°ginas visibles (mostrar m√°x 10 p√°ginas)
            const maxVisible = 10;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            // Primera p√°gina
            if (startPage > 1) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadLibraryObjects(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // P√°ginas intermedias
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadLibraryObjects(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            // √öltima p√°gina
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadLibraryObjects(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `;
            }

            // Bot√≥n siguiente
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadLibraryObjects(${currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;

            html += '</ul>';
            paginationContainer.innerHTML = html;
        }

        // B√∫squeda con debounce
        function searchLibraryObjects() {
            clearTimeout(librarySearchTimeout);
            librarySearchTimeout = setTimeout(() => {
                loadLibraryObjects(1); // Reset a p√°gina 1 al buscar
            }, 500);
        }

        // Eliminar objeto de biblioteca
        async function deleteLibraryObject(id, name) {
            if (!confirm(`¬øEst√°s seguro de eliminar el objeto "${name}"?\n\nEsto tambi√©n eliminar√°:\n- Todas sus im√°genes\n- Su entrada vinculada en el sistema de entrenamiento\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/library/manual/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ Objeto eliminado exitosamente');
                    loadLibraryObjects(currentLibraryPage);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'No se pudo eliminar el objeto'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        // EDITAR OBJETO DE BIBLIOTECA (NUEVA VENTANA)
        // ============================================
        function editLibraryObject(id) {
            // Abrir nueva ventana con formulario de edici√≥n
            const editWindow = window.open(
                `edit-library-object.html?id=${id}`,
                '_blank',
                'width=900,height=800,scrollbars=yes,resizable=yes'
            );
            
            if (!editWindow) {
                alert('‚ö†Ô∏è Por favor permite ventanas emergentes para editar objetos.');
            }
        }

        // Submit del formulario de edici√≥n
        document.getElementById('editLibraryForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const msgDiv = document.getElementById('editLibraryFormMsg');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const objectId = document.getElementById('editLibraryId').value;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';

                const formData = new FormData();
                formData.append('name', document.getElementById('editLibraryName').value);
                formData.append('category', document.getElementById('editLibraryCategory').value);
                formData.append('typology', document.getElementById('editLibraryTypology').value || '');
                formData.append('description', document.getElementById('editLibraryDescription').value);

                // Keywords
                const keywordsInput = document.getElementById('editLibraryKeywords').value;
                if (keywordsInput) {
                    const keywordsArray = keywordsInput.split(',').map(k => k.trim()).filter(k => k);
                    formData.append('keywords', JSON.stringify(keywordsArray));
                }

                // Visual Patterns
                const vpInput = document.getElementById('editLibraryVisualPatterns').value;
                if (vpInput) {
                    const vpArray = vpInput.split(',').map(v => v.trim()).filter(v => v);
                    formData.append('visualPatterns', JSON.stringify(vpArray));
                }

                // Caracter√≠sticas
                const characteristics = {
                    shape: document.getElementById('editLibraryShape').value || '',
                    size: document.getElementById('editLibrarySize').value || '',
                    speed: document.getElementById('editLibrarySpeed').value || '',
                    luminosity: document.getElementById('editLibraryLuminosity').value || '',
                    colors: document.getElementById('editLibraryColors').value || '',
                    behavior: document.getElementById('editLibraryBehavior').value || ''
                };
                formData.append('characteristics', JSON.stringify(characteristics));

                // Nuevas im√°genes
                const newImagesInput = document.getElementById('editLibraryNewImages');
                if (newImagesInput.files && newImagesInput.files.length > 0) {
                    for (let i = 0; i < newImagesInput.files.length; i++) {
                        formData.append('newImages', newImagesInput.files[i]);
                    }
                }

                const response = await fetch(`${API_URL}/api/library/edit/${objectId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    msgDiv.innerHTML = `<div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> ${data.message}
                    </div>`;

                    // Cerrar modal despu√©s de 2s
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('editLibraryModal')).hide();
                        loadLibraryObjects(currentLibraryPage);
                    }, 2000);
                } else {
                    msgDiv.innerHTML = `<div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error || 'Error al actualizar objeto'}
                    </div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                msgDiv.innerHTML = `<div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> Error de conexi√≥n: ${error.message}
                </div>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Cambios';
            }
        });

        // Event listener para limpiar cuando se cierre el modal
        const editLibraryModalElement = document.getElementById('editLibraryModal');
        if (editLibraryModalElement) {
            editLibraryModalElement.addEventListener('hidden.bs.modal', function () {
                console.log('üîí Modal cerrado, limpiando completamente...');
                
                // Limpiar TODOS los backdrops
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    backdrop.remove();
                });
                
                // Limpiar body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Resetear modal
                this.classList.remove('show');
                this.style.display = '';
                this.setAttribute('aria-hidden', 'true');
                this.removeAttribute('aria-modal');
                this.removeAttribute('role');
                
                console.log('‚úÖ Limpieza completa finalizada');
            });

            // Evento adicional para click en backdrop (cerrar con click fuera)
            editLibraryModalElement.addEventListener('click', function(e) {
                if (e.target === this) {
                    console.log('üñ±Ô∏è Click en backdrop, cerrando modal...');
                    const modalInstance = bootstrap.Modal.getInstance(this);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            });
        }

        // Event listener delegado para botones de editar (evita problemas con elementos din√°micos)
        document.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-library-btn');
            if (editBtn) {
                e.preventDefault();
                e.stopPropagation();
                
                const objectId = editBtn.dataset.id;
                console.log('üñ±Ô∏è Click en editar objeto:', objectId);
                
                // Deshabilitar bot√≥n temporalmente
                editBtn.disabled = true;
                const originalHTML = editBtn.innerHTML;
                editBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                
                // SOLUCI√ìN RADICAL: Remover y recrear el modal completamente
                const oldModal = document.getElementById('editLibraryModal');
                const modalParent = oldModal ? oldModal.parentElement : document.body;
                
                // Destruir instancia de Bootstrap
                if (oldModal) {
                    const instance = bootstrap.Modal.getInstance(oldModal);
                    if (instance) {
                        instance.dispose();
                    }
                    oldModal.remove();
                }
                
                // Limpiar TODO
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Esperar y cargar
                setTimeout(() => {
                    editLibraryObject(objectId).finally(() => {
                        setTimeout(() => {
                            editBtn.disabled = false;
                            editBtn.innerHTML = originalHTML;
                        }, 500);
                    });
                }, 200);
            }
        });

        // Cargar estad√≠sticas del dashboard principal
        async function loadDashboardStats() {
            const token = localStorage.getItem('token');
            console.log('üìä Cargando estad√≠sticas del dashboard...');
            console.log('üîë Token:', token ? 'Presente' : 'NO HAY TOKEN');
            console.log('üåê URL:', `${API_URL}/api/uploads`);

            try {
                // Obtener todos los an√°lisis del usuario
                const response = await fetch(`${API_URL}/api/uploads`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);

                if (response.ok) {
                    const data = await response.json();
                    const analyses = data.analyses || [];
                    console.log(`‚úÖ An√°lisis obtenidos: ${analyses.length}`, data);
                    
                    // Total de an√°lisis
                    document.getElementById('totalAnalysisCount').textContent = analyses.length;
                    
                    // An√°lisis completados
                    const completed = analyses.filter(a => a.status === 'completed').length;
                    document.getElementById('completedAnalysisCount').textContent = completed;
                    
                    // An√°lisis en proceso
                    const processing = analyses.filter(a => a.status === 'analyzing' || a.status === 'uploading' || a.status === 'pending').length;
                    document.getElementById('processingAnalysisCount').textContent = processing;
                    
                    console.log(`üìà Stats actualizadas: Total=${analyses.length}, Completados=${completed}, En proceso=${processing}`);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error al cargar estad√≠sticas del dashboard:', response.status, errorText);
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
            }
        }

        // Cargar estad√≠sticas de training
        async function loadTrainingStats() {
            const token = localStorage.getItem('token');

            try {
                // Obtener estad√≠sticas completas del endpoint espec√≠fico
                const statsResponse = await fetch(`${API_URL}/api/training/stats/categories`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    
                    // Total de im√°genes
                    document.getElementById('trainingStatsTotal').textContent = statsData.total || 0;
                    
                    // Total verificadas (sumar de todas las categor√≠as)
                    const totalVerified = statsData.stats?.reduce((sum, cat) => sum + cat.verified, 0) || 0;
                    document.getElementById('trainingStatsVerified').textContent = totalVerified;
                    
                    // N√∫mero de categor√≠as √∫nicas
                    document.getElementById('trainingStatsCategories').textContent = statsData.stats?.length || 0;
                    
                    console.log('üìä Estad√≠sticas actualizadas:', {
                        total: statsData.total,
                        verified: totalVerified,
                        categories: statsData.stats?.length
                    });
                }
            } catch (error) {
                console.error('Error cargando stats:', error);
                // Fallback: obtener todas las im√°genes
                try {
                    const response = await fetch(`${API_URL}/api/training?limit=100`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('trainingStatsTotal').textContent = data.pagination?.total || 0;
                        
                        // Calcular verificadas
                        const verifiedCount = data.images?.filter(img => img.verified).length || 0;
                        document.getElementById('trainingStatsVerified').textContent = verifiedCount;
                        
                        // Obtener categor√≠as √∫nicas
                        const categories = new Set(data.images?.map(img => img.category) || []);
                        document.getElementById('trainingStatsCategories').textContent = categories.size;
                    }
                } catch (fallbackError) {
                    console.error('Error en fallback:', fallbackError);
                }
            }
        }

        // Funci√≥n auxiliar para escapar HTML y prevenir XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // ==================== FIN TRAINING DATA ====================

        // ==================== EXPORTACI√ìN PDF ====================
        
        async function downloadAnalysisPDF(analysisId) {
            const token = localStorage.getItem('token');
            if (!token) {
                showUploadAlert('Sesi√≥n expirada. Por favor inicia sesi√≥n nuevamente.', 'danger');
                return;
            }

            try {
                showUploadAlert('Generando PDF, por favor espera...', 'info');

                const response = await fetch(`${API_URL}/api/export/${analysisId}/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    throw new Error(data.error || `Error ${response.status}`);
                }

                // Get PDF blob
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `analysis_${analysisId}.pdf`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showUploadAlert('¬°PDF descargado exitosamente!', 'success');
            } catch (error) {
                console.error('Error descargando PDF:', error);
                showUploadAlert(`Error al descargar PDF: ${error.message}`, 'danger');
            }
        }

        // ==================== FIN EXPORTACI√ìN PDF ====================

        // ==================== CONFIGURACI√ìN DEL SITIO ====================
        
        // Cargar configuraciones al iniciar
        async function loadSiteConfigs() {
            try {
                const response = await fetch(`${API_URL}/api/siteconfig`);
                if (response.ok) {
                    const configs = await response.json();
                    
                    // Actualizar inputs y botones de donaci√≥n
                    if (configs.donation_url) {
                        document.getElementById('donationUrlInput').value = configs.donation_url;
                        document.getElementById('previewDonateLink').href = configs.donation_url;
                        // Actualizar bot√≥n de donar en la secci√≥n de donaciones
                        const donateButton = document.getElementById('donateButton');
                        if (donateButton) {
                            donateButton.href = configs.donation_url;
                        }
                    }
                    if (configs.website_url) {
                        document.getElementById('websiteUrlInput').value = configs.website_url;
                        document.getElementById('previewWebsiteLink').href = configs.website_url;
                        // Actualizar enlace en sidebar
                        const websiteLink = document.getElementById('websiteLink');
                        if (websiteLink) {
                            websiteLink.href = configs.website_url;
                        }
                    }
                }
            } catch (error) {
                console.error('Error cargando configuraciones:', error);
            }
        }

        // Actualizar configuraci√≥n
        async function updateConfig(key) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Debes iniciar sesi√≥n');
                return;
            }

            let value, msgElement;
            if (key === 'donation_url') {
                value = document.getElementById('donationUrlInput').value.trim();
                msgElement = document.getElementById('donationUrlMsg');
            } else if (key === 'website_url') {
                value = document.getElementById('websiteUrlInput').value.trim();
                msgElement = document.getElementById('websiteUrlMsg');
            }

            if (!value) {
                msgElement.innerHTML = '<div class="alert alert-danger small">La URL no puede estar vac√≠a</div>';
                return;
            }

            // Validar URL
            try {
                new URL(value);
            } catch (e) {
                msgElement.innerHTML = '<div class="alert alert-danger small">URL inv√°lida. Debe comenzar con http:// o https://</div>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/siteconfig/${key}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        value,
                        description: key === 'donation_url' ? 'URL para donaciones' : 'URL del sitio web principal'
                    })
                });

                if (response.ok) {
                    msgElement.innerHTML = '<div class="alert alert-success small"><i class="bi bi-check-circle"></i> Configuraci√≥n guardada exitosamente</div>';
                    
                    // Actualizar preview y enlaces reales
                    if (key === 'donation_url') {
                        document.getElementById('previewDonateLink').href = value;
                        const donateButton = document.getElementById('donateButton');
                        if (donateButton) {
                            donateButton.href = value;
                        }
                    } else if (key === 'website_url') {
                        document.getElementById('previewWebsiteLink').href = value;
                        const websiteLink = document.getElementById('websiteLink');
                        if (websiteLink) {
                            websiteLink.href = value;
                        }
                    }

                    // Limpiar mensaje despu√©s de 3 segundos
                    setTimeout(() => {
                        msgElement.innerHTML = '';
                    }, 3000);
                } else {
                    const data = await response.json();
                    msgElement.innerHTML = `<div class="alert alert-danger small">${data.error || 'Error al guardar'}</div>`;
                }
            } catch (error) {
                console.error('Error actualizando configuraci√≥n:', error);
                msgElement.innerHTML = '<div class="alert alert-danger small">Error de conexi√≥n</div>';
            }
        }

        // Inicializar configuraciones por defecto
        async function initializeConfigs() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Debes iniciar sesi√≥n');
                return;
            }

            if (!confirm('¬øInicializar configuraciones con valores por defecto? Esto no sobreescribir√° las configuraciones existentes.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/siteconfig/init`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ ${data.message}\nConfigs creadas: ${data.created}`);
                    loadSiteConfigs(); // Recargar
                } else {
                    const data = await response.json();
                    alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error inicializando configs:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // ==================== FIN CONFIGURACI√ìN ====================

        // Inicializar
        initializeWebSocket(); // Conectar WebSocket
        checkAuth();
        loadNotificationCount();
        loadSiteConfigs(); // Cargar configuraciones del sitio
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
