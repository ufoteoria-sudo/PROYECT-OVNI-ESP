<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Usuarios registrados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8fafc; }
    .card { margin-top: 2rem; }
    .table td, .table th { vertical-align: middle; }
    .small-msg { font-size: .9rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mt-4 text-primary">Usuarios registrados</h1>

    <div class="card p-3">
      <h5>Crear nuevo usuario</h5>
      <form id="formCrearUsuario" class="row g-2 align-items-center">
        <div class="col-sm-4">
          <input type="text" id="nuevoUsername" class="form-control" placeholder="Usuario" required>
        </div>
        <div class="col-sm-4">
          <input type="email" id="nuevoEmail" class="form-control" placeholder="Email" required>
        </div>
        <div class="col-sm-4 d-flex gap-2">
          <button class="btn btn-success" type="submit">Crear</button>
          <div id="crearUsuarioMsg" class="small-msg align-self-center"></div>
        </div>
      </form>
    </div>

    <div class="card p-3 mt-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Usuarios en la base de datos</h5>
        <input id="buscar" class="form-control form-control-sm w-25" placeholder="Buscar por usuario o email">
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Email</th>
              <th style="width:170px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaUsuarios"></tbody>
        </table>
      </div>
      <div id="usuariosMsg" class="small-msg text-danger"></div>
    </div>
  </div>

  <!-- Modal editar -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="formEditarUsuario">
        <div class="modal-header">
          <h5 class="modal-title">Editar usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editarId">
          <div class="mb-3">
            <label class="form-label">Usuario</label>
            <input type="text" id="editarUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="editarEmail" class="form-control" required>
          </div>
          <div id="editarMsg" class="small-msg text-danger"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'http://localhost:3000/api/users';

    // Util: validar email
    function validarEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Cargar usuarios
    async function cargarUsuarios() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const users = await res.json();
        const tbody = document.getElementById('tablaUsuarios');
        tbody.innerHTML = '';
        const filtro = document.getElementById('buscar').value.toLowerCase();
        const lista = Array.isArray(users) ? users : (users.users || []);
        const filtrados = lista.filter(u => {
          if (!filtro) return true;
          return (u.username || '').toLowerCase().includes(filtro) || (u.email || '').toLowerCase().includes(filtro);
        });
        if (!filtrados.length) {
          tbody.innerHTML = '<tr><td colspan="4">No hay usuarios registrados.</td></tr>';
        } else {
          filtrados.forEach(u => {
            tbody.insertAdjacentHTML('beforeend', `
              <tr>
                <td style="max-width:230px;overflow:hidden;text-overflow:ellipsis">${u._id}</td>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td>
                  <button class="btn btn-sm btn-warning me-2" onclick="mostrarEditar('${u._id}', '${escapeHtml(u.username)}', '${escapeHtml(u.email)}')">Editar</button>
                  <button class="btn btn-sm btn-danger" onclick="borrarUsuario('${u._id}')">Borrar</button>
                </td>
              </tr>
            `);
          });
        }
        document.getElementById('usuariosMsg').textContent = '';
      } catch (err) {
        document.getElementById('tablaUsuarios').innerHTML = '<tr><td colspan="4">Error al cargar usuarios.</td></tr>';
        document.getElementById('usuariosMsg').textContent = 'Error al cargar usuarios: ' + err.message;
      }
    }

    // Escape simple para evitar romper el HTML en atributos
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // Crear usuario
    document.getElementById('formCrearUsuario').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('nuevoUsername').value.trim();
      const email = document.getElementById('nuevoEmail').value.trim();
      const msgEl = document.getElementById('crearUsuarioMsg');
      msgEl.className = '';
      if (!username || !email) { msgEl.textContent = 'Usuario y email son obligatorios.'; msgEl.className = 'text-danger'; return; }
      if (!validarEmail(email)) { msgEl.textContent = 'Formato de email no válido.'; msgEl.className = 'text-danger'; return; }
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email })
        });
        if (res.status === 409) {
          msgEl.textContent = 'El email ya está registrado.'; msgEl.className = 'text-danger'; return;
        }
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          msgEl.textContent = 'Error al crear usuario: ' + (data.error || res.statusText);
          msgEl.className = 'text-danger';
          return;
        }
        msgEl.textContent = 'Usuario creado correctamente.'; msgEl.className = 'text-success';
        document.getElementById('formCrearUsuario').reset();
        cargarUsuarios();
      } catch (err) {
        msgEl.textContent = 'Error al crear usuario: ' + err.message; msgEl.className = 'text-danger';
      }
      setTimeout(() => { msgEl.textContent = ''; msgEl.className = ''; }, 3000);
    });

    // Borrar usuario
    async function borrarUsuario(id) {
      if (!confirm('¿Seguro que deseas borrar este usuario?')) return;
      try {
        const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert('Error al borrar usuario: ' + (data.error || res.statusText));
          return;
        }
        cargarUsuarios();
      } catch (err) {
        alert('Error al borrar usuario: ' + err.message);
      }
    }

    // Mostrar modal de edición
    function mostrarEditar(id, username, email) {
      // username/email vienen escapados; invertir escape para mostrarlos en inputs
      document.getElementById('editarId').value = id;
      document.getElementById('editarUsername').value = unescapeHtml(username);
      document.getElementById('editarEmail').value = unescapeHtml(email);
      document.getElementById('editarMsg').textContent = '';
      const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
      modal.show();
    }

    function unescapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,'<').replace(/&gt;/g,'>');
    }

    // Editar usuario
    document.getElementById('formEditarUsuario').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editarId').value;
      const username = document.getElementById('editarUsername').value.trim();
      const email = document.getElementById('editarEmail').value.trim();
      const msgEl = document.getElementById('editarMsg');
      msgEl.textContent = '';
      if (!username || !email) { msgEl.textContent = 'Usuario y email son obligatorios.'; return; }
      if (!validarEmail(email)) { msgEl.textContent = 'Formato de email no válido.'; return; }
      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email })
        });
        if (res.status === 409) {
          msgEl.textContent = 'El email ya está registrado.'; return;
        }
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          msgEl.textContent = 'Error al editar usuario: ' + (data.error || res.statusText);
          return;
        }
        bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
        cargarUsuarios();
      } catch (err) {
        msgEl.textContent = 'Error al editar usuario: ' + err.message;
      }
    });

    // Buscador en tiempo real
    document.getElementById('buscar').addEventListener('input', () => cargarUsuarios());

    // Inicializar
    window.addEventListener('DOMContentLoaded', cargarUsuarios);
  </script>
</body>
</html>
